<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Sala Romántica — Polaroid Automático</title>
  <style>
    :root {
      --rose-1: #ff8ab5;
      --rose-2: #ffd1e0;
      --lavender: #e0c7ff;
      --glass: rgba(255, 255, 255, 0.15);
      --glow-btn: linear-gradient(180deg, #ff66b2, #ff99cc, #ffe6f0);
      --bg-gradient: radial-gradient(circle at 50% 20%, rgba(255, 150, 180, 0.3), transparent 50%, rgba(30, 15, 50, 0.95));
    }
    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg-gradient), #1a0a2a;
      overflow: hidden;
      font-family: 'Segoe UI', Roboto, Arial, sans-serif;
      color: var(--rose-2);
    }
    #polaroid-container {
      width: 100vw;
      height: 100vh;
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #polaroid-stack {
      position: relative;
      width: clamp(280px, 80vw, 400px);
      height: clamp(400px, 70vh, 500px);
    }
    .polaroid {
      position: absolute;
      width: 100%;
      height: 100%;
      background: #fff;
      padding: 12px;
      border-radius: 10px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4), 0 0 20px rgba(255, 120, 180, 0.3);
      transform: translateY(100vh) scale(0.8) rotate(5deg);
      opacity: 0;
      transition: transform 1s ease-in-out, opacity 1s ease-in-out;
      cursor: pointer;
    }
    .polaroid img {
      width: 100%;
      height: calc(100% - 40px);
      object-fit: cover;
      border-radius: 6px;
      display: block;
    }
    .polaroid .caption {
      text-align: center;
      font-size: clamp(12px, 3vw, 14px);
      color: #2a0a20;
      margin-top: 8px;
      font-weight: 500;
    }
    .polaroid.active {
      transform: translateY(0) scale(1) rotate(0deg);
      opacity: 1;
      z-index: 10;
    }
    .polaroid.exiting {
      transform: translateY(-100vh) scale(0.8) rotate(-5deg);
      opacity: 0;
      z-index: 5;
    }
    #next-label {
      position: absolute;
      bottom: 60px;
      left: 50%;
      transform: translateX(-50%);
      color: var(--rose-2);
      font-size: clamp(12px, 3vw, 14px);
      text-shadow: 0 0 8px rgba(255, 120, 180, 0.6);
      z-index: 15;
      padding: 8px 16px;
      border-radius: 999px;
      background: var(--glass);
      backdrop-filter: blur(4px);
      animation: pulse 2s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: translateX(-50%) scale(1); opacity: 0.9; }
      50% { transform: translateX(-50%) scale(1.05); opacity: 1; }
    }
    #overlay {
      position: absolute;
      left: 10px;
      top: 10px;
      z-index: 80;
      padding: 10px;
      border-radius: 12px;
      background: var(--glass);
      backdrop-filter: blur(6px);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      max-width: 90%;
    }
    #overlay h3 {
      margin: 0 0 6px 0;
      font-size: clamp(14px, 3.5vw, 16px);
      color: var(--rose-2);
      text-shadow: 0 0 5px rgba(255, 150, 180, 0.6);
    }
    #overlay p {
      margin: 0;
      font-size: clamp(11px, 3vw, 12px);
      color: rgba(255, 230, 240, 0.9);
    }
    .controls {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    .btn-ghost {
      position: relative;
      overflow: hidden;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border-radius: 10px;
      border: 0;
      cursor: pointer;
      font-weight: 600;
      font-size: clamp(11px, 3vw, 12px);
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      background: var(--glow-btn);
      color: #2a0a20;
      box-shadow: 0 0 20px rgba(255, 100, 150, 0.5), inset 0 0 10px rgba(255, 100, 150, 0.3);
      animation: glow 1.5s ease-in-out infinite;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .btn-ghost:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 30px rgba(255, 100, 150, 0.6);
    }
    .btn-ghost:active {
      transform: translateY(0);
    }
    @keyframes glow {
      0%, 100% { box-shadow: 0 0 20px rgba(255, 100, 150, 0.5), inset 0 0 10px rgba(255, 100, 150, 0.3); }
      50% { box-shadow: 0 0 30px rgba(255, 100, 150, 0.7), inset 0 0 15px rgba(255, 100, 150, 0.4); }
    }
    .btn-ghost:focus {
      outline: 2px solid rgba(255, 120, 180, 0.25);
      outline-offset: 2px;
    }
    .ripple {
      position: absolute;
      border-radius: 999px;
      transform: scale(0);
      animation: rip 0.5s ease-out;
      pointer-events: none;
      background: rgba(255, 230, 240, 0.3);
    }
    @keyframes rip {
      to { transform: scale(2.5); opacity: 0; }
    }
    #credits {
      position: absolute;
      right: 10px;
      bottom: 10px;
      color: var(--rose-2);
      font-size: clamp(9px, 2.5vw, 10px);
      z-index: 5;
      padding: 6px;
      border-radius: 8px;
      background: var(--glass);
      backdrop-filter: blur(4px);
    }
    #hint {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: 80px;
      color: var(--rose-2);
      z-index: 15;
      font-size: clamp(9px, 2.5vw, 10px);
      padding: 6px 12px;
      border-radius: 999px;
      background: var(--glass);
      backdrop-filter: blur(4px);
      display: none;
    }
    #previewModal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: linear-gradient(180deg, rgba(30, 15, 50, 0.7), rgba(20, 10, 30, 0.9));
      z-index: 120;
    }
    #previewContent {
      max-width: 95vw;
      max-height: 90vh;
      padding: 12px;
      border-radius: 12px;
      background: var(--glass);
      display: flex;
      flex-direction: column;
      gap: 10px;
      backdrop-filter: blur(6px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }
    #previewContent img {
      max-width: 100%;
      max-height: 80vh;
      border-radius: 10px;
      display: block;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
      object-fit: contain;
    }
    #previewClose {
      align-self: flex-end;
      padding: 8px 12px;
      border-radius: 10px;
      border: 0;
      background: var(--glow-btn);
      color: #2a0a20;
      cursor: pointer;
      font-size: clamp(11px, 3vw, 12px);
      box-shadow: 0 0 20px rgba(255, 100, 150, 0.5);
    }
    #romOverlay {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 30;
      background: radial-gradient(50% 50% at 50% 40%, rgba(255, 150, 180, 0.15), transparent 50%), linear-gradient(180deg, rgba(255, 240, 245, 0.06), transparent 70%);
    }
    #errorMessage {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: clamp(0.7rem, 3vw, 0.9rem);
      text-align: center;
      color: var(--rose-1);
      text-shadow: 0 0 8px var(--rose-1);
      z-index: 130;
      display: none;
      padding: clamp(6px, 1.5vw, 8px);
      max-width: 95vw;
      background: rgba(20, 10, 30, 0.8);
      border-radius: 10px;
      backdrop-filter: blur(4px);
    }
    #loadingBarContainer {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: clamp(100px, 60vw, 150px);
      height: 6px;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 4px;
      overflow: hidden;
      z-index: 140;
    }
    #loadingBar {
      height: 100%;
      width: 0;
      background: linear-gradient(90deg, var(--rose-1), var(--rose-2));
      transition: width 0.3s ease;
    }
    #loadingText {
      position: absolute;
      top: calc(50% + 20px);
      left: 50%;
      transform: translate(-50%, 0);
      color: var(--rose-1);
      font-size: clamp(0.7rem, 2.8vw, 0.9rem);
      text-shadow: 0 0 6px var(--rose-1);
    }
    #heart-particles {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 20;
    }
    .heart-particle {
      position: absolute;
      width: 20px;
      height: 20px;
      background: radial-gradient(circle, rgba(255, 140, 180, 0.95), transparent 70%);
      clip-path: path('M10,6 C12,2 16,6 10,12 C4,6 8,2 10,6 Z');
      animation: float 5s linear infinite;
      opacity: 0;
    }
    @keyframes float {
      0% { opacity: 0; transform: translateY(0) scale(0.5) rotate(0deg); }
      10% { opacity: 0.9; }
      90% { opacity: 0.9; }
      100% { opacity: 0; transform: translateY(-100vh) scale(1) rotate(180deg); }
    }
    @media (max-width: 720px) {
      #polaroid-container {
        height: 80vh;
      }
      #polaroid-stack {
        width: clamp(200px, 70vw, 320px);
        height: clamp(300px, 60vh, 400px);
      }
      #overlay {
        left: 8px;
        top: 8px;
        padding: 8px;
        width: calc(100% - 16px);
        box-sizing: border-box;
      }
      .btn-ghost {
        padding: 7px 12px;
        font-size: clamp(10px, 2.8vw, 11px);
      }
      #overlay h3 {
        font-size: clamp(12px, 3.2vw, 14px);
      }
      #overlay p {
        font-size: clamp(10px, 2.8vw, 11px);
      }
      #hint {
        display: block;
        font-size: clamp(9px, 2.5vw, 10px);
        padding: 5px 10px;
      }
      #errorMessage {
        font-size: clamp(0.6rem, 2.8vw, 0.8rem);
        padding: clamp(5px, 1.5vw, 7px);
        max-width: 98vw;
      }
      #loadingBarContainer {
        width: clamp(80px, 50vw, 120px);
        height: 5px;
      }
      #loadingText {
        font-size: clamp(0.6rem, 2.5vw, 0.8rem);
      }
      .heart-particle {
        width: 16px;
        height: 16px;
      }
      #next-label {
        bottom: 70px;
        font-size: clamp(11px, 2.8vw, 12px);
      }
    }
    @media (min-resolution: 2dppx) {
      .polaroid img {
        image-rendering: optimizeQuality;
      }
    }
  </style>
</head>
<body>
  <div id="errorMessage">No creaste tu proyecto. Por favor, crea tu ID primero.</div>
  <div id="loadingBarContainer">
    <div id="loadingBar"></div>
    <div id="loadingText">Cargando...</div>
  </div>
  <div id="polaroid-container">
    <div id="polaroid-stack"></div>
    <div id="next-label">Ver la siguiente puerta</div>
  </div>
  <div id="romOverlay"></div>
  <div id="heart-particles"></div>
  <div id="overlay" role="region" aria-label="Controles">
    <h3>Sala Romántica — Polaroid Automático</h3>
    <p>Toca una foto para ampliarla. Ciclo automático.</p>
    <div class="controls">
      <button id="returnBtn" class="btn-ghost">Regresar</button>
    </div>
  </div>
  <div id="credits">Diseño romántico • Imágenes de ejemplo: picsum.photos</div>
  <div id="hint">Toca para ampliar</div>
  <div id="previewModal" aria-hidden="true">
    <div id="previewContent">
      <button id="previewClose">Cerrar</button>
      <img id="previewImage" src="" alt="Vista previa">
    </div>
  </div>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
    import { getDatabase, ref, get } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';
    const firebaseConfig = {
      apiKey: "AIzaSyBk2SVaP1w4V3MWrpp1r3X5Xk9eH06gBt4",
      authDomain: "tunel-de-recuerdos.firebaseapp.com",
      projectId: "tunel-de-recuerdos",
      storageBucket: "tunel-de-recuerdos.firebasestorage.app",
      messagingSenderId: "630660710506",
      appId: "1:630660710506:web:90d34150c9f21f668eca13",
      measurementId: "G-ETFDVEHML1"
    };
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    let imageUrls = [];
    async function fetchImages() {
      const errorMessage = document.getElementById('errorMessage');
      const urlParams = new URLSearchParams(window.location.search);
      const userId = urlParams.get('id')?.trim();
      if (!userId || userId === '') {
        errorMessage.textContent = 'No creaste tu proyecto. Por favor, crea tu ID primero.';
        errorMessage.style.display = 'block';
        document.getElementById('loadingBarContainer').style.display = 'none';
        return [];
      }
      try {
        const snapshot = await get(ref(database, `usuarios/${userId}`));
        if (snapshot.exists()) {
          const data = snapshot.val();
          let allFotos = [];
          for (let i = 1; i <= 5; i++) {
            const fotos = data[`puerta${i}Fotos`] || [];
            allFotos = allFotos.concat(fotos.filter(url => typeof url === 'string' && url.trim() !== ''));
          }
          let validFotos = allFotos.slice(0, 7);
          if (validFotos.length === 0) {
            errorMessage.textContent = 'No hay imágenes en tu galería. Agrega al menos 1 imagen.';
            errorMessage.style.display = 'block';
            document.getElementById('loadingBarContainer').style.display = 'none';
            return [];
          }
          while (validFotos.length < 7) {
            validFotos = validFotos.concat(validFotos.slice(0, Math.min(validFotos.length, 7 - validFotos.length)));
          }
          return validFotos.slice(0, 7);
        } else {
          errorMessage.textContent = 'No creaste tu proyecto. Por favor, crea tu ID primero.';
          errorMessage.style.display = 'block';
          document.getElementById('loadingBarContainer').style.display = 'none';
          return [];
        }
      } catch (error) {
        errorMessage.textContent = 'Error al cargar las imágenes. Por favor, intenta de nuevo.';
        errorMessage.style.display = 'block';
        document.getElementById('loadingBarContainer').style.display = 'none';
        return [];
      }
    }
    (async function() {
      const loadingBarContainer = document.getElementById('loadingBarContainer');
      const loadingBar = document.getElementById('loadingBar');
      const loadingText = document.getElementById('loadingText');
      loadingBarContainer.style.display = 'block';
      loadingText.textContent = 'Cargando...';
      imageUrls = await fetchImages();
      const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent) || window.innerWidth < 720;
      const TOTAL_IMAGES = 7;
      const polaroidStack = document.getElementById('polaroid-stack');
      const heartParticles = document.getElementById('heart-particles');
      let currentIndex = 0;
      let loadedImages = 0;
      const totalImages = Math.min(imageUrls.length, 7);
      function updateLoadingProgress() {
        loadedImages++;
        const progress = (loadedImages / totalImages) * 100;
        loadingBar.style.width = `${progress}%`;
        if (loadedImages >= totalImages) {
          setTimeout(() => {
            loadingBarContainer.style.opacity = '0';
            setTimeout(() => {
              loadingBarContainer.style.display = 'none';
              document.getElementById('overlay').style.display = 'block';
              document.getElementById('credits').style.display = 'block';
              document.getElementById('hint').style.display = 'block';
            }, 300);
          }, 500);
        }
      }
      if (totalImages === 0) {
        loadingBarContainer.style.display = 'none';
      } else {
        imageUrls.forEach(url => {
          const img = new Image();
          img.src = url;
          img.onload = updateLoadingProgress;
          img.onerror = () => {
            console.warn(`Error al cargar imagen: ${url}`);
            updateLoadingProgress();
          };
        });
      }
      function createPolaroid(url, idx) {
        const polaroid = document.createElement('div');
        polaroid.className = 'polaroid';
        polaroid.dataset.index = idx;
        const img = document.createElement('img');
        img.src = url;
        img.alt = `Recuerdo ${idx + 1}`;
        img.loading = 'lazy';
        const caption = document.createElement('div');
        caption.className = 'caption';
        caption.textContent = `Recuerdo ${idx + 1}`;
        polaroid.appendChild(img);
        polaroid.appendChild(caption);
        polaroidStack.appendChild(polaroid);
      }
      function updatePolaroid() {
        const polaroids = polaroidStack.querySelectorAll('.polaroid');
        polaroids.forEach((polaroid, idx) => {
          const dist = (idx - currentIndex + TOTAL_IMAGES) % TOTAL_IMAGES;
          if (dist < 0.5 || dist > TOTAL_IMAGES - 0.5) {
            polaroid.classList.add('active');
            polaroid.classList.remove('exiting');
          } else {
            polaroid.classList.remove('active');
            polaroid.classList.add('exiting');
          }
        });
      }
      if (imageUrls.length > 0) {
        for (let i = 0; i < TOTAL_IMAGES; i++) {
          createPolaroid(imageUrls[i % imageUrls.length], i);
        }
        updatePolaroid();
      }
      function spawnHeartParticle() {
        const particle = document.createElement('div');
        particle.className = 'heart-particle';
        const x = Math.random() * window.innerWidth;
        particle.style.left = `${x}px`;
        particle.style.animationDelay = `${Math.random() * 1}s`;
        heartParticles.appendChild(particle);
        setTimeout(() => particle.remove(), 5000);
      }
      setInterval(spawnHeartParticle, isMobile ? 400 : 200);
      polaroidStack.addEventListener('click', (e) => {
        const target = e.target.closest('.polaroid.active');
        if (target) {
          const url = target.querySelector('img').src;
          openPreview(url);
          spawnHeartParticle();
        }
      });
      const previewModal = document.getElementById('previewModal');
      const previewImage = document.getElementById('previewImage');
      const previewClose = document.getElementById('previewClose');
      function openPreview(url) {
        previewImage.src = url;
        previewModal.style.display = 'flex';
        previewModal.setAttribute('aria-hidden', 'false');
      }
      function closePreview() {
        previewModal.style.display = 'none';
        previewImage.src = '';
        previewModal.setAttribute('aria-hidden', 'true');
      }
      previewClose.addEventListener('click', closePreview);
      previewModal.addEventListener('click', (e) => {
        if (e.target === previewModal) closePreview();
      });
      function createRipple(button, clientX, clientY) {
        const rect = button.getBoundingClientRect();
        const x = clientX - rect.left;
        const y = clientY - rect.top;
        const r = Math.max(rect.width, rect.height);
        const el = document.createElement('span');
        el.className = 'ripple';
        el.style.width = el.style.height = (r * 1.5) + 'px';
        el.style.left = (x - r * 0.75) + 'px';
        el.style.top = (y - r * 0.75) + 'px';
        button.appendChild(el);
        setTimeout(() => { el.remove(); }, 600);
      }
      document.getElementById('returnBtn').addEventListener('click', (e) => {
        createRipple(e.currentTarget, e.clientX, e.clientY);
        window.parent.postMessage({ type: 'doorClosed' }, '*');
      });
      window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closePreview();
      });
      function animate() {
        requestAnimationFrame(animate);
        const now = Date.now();
        const cycleTime = 4000; // 4 seconds per image
        const progress = (now % (TOTAL_IMAGES * cycleTime)) / cycleTime;
        currentIndex = Math.floor(progress) % TOTAL_IMAGES;
        updatePolaroid();
      }
      if (imageUrls.length > 0) {
        animate();
      }
      window.addEventListener('resize', () => {
        updatePolaroid();
      });
      window._romanticScene = { updatePolaroid };
    })();
  </script>
</body>
</html>
