<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Galería Romántica — 7 Fotos</title>
  <style>
    :root {
      --rose-1: #ff8ab5;
      --rose-2: #ffd1e0;
      --lavender: #d8b4fe;
      --glass: rgba(255, 255, 255, 0.1);
      --btn-bg: linear-gradient(135deg, #ff99cc, #ffe6f0);
      --bg-gradient: radial-gradient(circle at 50% 30%, rgba(255, 150, 180, 0.2), rgba(216, 180, 254, 0.15), #1a0a20);
    }
    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg-gradient);
      overflow: hidden;
      font-family: 'Georgia', 'Times New Roman', serif;
      color: #ffe6f0;
    }
    #gallery-container {
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      touch-action: pan-x;
    }
    .carousel {
      position: relative;
      width: 100%;
      max-width: 800px;
      height: 70vh;
      perspective: 1000px;
      overflow: hidden;
    }
    .carousel-inner {
      position: absolute;
      width: 100%;
      height: 100%;
      transform-style: preserve-3d;
      transition: transform 0.5s ease;
    }
    .photo-frame {
      position: absolute;
      width: 200px;
      height: 250px;
      background: var(--glass);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
      transform: rotateY(0deg) translateZ(400px);
      clip-path: path('M100,20 C120,0 180,0 200,20 C220,40 220,100 200,120 C180,140 120,140 100,120 C80,100 80,40 100,20 Z');
      transition: transform 0.5s ease, opacity 0.5s ease;
    }
    .photo-frame img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      filter: brightness(0.95) contrast(1.1) drop-shadow(0 0 10px rgba(255, 150, 180, 0.3));
    }
    #overlay {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
      padding: 12px;
      border-radius: 12px;
      background: var(--glass);
      backdrop-filter: blur(8px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      text-align: center;
    }
    #overlay h3 {
      margin: 0 0 8px 0;
      font-size: clamp(16px, 4vw, 18px);
      color: var(--rose-2);
      text-shadow: 0 0 5px rgba(255, 150, 180, 0.5);
    }
    #overlay p {
      margin: 0;
      font-size: clamp(12px, 3.2vw, 13px);
      color: rgba(255, 230, 240, 0.9);
    }
    .controls {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      justify-content: center;
    }
    .btn {
      padding: 8px 16px;
      border-radius: 10px;
      border: 0;
      background: var(--btn-bg);
      color: #2a0a20;
      cursor: pointer;
      font-size: clamp(12px, 3.2vw, 13px);
      font-weight: 600;
      box-shadow: 0 4px 15px rgba(255, 120, 180, 0.2);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 120, 180, 0.3);
    }
    .btn:active {
      transform: translateY(0);
    }
    .ripple {
      position: absolute;
      border-radius: 999px;
      transform: scale(0);
      animation: ripple 0.5s ease-out;
      pointer-events: none;
      background: rgba(255, 230, 240, 0.3);
    }
    @keyframes ripple {
      to { transform: scale(2.5); opacity: 0; }
    }
    #previewModal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, rgba(50, 30, 60, 0.7), rgba(20, 10, 30, 0.9));
      z-index: 20;
    }
    #previewContent {
      max-width: 90vw;
      max-height: 85vh;
      padding: 15px;
      border-radius: 15px;
      background: var(--glass);
      backdrop-filter: blur(8px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    #previewContent img {
      max-width: 100%;
      max-height: 80vh;
      border-radius: 12px;
      object-fit: contain;
      filter: drop-shadow(0 0 15px rgba(255, 150, 180, 0.4));
    }
    #previewClose {
      align-self: flex-end;
      padding: 8px 14px;
      border-radius: 10px;
      border: 0;
      background: var(--btn-bg);
      color: #2a0a20;
      cursor: pointer;
      font-size: clamp(12px, 3.2vw, 13px);
    }
    #errorMessage {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: clamp(0.8rem, 3.5vw, 1rem);
      text-align: center;
      color: var(--rose-1);
      text-shadow: 0 0 8px var(--rose-1);
      z-index: 30;
      display: none;
      padding: clamp(8px, 2vw, 10px);
      max-width: 95vw;
      background: rgba(20, 10, 30, 0.8);
      border-radius: 12px;
      backdrop-filter: blur(8px);
    }
    #loadingBarContainer {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: clamp(120px, 60vw, 180px);
      height: 8px;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 4px;
      overflow: hidden;
      z-index: 40;
    }
    #loadingBar {
      height: 100%;
      width: 0;
      background: linear-gradient(90deg, var(--rose-1), var(--lavender));
      transition: width 0.4s ease;
    }
    #loadingText {
      position: absolute;
      top: calc(50% + 20px);
      left: 50%;
      transform: translate(-50%, 0);
      color: var(--rose-1);
      font-size: clamp(0.8rem, 3vw, 1rem);
      text-shadow: 0 0 6px var(--rose-1);
    }
    .hearts-bg {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 5;
    }
    .heart-particle {
      position: absolute;
      width: 20px;
      height: 20px;
      background: radial-gradient(circle, rgba(255, 150, 180, 0.5), transparent);
      clip-path: path('M10,3 C12,1 15,1 17,3 C19,5 19,8 17,10 C15,12 12,12 10,10 C8,8 8,5 10,3 Z');
      animation: float 10s infinite ease-in-out;
      opacity: 0.6;
    }
    @keyframes float {
      0% { transform: translateY(100vh) scale(0.8); opacity: 0.3; }
      50% { opacity: 0.6; }
      100% { transform: translateY(-20vh) scale(1.2); opacity: 0; }
    }
    @media (max-width: 720px) {
      .carousel {
        height: 60vh;
      }
      .photo-frame {
        width: 160px;
        height: 200px;
        transform: rotateY(0deg) translateZ(300px);
      }
      #overlay {
        padding: 10px;
        max-width: 95%;
      }
      #overlay h3 {
        font-size: clamp(14px, 3.8vw, 16px);
      }
      #overlay p {
        font-size: clamp(11px, 3vw, 12px);
      }
      .btn {
        padding: 7px 12px;
        font-size: clamp(11px, 3vw, 12px);
      }
      #errorMessage {
        font-size: clamp(0.7rem, 3vw, 0.9rem);
        padding: clamp(6px, 1.8vw, 8px);
      }
      #loadingBarContainer {
        width: clamp(100px, 50vw, 140px);
        height: 6px;
      }
      #loadingText {
        font-size: clamp(0.7rem, 2.8vw, 0.9rem);
      }
    }
  </style>
</head>
<body>
  <div id="errorMessage">No creaste tu proyecto. Por favor, crea tu ID primero.</div>
  <div id="loadingBarContainer">
    <div id="loadingBar"></div>
    <div id="loadingText">Cargando...</div>
  </div>
  <div id="gallery-container">
    <div class="carousel">
      <div class="carousel-inner"></div>
    </div>
  </div>
  <div class="hearts-bg"></div>
  <div id="overlay" role="region" aria-label="Controles">
    <h3>Galería Romántica</h3>
    <p>Desliza para explorar. Toca una foto para ampliarla.</p>
    <div class="controls">
      <button id="prevBtn" class="btn">Anterior</button>
      <button id="nextBtn" class="btn">Siguiente</button>
      <button id="returnBtn" class="btn">Regresar</button>
    </div>
  </div>
  <div id="previewModal" aria-hidden="true">
    <div id="previewContent">
      <button id="previewClose">Cerrar</button>
      <img id="previewImage" src="" alt="Vista previa">
    </div>
  </div>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBk2SVaP1w4V3MWrpp1r3X5Xk9eH06gBt4",
      authDomain: "tunel-de-recuerdos.firebaseapp.com",
      projectId: "tunel-de-recuerdos",
      storageBucket: "tunel-de-recuerdos.firebasestorage.app",
      messagingSenderId: "630660710506",
      appId: "1:630660710506:web:90d34150c9f21f668eca13",
      measurementId: "G-ETFDVEHML1"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    let imageUrls = [];
    async function fetchImages() {
      const errorMessage = document.getElementById('errorMessage');
      const urlParams = new URLSearchParams(window.location.search);
      const userId = urlParams.get('id')?.trim();
      if (!userId || userId === '') {
        errorMessage.textContent = 'No creaste tu proyecto. Por favor, crea tu ID primero.';
        errorMessage.style.display = 'block';
        document.getElementById('loadingBarContainer').style.display = 'none';
        return [];
      }
      try {
        const snapshot = await database.ref(`usuarios/${userId}`).once('value');
        if (snapshot.exists()) {
          const data = snapshot.val();
          let allFotos = [];
          for (let i = 1; i <= 5; i++) {
            const fotos = data[`puerta${i}Fotos`] || [];
            allFotos = allFotos.concat(fotos.filter(url => typeof url === 'string' && url.trim() !== ''));
          }
          let validFotos = allFotos.slice(0, 7);
          if (validFotos.length === 0) {
            errorMessage.textContent = 'No hay imágenes en tu galería. Agrega al menos 1 imagen.';
            errorMessage.style.display = 'block';
            document.getElementById('loadingBarContainer').style.display = 'none';
            return [];
          }
          while (validFotos.length < 7) {
            validFotos = validFotos.concat(validFotos.slice(0, Math.min(validFotos.length, 7 - validFotos.length)));
          }
          return validFotos.slice(0, 7);
        } else {
          errorMessage.textContent = 'No creaste tu proyecto. Por favor, crea tu ID primero.';
          errorMessage.style.display = 'block';
          document.getElementById('loadingBarContainer').style.display = 'none';
          return [];
        }
      } catch (error) {
        errorMessage.textContent = 'Error al cargar las imágenes. Por favor, intenta de nuevo.';
        errorMessage.style.display = 'block';
        document.getElementById('loadingBarContainer').style.display = 'none';
        return [];
      }
    }
    (async function() {
      const loadingBarContainer = document.getElementById('loadingBarContainer');
      const loadingBar = document.getElementById('loadingBar');
      const loadingText = document.getElementById('loadingText');
      loadingBarContainer.style.display = 'block';
      loadingText.textContent = 'Cargando...';
      imageUrls = await fetchImages();
      const totalImages = Math.min(imageUrls.length, 7);
      let loadedImages = 0;
      function updateLoadingProgress() {
        loadedImages++;
        const progress = (loadedImages / totalImages) * 100;
        loadingBar.style.width = `${progress}%`;
        if (loadedImages >= totalImages) {
          setTimeout(() => {
            loadingBarContainer.style.opacity = '0';
            setTimeout(() => {
              loadingBarContainer.style.display = 'none';
              document.getElementById('overlay').style.display = 'block';
            }, 400);
          }, 600);
        }
      }
      if (totalImages === 0) {
        loadingBarContainer.style.display = 'none';
      } else {
        imageUrls.forEach(url => {
          const img = new Image();
          img.src = url;
          img.onload = updateLoadingProgress;
          img.onerror = () => {
            console.warn(`Error al cargar imagen: ${url}`);
            updateLoadingProgress();
          };
        });
      }
      const carouselInner = document.querySelector('.carousel-inner');
      const TOTAL_IMAGES = 7;
      let currentIndex = 0;
      function setupCarousel() {
        carouselInner.innerHTML = '';
        imageUrls.slice(0, TOTAL_IMAGES).forEach((url, index) => {
          const frame = document.createElement('div');
          frame.className = 'photo-frame';
          frame.style.transform = `rotateY(${index * (360 / TOTAL_IMAGES)}deg) translateZ(${window.innerWidth < 720 ? 300 : 400}px)`;
          const img = document.createElement('img');
          img.src = url;
          img.alt = `Foto ${index + 1}`;
          frame.appendChild(img);
          carouselInner.appendChild(frame);
          frame.addEventListener('click', () => openPreview(url));
        });
        updateCarousel();
      }
      function updateCarousel() {
        const angle = currentIndex * (360 / TOTAL_IMAGES);
        carouselInner.style.transform = `rotateY(-${angle}deg)`;
        document.querySelectorAll('.photo-frame').forEach((frame, index) => {
          const frameAngle = (index - currentIndex) * (360 / TOTAL_IMAGES);
          frame.style.opacity = Math.max(0.5, 1 - Math.abs(frameAngle) / 90);
          frame.style.transform = `rotateY(${index * (360 / TOTAL_IMAGES)}deg) translateZ(${window.innerWidth < 720 ? 300 : 400}px) scale(${Math.max(0.8, 1 - Math.abs(frameAngle) / 180)})`;
        });
      }
      if (imageUrls.length > 0) setupCarousel();
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const returnBtn = document.getElementById('returnBtn');
      prevBtn.addEventListener('click', (e) => {
        createRipple(prevBtn, e.clientX, e.clientY);
        currentIndex = (currentIndex - 1 + TOTAL_IMAGES) % TOTAL_IMAGES;
        updateCarousel();
      });
      nextBtn.addEventListener('click', (e) => {
        createRipple(nextBtn, e.clientX, e.clientY);
        currentIndex = (currentIndex + 1) % TOTAL_IMAGES;
        updateCarousel();
      });
      returnBtn.addEventListener('click', (e) => {
        createRipple(returnBtn, e.clientX, e.clientY);
        window.parent.postMessage({ type: 'doorClosed' }, '*');
      });
      let touchStartX = 0;
      document.getElementById('gallery-container').addEventListener('touchstart', (e) => {
        touchStartX = e.touches[0].clientX;
      }, { passive: true });
      document.getElementById('gallery-container').addEventListener('touchmove', (e) => {
        const touchX = e.touches[0].clientX;
        const deltaX = touchX - touchStartX;
        if (Math.abs(deltaX) > 50) {
          if (deltaX > 0) {
            currentIndex = (currentIndex - 1 + TOTAL_IMAGES) % TOTAL_IMAGES;
          } else {
            currentIndex = (currentIndex + 1) % TOTAL_IMAGES;
          }
          updateCarousel();
          touchStartX = touchX;
        }
      }, { passive: true });
      const previewModal = document.getElementById('previewModal');
      const previewImage = document.getElementById('previewImage');
      const previewClose = document.getElementById('previewClose');
      function openPreview(url) {
        previewImage.src = url;
        previewModal.style.display = 'flex';
        previewModal.setAttribute('aria-hidden', 'false');
      }
      function closePreview() {
        previewModal.style.display = 'none';
        previewImage.src = '';
        previewModal.setAttribute('aria-hidden', 'true');
      }
      previewClose.addEventListener('click', closePreview);
      previewModal.addEventListener('click', (e) => {
        if (e.target === previewModal) closePreview();
      });
      window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closePreview();
        else if (e.key === 'ArrowLeft') {
          currentIndex = (currentIndex - 1 + TOTAL_IMAGES) % TOTAL_IMAGES;
          updateCarousel();
        } else if (e.key === 'ArrowRight') {
          currentIndex = (currentIndex + 1) % TOTAL_IMAGES;
          updateCarousel();
        }
      });
      function createRipple(button, clientX, clientY) {
        const rect = button.getBoundingClientRect();
        const x = clientX - rect.left;
        const y = clientY - rect.top;
        const r = Math.max(rect.width, rect.height);
        const el = document.createElement('span');
        el.className = 'ripple';
        el.style.width = el.style.height = (r * 1.5) + 'px';
        el.style.left = (x - r * 0.75) + 'px';
        el.style.top = (y - r * 0.75) + 'px';
        button.appendChild(el);
        setTimeout(() => { el.remove(); }, 600);
      }
      function createHearts() {
        const heartsBg = document.querySelector('.hearts-bg');
        for (let i = 0; i < (window.innerWidth < 720 ? 5 : 10); i++) {
          const heart = document.createElement('div');
          heart.className = 'heart-particle';
          heart.style.left = `${Math.random() * 100}vw`;
          heart.style.animationDelay = `${Math.random() * 8}s`;
          heartsBg.appendChild(heart);
        }
      }
      createHearts();
      function onResize() {
        setupCarousel();
        document.querySelector('.hearts-bg').innerHTML = '';
        createHearts();
      }
      window.addEventListener('resize', onResize);
    })();
  </script>
</body>
</html>
