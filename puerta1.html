<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Sala Romántica — Carrusel 2D</title>
  <style>
    :root {
      --rose-1: #ff8ab5;
      --rose-2: #ffd1e0;
      --lavender: #e0c7ff;
      --glass: rgba(255, 255, 255, 0.15);
      --btn-bg: linear-gradient(180deg, #ff99cc, #ffe6f0);
      --bg-gradient: radial-gradient(circle at 50% 20%, rgba(255, 150, 180, 0.25), transparent 50%, rgba(30, 15, 50, 0.95));
    }
    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg-gradient), #1a0a2a;
      overflow: hidden;
      font-family: 'Segoe UI', Roboto, Arial, sans-serif;
      color: var(--rose-2);
    }
    #carousel-container {
      width: 100vw;
      height: 100vh;
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      touch-action: pan-x;
    }
    #carousel {
      display: flex;
      transition: transform 0.5s ease;
      height: 100%;
      align-items: center;
    }
    .carousel-item {
      flex: 0 0 auto;
      width: clamp(200px, 60vw, 300px);
      height: clamp(150px, 40vh, 200px);
      margin: 0 10px;
      position: relative;
      cursor: pointer;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }
    .carousel-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      display: block;
    }
    .carousel-item .frame {
      position: absolute;
      inset: -2px;
      border: 2px solid #2a0a20;
      border-radius: 14px;
      box-shadow: 0 0 15px rgba(255, 120, 180, 0.3);
      pointer-events: none;
    }
    .carousel-item .glow {
      position: absolute;
      inset: -10px;
      background: radial-gradient(circle, rgba(255, 120, 180, 0.15), transparent 60%);
      pointer-events: none;
    }
    .carousel-item.active {
      transform: scale(1.1);
      z-index: 10;
    }
    .carousel-item:not(.active) {
      opacity: 0.7;
      transform: scale(0.9);
    }
    #overlay {
      position: absolute;
      left: 10px;
      top: 10px;
      z-index: 80;
      padding: 10px;
      border-radius: 12px;
      background: var(--glass);
      backdrop-filter: blur(6px);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      max-width: 90%;
    }
    #overlay h3 {
      margin: 0 0 6px 0;
      font-size: clamp(14px, 3.5vw, 16px);
      color: var(--rose-2);
      text-shadow: 0 0 5px rgba(255, 150, 180, 0.6);
    }
    #overlay p {
      margin: 0;
      font-size: clamp(11px, 3vw, 12px);
      color: rgba(255, 230, 240, 0.9);
    }
    .controls {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    .btn, .btn-ghost {
      position: relative;
      overflow: hidden;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border-radius: 10px;
      border: 0;
      cursor: pointer;
      font-weight: 600;
      font-size: clamp(11px, 3vw, 12px);
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .btn {
      background: var(--btn-bg);
      color: #2a0a20;
      box-shadow: 0 4px 15px rgba(255, 120, 180, 0.25);
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(255, 120, 180, 0.35);
    }
    .btn:active {
      transform: translateY(0);
    }
    .btn-ghost {
      background: transparent;
      border: 1px solid rgba(255, 230, 240, 0.2);
      color: var(--rose-2);
      padding: 7px 12px;
    }
    .btn-ghost:hover {
      background: rgba(255, 230, 240, 0.08);
      transform: translateY(-2px);
    }
    .btn:focus {
      outline: 2px solid rgba(255, 120, 180, 0.25);
      outline-offset: 2px;
    }
    .ripple {
      position: absolute;
      border-radius: 999px;
      transform: scale(0);
      animation: rip 0.5s ease-out;
      pointer-events: none;
      background: rgba(255, 230, 240, 0.25);
    }
    @keyframes rip {
      to { transform: scale(2.5); opacity: 0; }
    }
    #credits {
      position: absolute;
      right: 10px;
      bottom: 10px;
      color: var(--rose-2);
      font-size: clamp(9px, 2.5vw, 10px);
      z-index: 5;
      padding: 6px;
      border-radius: 8px;
      background: var(--glass);
      backdrop-filter: blur(4px);
    }
    #hint {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: 15px;
      color: var(--rose-2);
      z-index: 5;
      font-size: clamp(9px, 2.5vw, 10px);
      padding: 6px 12px;
      border-radius: 999px;
      background: var(--glass);
      backdrop-filter: blur(4px);
      display: none;
    }
    #previewModal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: linear-gradient(180deg, rgba(30, 15, 50, 0.7), rgba(20, 10, 30, 0.9));
      z-index: 120;
    }
    #previewContent {
      max-width: 95vw;
      max-height: 90vh;
      padding: 12px;
      border-radius: 12px;
      background: var(--glass);
      display: flex;
      flex-direction: column;
      gap: 10px;
      backdrop-filter: blur(6px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }
    #previewContent img {
      max-width: 100%;
      max-height: 80vh;
      border-radius: 10px;
      display: block;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
      object-fit: contain;
    }
    #previewClose {
      align-self: flex-end;
      padding: 8px 12px;
      border-radius: 10px;
      border: 0;
      background: var(--btn-bg);
      color: #2a0a20;
      cursor: pointer;
      font-size: clamp(11px, 3vw, 12px);
    }
    #romOverlay {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 30;
      background: radial-gradient(50% 50% at 50% 40%, rgba(255, 150, 180, 0.12), transparent 50%), linear-gradient(180deg, rgba(255, 240, 245, 0.05), transparent 70%);
    }
    #errorMessage {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: clamp(0.7rem, 3vw, 0.9rem);
      text-align: center;
      color: var(--rose-1);
      text-shadow: 0 0 8px var(--rose-1);
      z-index: 130;
      display: none;
      padding: clamp(6px, 1.5vw, 8px);
      max-width: 95vw;
      background: rgba(20, 10, 30, 0.8);
      border-radius: 10px;
      backdrop-filter: blur(4px);
    }
    #loadingBarContainer {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: clamp(100px, 60vw, 150px);
      height: 6px;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 4px;
      overflow: hidden;
      z-index: 140;
    }
    #loadingBar {
      height: 100%;
      width: 0;
      background: linear-gradient(90deg, var(--rose-1), var(--rose-2));
      transition: width 0.3s ease;
    }
    #loadingText {
      position: absolute;
      top: calc(50% + 20px);
      left: 50%;
      transform: translate(-50%, 0);
      color: var(--rose-1);
      font-size: clamp(0.7rem, 2.8vw, 0.9rem);
      text-shadow: 0 0 6px var(--rose-1);
    }
    #heart-particles {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 20;
    }
    .heart-particle {
      position: absolute;
      width: 20px;
      height: 20px;
      background: radial-gradient(circle, rgba(255, 140, 180, 0.9), transparent 70%);
      clip-path: path('M10,6 C12,2 16,6 10,12 C4,6 8,2 10,6 Z');
      animation: float 8s linear infinite;
      opacity: 0;
    }
    @keyframes float {
      0% { opacity: 0; transform: translateY(0) scale(0.5); }
      10% { opacity: 0.8; }
      90% { opacity: 0.8; }
      100% { opacity: 0; transform: translateY(-100vh) scale(1); }
    }
    @media (max-width: 720px) {
      #carousel-container {
        height: 80vh;
      }
      .carousel-item {
        width: clamp(160px, 50vw, 240px);
        height: clamp(120px, 30vh, 160px);
        margin: 0 8px;
      }
      #overlay {
        left: 8px;
        top: 8px;
        padding: 8px;
        width: calc(100% - 16px);
        box-sizing: border-box;
      }
      .btn, .btn-ghost {
        padding: 7px 12px;
        font-size: clamp(10px, 2.8vw, 11px);
      }
      .controls {
        gap: 6px;
        flex-direction: column;
        align-items: flex-start;
      }
      #overlay h3 {
        font-size: clamp(12px, 3.2vw, 14px);
      }
      #overlay p {
        font-size: clamp(10px, 2.8vw, 11px);
      }
      #hint {
        display: block;
        font-size: clamp(9px, 2.5vw, 10px);
        padding: 5px 10px;
      }
      #errorMessage {
        font-size: clamp(0.6rem, 2.8vw, 0.8rem);
        padding: clamp(5px, 1.5vw, 7px);
        max-width: 98vw;
      }
      #loadingBarContainer {
        width: clamp(80px, 50vw, 120px);
        height: 5px;
      }
      #loadingText {
        font-size: clamp(0.6rem, 2.5vw, 0.8rem);
      }
      .heart-particle {
        width: 15px;
        height: 15px;
      }
    }
    @media (min-resolution: 2dppx) {
      .carousel-item img {
        image-rendering: optimizeQuality;
      }
    }
  </style>
</head>
<body>
  <div id="errorMessage">No creaste tu proyecto. Por favor, crea tu ID primero.</div>
  <div id="loadingBarContainer">
    <div id="loadingBar"></div>
    <div id="loadingText">Cargando...</div>
  </div>
  <div id="carousel-container">
    <div id="carousel"></div>
  </div>
  <div id="romOverlay"></div>
  <div id="heart-particles"></div>
  <div id="overlay" role="region" aria-label="Controles">
    <h3>Sala Romántica — Carrusel 2D</h3>
    <p>Desliza para navegar. Toca una foto para ampliarla.</p>
    <div class="controls">
      <button id="prevBtn" class="btn">Anterior</button>
      <button id="nextBtn" class="btn">Siguiente</button>
      <button id="toggleAuto" class="btn" aria-pressed="false">Auto-deslizar</button>
      <button id="returnBtn" class="btn-ghost">Regresar</button>
    </div>
  </div>
  <div id="credits">Diseño romántico • Imágenes de ejemplo: picsum.photos</div>
  <div id="hint">Desliza para navegar • Toca para ampliar</div>
  <div id="previewModal" aria-hidden="true">
    <div id="previewContent">
      <button id="previewClose">Cerrar</button>
      <img id="previewImage" src="" alt="Vista previa">
    </div>
  </div>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
    import { getDatabase, ref, get } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';
    const firebaseConfig = {
      apiKey: "AIzaSyBk2SVaP1w4V3MWrpp1r3X5Xk9eH06gBt4",
      authDomain: "tunel-de-recuerdos.firebaseapp.com",
      projectId: "tunel-de-recuerdos",
      storageBucket: "tunel-de-recuerdos.firebasestorage.app",
      messagingSenderId: "630660710506",
      appId: "1:630660710506:web:90d34150c9f21f668eca13",
      measurementId: "G-ETFDVEHML1"
    };
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    let imageUrls = [];
    async function fetchImages() {
      const errorMessage = document.getElementById('errorMessage');
      const urlParams = new URLSearchParams(window.location.search);
      const userId = urlParams.get('id')?.trim();
      if (!userId || userId === '') {
        errorMessage.textContent = 'No creaste tu proyecto. Por favor, crea tu ID primero.';
        errorMessage.style.display = 'block';
        document.getElementById('loadingBarContainer').style.display = 'none';
        return [];
      }
      try {
        const snapshot = await get(ref(database, `usuarios/${userId}`));
        if (snapshot.exists()) {
          const data = snapshot.val();
          let allFotos = [];
          for (let i = 1; i <= 5; i++) {
            const fotos = data[`puerta${i}Fotos`] || [];
            allFotos = allFotos.concat(fotos.filter(url => typeof url === 'string' && url.trim() !== ''));
          }
          let validFotos = allFotos.slice(0, 7);
          if (validFotos.length === 0) {
            errorMessage.textContent = 'No hay imágenes en tu galería. Agrega al menos 1 imagen.';
            errorMessage.style.display = 'block';
            document.getElementById('loadingBarContainer').style.display = 'none';
            return [];
          }
          while (validFotos.length < 7) {
            validFotos = validFotos.concat(validFotos.slice(0, Math.min(validFotos.length, 7 - validFotos.length)));
          }
          return validFotos.slice(0, 7);
        } else {
          errorMessage.textContent = 'No creaste tu proyecto. Por favor, crea tu ID primero.';
          errorMessage.style.display = 'block';
          document.getElementById('loadingBarContainer').style.display = 'none';
          return [];
        }
      } catch (error) {
        errorMessage.textContent = 'Error al cargar las imágenes. Por favor, intenta de nuevo.';
        errorMessage.style.display = 'block';
        document.getElementById('loadingBarContainer').style.display = 'none';
        return [];
      }
    }
    (async function() {
      const loadingBarContainer = document.getElementById('loadingBarContainer');
      const loadingBar = document.getElementById('loadingBar');
      const loadingText = document.getElementById('loadingText');
      loadingBarContainer.style.display = 'block';
      loadingText.textContent = 'Cargando...';
      imageUrls = await fetchImages();
      const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent) || window.innerWidth < 720;
      const TOTAL_IMAGES = 7;
      const ITEM_WIDTH = isMobile ? 180 : 320;
      const carousel = document.getElementById('carousel');
      const heartParticles = document.getElementById('heart-particles');
      let currentIndex = 0;
      let targetIndex = 0;
      let autoSlide = false;
      let loadedImages = 0;
      const totalImages = Math.min(imageUrls.length, 7);
      function updateLoadingProgress() {
        loadedImages++;
        const progress = (loadedImages / totalImages) * 100;
        loadingBar.style.width = `${progress}%`;
        if (loadedImages >= totalImages) {
          setTimeout(() => {
            loadingBarContainer.style.opacity = '0';
            setTimeout(() => {
              loadingBarContainer.style.display = 'none';
              document.getElementById('overlay').style.display = 'block';
              document.getElementById('credits').style.display = 'block';
              document.getElementById('hint').style.display = 'block';
            }, 300);
          }, 500);
        }
      }
      if (totalImages === 0) {
        loadingBarContainer.style.display = 'none';
      } else {
        imageUrls.forEach(url => {
          const img = new Image();
          img.src = url;
          img.onload = updateLoadingProgress;
          img.onerror = () => {
            console.warn(`Error al cargar imagen: ${url}`);
            updateLoadingProgress();
          };
        });
      }
      function createCarouselItem(url, idx) {
        const item = document.createElement('div');
        item.className = 'carousel-item';
        item.dataset.index = idx;
        const img = document.createElement('img');
        img.src = url;
        img.alt = `Foto ${idx + 1}`;
        img.loading = 'lazy';
        const frame = document.createElement('div');
        frame.className = 'frame';
        const glow = document.createElement('div');
        glow.className = 'glow';
        item.appendChild(glow);
        item.appendChild(img);
        item.appendChild(frame);
        carousel.appendChild(item);
      }
      function updateCarousel() {
        const offset = -targetIndex * (ITEM_WIDTH + 20);
        carousel.style.transform = `translateX(${offset}px)`;
        const items = carousel.querySelectorAll('.carousel-item');
        items.forEach((item, idx) => {
          const dist = Math.abs(idx - targetIndex);
          item.classList.toggle('active', dist < 0.5);
        });
      }
      if (imageUrls.length > 0) {
        for (let i = 0; i < TOTAL_IMAGES; i++) {
          createCarouselItem(imageUrls[i % imageUrls.length], i);
        }
        updateCarousel();
      }
      function spawnHeartParticle() {
        const particle = document.createElement('div');
        particle.className = 'heart-particle';
        const x = Math.random() * window.innerWidth;
        particle.style.left = `${x}px`;
        particle.style.animationDelay = `${Math.random() * 2}s`;
        heartParticles.appendChild(particle);
        setTimeout(() => particle.remove(), 8000);
      }
      setInterval(spawnHeartParticle, isMobile ? 800 : 400);
      let isDragging = false, startX = 0, startIndex = 0;
      function onPointerDown(e) {
        isDragging = true;
        startX = getClientX(e);
        startIndex = targetIndex;
        carousel.style.transition = 'none';
      }
      function onPointerMove(e) {
        if (!isDragging) return;
        const x = getClientX(e);
        const dx = (x - startX) / ITEM_WIDTH;
        targetIndex = startIndex - dx;
        updateCarousel();
      }
      function onPointerUp() {
        if (!isDragging) return;
        isDragging = false;
        targetIndex = Math.round(targetIndex);
        carousel.style.transition = 'transform 0.5s ease';
        updateCarousel();
      }
      function getClientX(e) {
        if (e.touches && e.touches.length) return e.touches[0].clientX;
        if (e.changedTouches && e.changedTouches.length) return e.changedTouches[0].clientX;
        return e.clientX;
      }
      carousel.addEventListener('pointerdown', onPointerDown, { passive: true });
      carousel.addEventListener('pointermove', onPointerMove, { passive: true });
      window.addEventListener('pointerup', onPointerUp, { passive: true });
      let pinchStartDist = 0, pinchStartScale = 1;
      function getTouchDist(e) {
        if (!e.touches || e.touches.length < 2) return 0;
        const dx = e.touches[0].clientX - e.touches[1].clientX;
        const dy = e.touches[0].clientY - e.touches[1].clientY;
        return Math.sqrt(dx * dx + dy * dy);
      }
      carousel.addEventListener('touchstart', (e) => {
        if (e.touches.length === 2) {
          pinchStartDist = getTouchDist(e);
          pinchStartScale = parseFloat(getComputedStyle(carousel.querySelector('.carousel-item.active')).transform.split(',')[0].split('(')[1] || 1);
        }
      }, { passive: true });
      carousel.addEventListener('touchmove', (e) => {
        if (e.touches.length === 2) {
          const dist = getTouchDist(e);
          if (pinchStartDist > 0) {
            const scale = pinchStartScale * (dist / pinchStartDist);
            const items = carousel.querySelectorAll('.carousel-item');
            items.forEach(item => {
              item.style.transform = `scale(${Math.min(Math.max(scale, 0.8), 1.3)})`;
            });
          }
        }
      }, { passive: true });
      carousel.addEventListener('click', (e) => {
        const target = e.target.closest('.carousel-item');
        if (target) {
          const url = target.querySelector('img').src;
          openPreview(url);
          spawnHeartParticle();
        }
      });
      const previewModal = document.getElementById('previewModal');
      const previewImage = document.getElementById('previewImage');
      const previewClose = document.getElementById('previewClose');
      function openPreview(url) {
        previewImage.src = url;
        previewModal.style.display = 'flex';
        previewModal.setAttribute('aria-hidden', 'false');
      }
      function closePreview() {
        previewModal.style.display = 'none';
        previewImage.src = '';
        previewModal.setAttribute('aria-hidden', 'true');
      }
      previewClose.addEventListener('click', closePreview);
      previewModal.addEventListener('click', (e) => {
        if (e.target === previewModal) closePreview();
      });
      function createRipple(button, clientX, clientY) {
        const rect = button.getBoundingClientRect();
        const x = clientX - rect.left;
        const y = clientY - rect.top;
        const r = Math.max(rect.width, rect.height);
        const el = document.createElement('span');
        el.className = 'ripple';
        el.style.width = el.style.height = (r * 1.5) + 'px';
        el.style.left = (x - r * 0.75) + 'px';
        el.style.top = (y - r * 0.75) + 'px';
        button.appendChild(el);
        setTimeout(() => { el.remove(); }, 600);
      }
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const toggleBtn = document.getElementById('toggleAuto');
      prevBtn.addEventListener('click', (e) => {
        createRipple(prevBtn, e.clientX, e.clientY);
        targetIndex += 1;
        carousel.style.transition = 'transform 0.5s ease';
        updateCarousel();
      });
      nextBtn.addEventListener('click', (e) => {
        createRipple(nextBtn, e.clientX, e.clientY);
        targetIndex -= 1;
        carousel.style.transition = 'transform 0.5s ease';
        updateCarousel();
      });
      function toggleAutoSlide() {
        autoSlide = !autoSlide;
        toggleBtn.textContent = autoSlide ? 'Detener' : 'Auto-deslizar';
        toggleBtn.setAttribute('aria-pressed', String(autoSlide));
      }
      toggleBtn.addEventListener('click', (e) => {
        createRipple(toggleBtn, e.clientX, e.clientY);
        toggleAutoSlide();
      });
      document.getElementById('returnBtn').addEventListener('click', (e) => {
        createRipple(e.currentTarget, e.clientX, e.clientY);
        window.parent.postMessage({ type: 'doorClosed' }, '*');
      });
      window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closePreview();
      });
      function animate() {
        requestAnimationFrame(animate);
        if (autoSlide) {
          targetIndex -= 0.02;
          carousel.style.transition = 'transform 0.5s ease';
          updateCarousel();
        }
      }
      animate();
      window.addEventListener('resize', () => {
        updateCarousel();
      });
      window._romanticScene = { updateCarousel, toggleAutoSlide };
    })();
  </script>
</body>
</html>
