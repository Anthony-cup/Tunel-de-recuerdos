<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Sala Romántica — Polaroid (Jardín de Luces · Animación fluida)</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
  <style>
    :root{ --rose-1:#ff7fbf; --rose-2:#ffdfe9; --card-w:clamp(220px,62vw,360px); --card-h:clamp(320px,58vh,420px); }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:radial-gradient(900px 460px at 14% 16%, rgba(255,120,170,0.06), transparent 8%),linear-gradient(180deg,#050006,#0b0210 65%);font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:var(--rose-2);overflow:hidden}

    /* fireworks canvas behind everything */
    #fireworksCanvas{position:fixed;inset:0;width:100%;height:100%;z-index:0;pointer-events:none}

    /* ambience & sparkles layer */
    #ambience{position:fixed;inset:0;z-index:1;pointer-events:none}

    /* main stage */
    #stage{position:relative;z-index:5;height:100vh;width:100vw;display:flex;align-items:center;justify-content:center;padding:24px}

    /* ring container */
    #ring-container{position:relative;width:min(88vw,1100px);height:min(78vh,800px);display:block}
    #center-spot{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:44%;height:44%;border-radius:50%;background:radial-gradient(circle at 40% 30%, rgba(255,200,230,0.06), transparent 30%);filter:blur(18px);z-index:10;pointer-events:none}

    /* ring slots and polaroids */
    .ring-slot{position:absolute;left:50%;top:50%;transform-origin:center center;width:var(--card-w);height:var(--card-h);display:flex;align-items:center;justify-content:center;will-change:left,top,transform;transition:left 700ms cubic-bezier(.22,.9,.35,1), top 700ms cubic-bezier(.22,.9,.35,1), transform 700ms cubic-bezier(.22,.9,.35,1), opacity 500ms}
    .polaroid{width:100%;height:100%;background:linear-gradient(180deg,#fff,#fff);padding:12px;border-radius:14px;box-shadow:0 10px 40px rgba(0,0,0,0.45),0 0 40px rgba(255,100,160,0.06);overflow:hidden;display:flex;flex-direction:column;transition:transform 600ms cubic-bezier(.22,.9,.35,1),filter 500ms ease,opacity 450ms ease}
    .polaroid img{width:100%;height:calc(100% - 56px);object-fit:cover;border-radius:10px;display:block}
    .polaroid .caption{height:46px;text-align:center;margin-top:10px;font-family:'Playfair Display',serif;color:#27020b;font-weight:700}

    /* new gentle crossfade + float for active transitions */
    .ring-slot .polaroid {opacity:0.95;}
    .ring-slot .polaroid.img-fade { transition: opacity 700ms cubic-bezier(.22,.9,.35,1), transform 700ms cubic-bezier(.22,.9,.35,1); }
    .polaroid.active{transform:scale(1.06) translateY(-6px);box-shadow:0 40px 120px rgba(255,120,180,0.18),0 0 80px rgba(255,140,190,0.06);filter:brightness(1.02);opacity:1}
    .polaroid.dim{filter:blur(0.8px) saturate(.92) brightness(.95);opacity:0.86}

    /* smooth small parallax when pointer moves */
    .polaroid { transform-origin:center center; }
    .polaroid .inner { width:100%;height:100%;display:flex;flex-direction:column }

    /* subtle glow animation on active */
    @keyframes softGlow{0%{box-shadow:0 30px 80px rgba(255,120,180,0.06)}50%{box-shadow:0 40px 100px rgba(255,120,180,0.12)}100%{box-shadow:0 30px 80px rgba(255,120,180,0.06)}}
    .polaroid.active { animation: softGlow 3.5s ease-in-out infinite; }

    /* center card */
    .center-card{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(48vw,520px);height:min(62vh,560px);z-index:30;border-radius:16px;padding:14px;background:linear-gradient(180deg,#fff,#fff);box-shadow:0 30px 90px rgba(0,0,0,0.6),0 0 120px rgba(255,110,160,0.12);display:flex;flex-direction:column;align-items:center;justify-content:flex-start;opacity:0;pointer-events:none;transition:opacity 300ms ease,transform 300ms ease}
    .center-card.visible{opacity:1;pointer-events:auto;transform:translate(-50%,-50%) scale(1)}
    .center-card img{width:100%;height:calc(100% - 56px);object-fit:cover;border-radius:12px}
    .center-card .caption{height:56px;text-align:center;margin-top:10px;font-family:'Playfair Display',serif;color:#27020b;font-weight:800}

    /* particles (petals) style */
    .petal{position:absolute;width:18px;height:18px;border-radius:50%;background:radial-gradient(circle at 30% 30%, #fff, #ffd1e8);pointer-events:none;transform:translateY(0);opacity:0}

    /* controls: only pause and regresar (no title/text) */
    #controls{position:fixed;left:12px;top:12px;z-index:60;padding:8px;border-radius:12px;background:rgba(255,255,255,0.04);backdrop-filter:blur(6px);box-shadow:0 6px 24px rgba(0,0,0,0.5);display:flex;gap:8px}
    .btn{padding:8px 12px;border-radius:10px;border:0;background:linear-gradient(180deg,var(--rose-1),#ffb6d9);color:#2a0520;font-weight:700;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--rose-2)}

    @media (max-width:720px){ .center-card{width:86vw;height:62vh} :root{--card-w:70vw;--card-h:54vh} }

    /* preview modal fallback */
    #previewModal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(6,2,8,0.85),rgba(6,2,8,0.95));z-index:120;padding:20px}
    #previewModal img{max-width:95vw;max-height:90vh;border-radius:12px}

    /* loading */
    #loading{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:200;color:var(--rose-1);font-weight:700}
  </style>
</head>
<body>
  <canvas id="fireworksCanvas" aria-hidden="true"></canvas>
  <div id="ambience" aria-hidden="true"></div>
  <div id="stage">
    <div id="ring-container" aria-live="polite">
      <div id="center-spot"></div>
      <div id="ring-slots"></div>
      <div id="centerCard" class="center-card" role="dialog" aria-hidden="true">
        <img id="centerImg" src="" alt="Recuerdo grande">
        <div class="caption" id="centerCaption">Toca una foto para verla</div>
      </div>
    </div>
  </div>

  <div id="controls">
    <button id="autoplayBtn" class="btn">Pausa</button>
    <button id="returnBtn" class="btn ghost">Regresar</button>
  </div>

  <div id="loading">Cargando...</div>
  <div id="previewModal" aria-hidden="true">
    <img id="previewBig" src="" alt="Vista previa grande">
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
    import { getDatabase, ref, get } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBk2SVaP1w4V3MWrpp1r3X5Xk9eH06gBt4",
      authDomain: "tunel-de-recuerdos.firebaseapp.com",
      projectId: "tunel-de-recuerdos",
      storageBucket: "tunel-de-recuerdos.firebasestorage.app",
      messagingSenderId: "630660710506",
      appId: "1:630660710506:web:90d34150c9f21f668eca13",
      measurementId: "G-ETFDVEHML1"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    const TOTAL = 7;
    const ring = document.getElementById('ring-slots');
    const centerCard = document.getElementById('centerCard');
    const centerImg = document.getElementById('centerImg');
    const centerCaption = document.getElementById('centerCaption');
    const loading = document.getElementById('loading');
    const autoplayBtn = document.getElementById('autoplayBtn');
    const returnBtn = document.getElementById('returnBtn');
    const previewModal = document.getElementById('previewModal');
    const previewBig = document.getElementById('previewBig');

    let imageUrls = [];
    let current = 0;
    let autoplay = true;
    let autoTimer = null;
    let rotation = 0;
    let fireworksOn = true;

    async function fetchImages(){
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id')?.trim();
      if (!id){ loading.textContent = 'Falta ?id=TU_ID en la URL'; return []; }
      try{
        const snap = await get(ref(database, `usuarios/${id}`));
        if (!snap.exists()){ loading.textContent = 'ID no encontrado.'; return []; }
        const data = snap.val();
        let all = [];
        for(let i=1;i<=5;i++){ const fotos = data[`puerta${i}Fotos`] || []; all = all.concat(fotos.filter(u=>typeof u==='string' && u.trim())); }
        let valid = all.slice(0,TOTAL);
        if (valid.length===0){ loading.textContent='No hay imágenes.'; return []; }
        while(valid.length<TOTAL) valid = valid.concat(valid.slice(0,Math.min(valid.length,TOTAL-valid.length)));
        return valid.slice(0,TOTAL);
      }catch(e){ console.error(e); loading.textContent='Error al cargar imágenes.'; return []; }
    }

    function createSlot(url, i){
      const slot = document.createElement('div'); slot.className='ring-slot'; slot.dataset.idx = i;
      // add gentle transition delay for staggered fluid motion
      slot.style.transitionDelay = `${(i % TOTAL) * 45}ms`;

      const card = document.createElement('div'); card.className='polaroid img-fade';
      const inner = document.createElement('div'); inner.className='inner';
      const img = document.createElement('img'); img.src = url; img.alt = `Recuerdo ${i+1}`; img.loading='lazy';
      const cap = document.createElement('div'); cap.className='caption'; cap.textContent = `Recuerdo ${i+1}`;
      inner.appendChild(img); inner.appendChild(cap);
      card.appendChild(inner);
      slot.appendChild(card);
      ring.appendChild(slot);

      // pointer parallax for more fluid interactivity
      card.addEventListener('pointermove', (ev)=>{
        if (!card.classList.contains('active')) return;
        const r = card.getBoundingClientRect();
        const dx = (ev.clientX - (r.left + r.width/2)) / (r.width/2);
        const dy = (ev.clientY - (r.top + r.height/2)) / (r.height/2);
        card.style.transform = `scale(1.06) translateY(-6px) rotateX(${ -dy * 4 }deg) rotateY(${ dx * 6 }deg)`;
      });
      card.addEventListener('pointerleave', ()=>{ if (card.classList.contains('active')) card.style.transform='scale(1.06) translateY(-6px)'; });

      // click behaviour
      card.addEventListener('click', ()=>{ focus(i); openPreview(url); spawnPetalBurstAtSlot(slot); triggerLocalizedFirework(slot); });
      img.addEventListener('error', ()=>{ img.src='https://picsum.photos/600/800?blur=10'; });
    }

    function buildRing(){ ring.innerHTML = '';
      for(let i=0;i<TOTAL;i++) createSlot(imageUrls[i % imageUrls.length], i);
      positionSlots();
      showCenter(current);
    }

    function positionSlots(){
      const slots = Array.from(ring.children);
      const w = ring.clientWidth; const h = ring.clientHeight;
      const cx = w/2; const cy = h/2;
      const radius = Math.min(w,h) * 0.36;
      slots.forEach((slot, idx)=>{
        const angle = ( (idx - current) / TOTAL ) * Math.PI * 2 + rotation;
        const x = cx + Math.cos(angle) * radius;
        const y = cy + Math.sin(angle) * (radius * 0.78);
        // animate position & transform smoothly via CSS transitions
        slot.style.left = x + 'px'; slot.style.top = y + 'px';
        const t = angle * 12;
        const scale = idx===current ? 1.06 : 0.86 + (1 - (Math.abs((idx-current+TOTAL)%TOTAL) / TOTAL) * 0.18);
        slot.style.transform = `translate(-50%,-50%) rotate(${t}deg) scale(${scale})`;
        slot.style.zIndex = (idx===current?120:30 + ((idx - current + TOTAL) % TOTAL));
        const card = slot.querySelector('.polaroid');
        if (idx===current){ card.classList.add('active'); card.classList.remove('dim'); } else { card.classList.remove('active'); card.classList.add('dim'); card.style.transform = '';
        }
      });
    }

    function showCenter(i){ const url = imageUrls[i % imageUrls.length]; centerImg.src = url; centerCaption.textContent = `Recuerdo ${i+1}`; centerCard.classList.add('visible'); centerCard.setAttribute('aria-hidden','false'); }

    function focus(i){ current = (i+TOTAL) % TOTAL; positionSlots(); showCenter(current); resetAutoplay(); }

    function next(){ current = (current + 1) % TOTAL; positionSlots(); showCenter(current); spawnPetalBurstAroundRing(); }
    function prev(){ current = (current - 1 + TOTAL) % TOTAL; positionSlots(); showCenter(current); spawnPetalBurstAroundRing(); }

    // autoplay loop (gentle rotation)
    function startAutoplay(){ if (autoTimer) clearInterval(autoTimer); autoTimer = setInterval(()=>{ rotation += 0.06; next(); }, 3400); autoplayBtn.textContent='Pausa'; }
    function stopAutoplay(){ if (autoTimer) clearInterval(autoTimer); autoTimer = null; autoplayBtn.textContent='Reanudar'; }
    function resetAutoplay(){ if (autoplay){ stopAutoplay(); startAutoplay(); } }

    autoplayBtn.addEventListener('click', ()=>{ autoplay = !autoplay; if (autoplay) startAutoplay(); else stopAutoplay(); });
    returnBtn.addEventListener('click', ()=>{ window.parent.postMessage({type:'doorClosed'}, '*'); });

    // preview
    function openPreview(url){ previewBig.src = url; previewModal.style.display = 'flex'; previewModal.setAttribute('aria-hidden', 'false'); }
    previewModal.addEventListener('click', ()=>{ previewModal.style.display='none'; previewBig.src=''; previewModal.setAttribute('aria-hidden','true'); });

    // petal bursts (CSS DOM particles)
    function spawnPetal(x,y){ const p = document.createElement('div'); p.className='petal'; p.style.left = x + 'px'; p.style.top = y + 'px'; p.style.opacity = '1'; p.style.transform = `translateY(0) rotate(${Math.random()*360}deg)`;
      document.body.appendChild(p);
      const dx = (Math.random()-0.5)*200; const dy = - (100 + Math.random()*250);
      p.animate([{transform:`translate(0,0) rotate(0deg)`,opacity:1},{transform:`translate(${dx}px,${dy}px) rotate(${Math.random()*720}deg)`,opacity:0}],{duration:2400 + Math.random()*1400,easing:'cubic-bezier(.2,.9,.25,1)'});
      setTimeout(()=>p.remove(),3600);
    }
    function spawnPetalBurstAtSlot(slot){ const rc = slot.getBoundingClientRect(); const cx = rc.left + rc.width/2; const cy = rc.top + rc.height/2; for(let i=0;i<10;i++){ setTimeout(()=>spawnPetal(cx + (Math.random()-0.5)*40, cy + (Math.random()-0.5)*40), i*40); } }
    function spawnPetalBurstAroundRing(){ const slots = Array.from(ring.children); slots.forEach((slot, i)=>{ if (Math.random() < 0.45) spawnPetalBurstAtSlot(slot); }); }

    // ---- fireworks canvas (romantic hearts) ----
    const canvas = document.getElementById('fireworksCanvas'); const ctx = canvas.getContext('2d'); let cw=0,ch=0; function resize(){ cw = canvas.width = innerWidth; ch = canvas.height = innerHeight; } window.addEventListener('resize', resize); resize();

    const fireworks = [];
    function launchFireworkAt(x,y,scale=1){ const hue = Math.random()*30 + 320; const petals = Math.floor(8*scale) + Math.floor(Math.random()*6); const fw = {x,y,hue,particles:[],life:0,petals,scale}; fireworks.push(fw); }
    function launchRandomFirework(){ const x = Math.random()*cw*0.8 + cw*0.1; const y = Math.random()*ch*0.35 + ch*0.05; launchFireworkAt(x,y, 0.9 + Math.random()*0.6); }

    function createParticles(fw){ const count = fw.petals * 8; for(let i=0;i<count;i++){ const angle = Math.random()*Math.PI*2; const speed = (Math.random()*4+1) * (0.7 + fw.scale*0.6); const vx = Math.cos(angle)*speed; const vy = Math.sin(angle)*speed; fw.particles.push({x:fw.x,y:fw.y,vx,vy,life:0,ttl:50 + Math.random()*60, hue:fw.hue, size:4 + Math.random()*5}); } }

    function drawHeart(x,y,size,clr,alpha=1){ ctx.save(); ctx.translate(x,y); ctx.scale(size/12,size/12);
      ctx.beginPath(); ctx.moveTo(0,0);
      ctx.bezierCurveTo(6,-10,20,-6,20,4);
      ctx.bezierCurveTo(20,16,10,26,0,34);
      ctx.bezierCurveTo(-10,26,-20,16,-20,4);
      ctx.bezierCurveTo(-20,-6,-6,-10,0,0);
      ctx.closePath(); ctx.globalAlpha = alpha; ctx.fillStyle = clr; ctx.fill(); ctx.restore(); }

    function updateFireworks(){ ctx.clearRect(0,0,cw,ch);
      if (fireworksOn && Math.random() < 0.04) launchRandomFirework();
      for(let i=fireworks.length-1;i>=0;i--){ const fw = fireworks[i]; fw.life++;
        if (fw.life===1) createParticles(fw);
        for(let p of fw.particles){ p.x += p.vx; p.y += p.vy; p.vy += 0.03; p.life++; const alpha = Math.max(0,1 - p.life/p.ttl);
          const color = `hsla(${p.hue},85%,65%,${alpha})`;
          drawHeart(p.x,p.y,p.size, color, alpha);
        }
        if (fw.particles.every(p=>p.life > p.ttl-2)){ fireworks.splice(i,1); }
      }
    }

    function triggerLocalizedFirework(slot){ const rc = slot.getBoundingClientRect(); const x = rc.left + rc.width/2; const y = rc.top + rc.height/2; launchFireworkAt(x, y - 30, 1.4); }

    // main loop
    function loop(){ rotation += 0.0035; positionSlots(); updateFireworks(); requestAnimationFrame(loop); }

    // init
    (async function init(){ imageUrls = await fetchImages(); if (imageUrls.length===0) return; // error shown
      // preload
      let loaded=0; for(const u of imageUrls){ const im=new Image(); im.src=u; im.onload=im.onerror=()=>{ loaded++; if (loaded>=imageUrls.length){ loading.style.display='none'; buildRing(); startAutoplay(); loop(); for(let i=0;i<3;i++) setTimeout(()=>launchRandomFirework(), i*700); } }; }
    })();

    // expose helpers for debugging
    window._romantic = { next, prev, focus };

  </script>
</body>
</html>
