<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Sala Romántica — Polaroid Mejorada</title>
  <style>
    :root{
      --rose-1:#ff7ab0;
      --rose-2:#ffdcee;
      --bg-dark:#100418;
      --glass: rgba(255,255,255,0.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:radial-gradient(circle at 20% 10%, rgba(255,120,170,0.06), transparent 20%), linear-gradient(180deg,#15051a 0%, #08020a 100%);font-family:Inter, 'Segoe UI', Roboto, system-ui;color:var(--rose-2);-webkit-font-smoothing:antialiased}

    /* Center container */
    .stage{height:100vh;width:100vw;display:flex;align-items:center;justify-content:center;padding:20px;position:relative;overflow:hidden}

    /* soft vignette + floating petals */
    .bg-vignette{position:absolute;inset:0;pointer-events:none;background:radial-gradient(60% 50% at 50% 30%, rgba(255,140,180,0.06), transparent 25%);} 

    /* Polaroid carousel */
    .carousel{width:clamp(260px,78vw,520px);max-height:85vh;position:relative;display:flex;align-items:center;justify-content:center}
    .frame{
      width:100%;height:100%;position:relative;border-radius:14px;overflow:hidden;box-shadow:0 20px 60px rgba(10,5,10,0.6),0 4px 18px rgba(255,120,180,0.07);
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      display:flex;align-items:center;justify-content:center;padding:16px}

    /* crossfade + ken burns */
    .slide{position:absolute;inset:16px;border-radius:10px;overflow:hidden;opacity:0;transform:scale(1);transition:opacity 700ms ease, transform 700ms ease}
    .slide img{width:100%;height:100%;object-fit:cover;display:block;transform-origin:center center}
    .slide.active{opacity:1;z-index:5;animation:kenburns 12s ease-in-out infinite}
    .slide.prev{opacity:0.0;z-index:2}

    @keyframes kenburns{0%{transform:scale(1) translateY(0)}50%{transform:scale(1.06) translateY(-3%)}100%{transform:scale(1) translateY(0)}}

    /* soft romantic overlay gradient */
    .soft-glow{position:absolute;inset:0;pointer-events:none;background:radial-gradient(40% 40% at 10% 20%, rgba(255,100,150,0.06), transparent 15%), radial-gradient(30% 30% at 90% 80%, rgba(220,180,255,0.03), transparent 12%)}

    /* controls overlay (only title + main button) */
    .ui{position:absolute;left:16px;right:16px;top:16px;display:flex;align-items:center;justify-content:space-between;gap:12px;z-index:60}
    .title{font-weight:700;font-size:clamp(14px,4vw,18px);letter-spacing:0.2px;text-shadow:0 6px 20px rgba(255,100,160,0.14)}
    .controls{display:flex;gap:8px;align-items:center}
    .btn{
      background:linear-gradient(180deg,var(--rose-1), #ff9ccf);
      color:#27011a;border:0;padding:10px 14px;border-radius:12px;font-weight:700;font-size:clamp(12px,3.2vw,13px);cursor:pointer;box-shadow:0 8px 30px rgba(255,90,150,0.14);backdrop-filter:blur(4px)}
    .btn:active{transform:translateY(1px)}

    /* small pagination dots, hidden on mobile except condensed */
    .dots{position:absolute;left:50%;transform:translateX(-50%);bottom:18px;display:flex;gap:8px;z-index:60}
    .dot{width:8px;height:8px;border-radius:999px;background:rgba(255,255,255,0.14);box-shadow:0 6px 18px rgba(255,90,150,0.04)}
    .dot.active{width:28px;border-radius:999px;background:linear-gradient(90deg,var(--rose-1),#ffd1ea);box-shadow:0 12px 30px rgba(255,90,150,0.16)}

    /* preview modal */
    .preview{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(10,5,10,0.7),rgba(4,2,6,0.95));z-index:120;padding:24px}
    .preview img{max-width:98vw;max-height:88vh;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,0.6)}
    .preview.show{display:flex}

    /* floating petals/hearts (reduced for mobile) */
    .particles{position:absolute;inset:0;pointer-events:none;z-index:20}
    .petal{position:absolute;width:22px;height:22px;opacity:0;transform:translateY(0);animation:petal 6s linear infinite}
    @keyframes petal{0%{opacity:0;transform:translateY(-10vh) rotate(0) scale(0.6)}10%{opacity:1}90%{opacity:1;transform:translateY(100vh) rotate(360deg) scale(1)}100%{opacity:0}}

    /* loading placeholder */
    .loader{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);z-index:80}

    /* responsive tweaks */
    @media (max-width:720px){
      .carousel{width:92vw}
      .title{font-size:16px}
      .dots{bottom:12px}
      .petal{width:14px;height:14px}
      .frame{padding:10px;border-radius:10px}
    }
  </style>
</head>
<body>
  <div class="stage" id="stage">
    <div class="bg-vignette"></div>
    <div class="carousel" aria-hidden="false">
      <div class="frame" id="frame">
        <!-- slides injected by JS -->
      </div>
      <div class="soft-glow"></div>
      <div class="ui" id="ui">
        <div class="title">Sala Romántica — Recuerdos</div>
        <div class="controls">
          <button id="prevBtn" class="btn" aria-label="Anterior">Anterior</button>
          <button id="nextBtn" class="btn" aria-label="Siguiente">Siguiente</button>
        </div>
      </div>
      <div class="dots" id="dots" aria-hidden="true"></div>
    </div>

    <div class="particles" id="particles"></div>

    <!-- preview modal (only image + close) -->
    <div class="preview" id="preview" aria-hidden="true">
      <img id="previewImg" alt="Imagen ampliada">
    </div>
  </div>

  <script type="module">
    // === conserva tu configuración Firebase (solo la dejamos como estaba) ===
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
    import { getDatabase, ref, get } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';
    const firebaseConfig = {
      apiKey: "AIzaSyBk2SVaP1w4V3MWrpp1r3X5Xk9eH06gBt4",
      authDomain: "tunel-de-recuerdos.firebaseapp.com",
      projectId: "tunel-de-recuerdos",
      storageBucket: "tunel-de-recuerdos.firebasestorage.app",
      messagingSenderId: "630660710506",
      appId: "1:630660710506:web:90d34150c9f21f668eca13",
      measurementId: "G-ETFDVEHML1"
    };
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // helpers
    const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent) || window.innerWidth < 720;
    const devicePixelRatio = window.devicePixelRatio || 1;

    async function fetchImages(){
      // similar a tu lógica: espera un id por querystring
      const urlParams = new URLSearchParams(window.location.search);
      const userId = urlParams.get('id')?.trim();
      if(!userId){
        // fallback: ejemplo con picsum para demo
        return Array.from({length:7}).map((_,i)=>`https://picsum.photos/id/${110 + i}/3840/2160`);
      }
      try{
        const snap = await get(ref(database, `usuarios/${userId}`));
        if(!snap.exists()) return [];
        const data = snap.val();
        let all = [];
        for(let i=1;i<=5;i++){
          const fotos = data[`puerta${i}Fotos`] || [];
          all = all.concat(fotos.filter(u=>typeof u==='string'&&u.trim()));
        }
        if(all.length === 0) return [];
        // ensure at least 5 - expand by repeating if needed
        while(all.length < 7) all = all.concat(all.slice(0, Math.min(all.length, 7 - all.length)));
        return all.slice(0,7);
      }catch(e){
        console.error(e);
        return [];
      }
    }

    (async function init(){
      const frame = document.getElementById('frame');
      const dots = document.getElementById('dots');
      const particles = document.getElementById('particles');
      const preview = document.getElementById('preview');
      const previewImg = document.getElementById('previewImg');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');

      // show a subtle loader while fetching
      const slides = [];
      const urls = await fetchImages();
      const TOTAL = Math.max(1, Math.min(7, urls.length || 7));

      // preload + create slides (with high-res srcset if possible)
      for(let i=0;i<TOTAL;i++){
        const u = urls[i % urls.length];
        const slide = document.createElement('div');
        slide.className = 'slide';
        slide.dataset.index = i;
        const img = document.createElement('img');
        // attempt to request high-res images; if your URLs accept params adapt as needed
        if(u.includes('picsum.photos')){
          img.src = u; // picsum path already 3840x2160
          img.srcset = `${u} 3840w, ${u.replace('/3840/2160','/1920/1080')} 1920w, ${u.replace('/3840/2160','/800/450')} 800w`;
        } else {
          // if firebase url, use it directly but keep lazy loading
          img.src = u;
        }
        img.loading = isMobile ? 'lazy' : 'eager';
        img.alt = `Recuerdo ${i+1}`;
        slide.appendChild(img);
        frame.appendChild(slide);
        slides.push(slide);

        // prewarm image
        const pre = new Image(); pre.src = img.src;
      }

      // dots
      slides.forEach((s, idx)=>{
        const d = document.createElement('button'); d.className='dot'; d.setAttribute('aria-label',`Ir a ${idx+1}`);
        d.addEventListener('click',()=>goTo(idx));
        dots.appendChild(d);
      });

      // automatic loop + manual controls
      let current = 0;
      let playing = true;
      const AUTO_MS = isMobile ? 3500 : 4500;
      function setActive(i){
        slides.forEach((s,idx)=>{s.classList.toggle('active', idx===i); s.classList.toggle('prev', idx!==i);});
        const dotButtons = dots.querySelectorAll('.dot'); dotButtons.forEach((db,idx)=>db.classList.toggle('active', idx===i));
      }

      function goTo(i){ current = (i + slides.length) % slides.length; setActive(current); }
      function next(){ goTo(current+1); }
      function prev(){ goTo(current-1); }

      prevBtn.addEventListener('click',(e)=>{ prev(); spawnParticle(); giveRipple(e.currentTarget, e.clientX, e.clientY); });
      nextBtn.addEventListener('click',(e)=>{ next(); spawnParticle(); giveRipple(e.currentTarget, e.clientX, e.clientY); });

      // click slide to open preview (only active slide)
      frame.addEventListener('click',(e)=>{
        const s = e.target.closest('.slide.active');
        if(!s) return;
        const src = s.querySelector('img').src;
        previewImg.src = src; preview.classList.add('show'); preview.setAttribute('aria-hidden','false');
      });
      preview.addEventListener('click', ()=>{ preview.classList.remove('show'); preview.setAttribute('aria-hidden','true'); previewImg.src=''; });

      // autoplay loop
      let autoTimer = setInterval(()=>{ next(); }, AUTO_MS);
      // pause when interacting
      [prevBtn,nextBtn,frame].forEach(el=>{ el.addEventListener('pointerdown', ()=>{ clearInterval(autoTimer); autoTimer = setInterval(()=>{ next(); }, AUTO_MS); }); });

      // start
      setActive(0);

      // light weighted particles for romance
      function spawnParticle(){
        const el = document.createElement('div'); el.className='petal';
        el.style.left = Math.random()*100 + '%';
        el.style.top = (-5 - Math.random()*8) + 'vh';
        el.style.animationDuration = (5 + Math.random()*4) + 's';
        el.style.opacity = 1; particles.appendChild(el);
        setTimeout(()=> el.remove(),8000);
      }

      // create a few at start with different shapes (hearts/petals) using SVG backgrounds
      function seedParticles(n=6){
        for(let i=0;i<n;i++){
          const p = document.createElement('div'); p.className='petal';
          const left = Math.random()*100; p.style.left = left + '%'; p.style.top = (-10 - Math.random()*20) + 'vh';
          p.style.animationDelay = (Math.random()*2) + 's'; p.style.animationDuration = (5 + Math.random()*6) + 's';
          // alternate shapes via clip-path
          if(i%2===0) p.style.background = 'radial-gradient(circle at 35% 30%, rgba(255,140,180,0.95), transparent 60%)';
          else p.style.background = 'radial-gradient(circle, rgba(255,200,240,0.95), transparent 70%)';
          particles.appendChild(p);
          setTimeout(()=> p.remove(),9000);
        }
      }
      seedParticles(isMobile?4:8);

      // small ripple effect for buttons
      function giveRipple(button, clientX, clientY){
        const rect = button.getBoundingClientRect(); const x = clientX - rect.left; const y = clientY - rect.top; const r = Math.max(rect.width, rect.height);
        const el = document.createElement('span'); el.style.position='absolute'; el.style.left=(x - r/2)+'px'; el.style.top=(y - r/2)+'px'; el.style.width=el.style.height=(r)+'px'; el.style.borderRadius='999px'; el.style.opacity='0.18'; el.style.background='white'; el.style.transform='scale(0)'; el.style.transition='transform .5s ease, opacity .5s ease'; el.style.pointerEvents='none'; button.style.position='relative'; button.appendChild(el);
        requestAnimationFrame(()=>{ el.style.transform='scale(1.8)'; el.style.opacity='0'; });
        setTimeout(()=> el.remove(),600);
      }

      // keyboard navigation
      window.addEventListener('keydown', (e)=>{ if(e.key==='ArrowRight') next(); if(e.key==='ArrowLeft') prev(); if(e.key==='Escape') { preview.classList.remove('show'); previewImg.src=''; } });

      // accessibility: pause animations when user prefers reduced motion
      const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      if(prefersReduced){ slides.forEach(s=>s.style.animation='none'); }

    })();
  </script>
</body>
</html>
