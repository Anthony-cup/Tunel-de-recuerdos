<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Puerta Rom√°ntica ‚Äî Lluvia de P√©talos</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --rose: #ff69b4;
      --pink: #ffc0cb;
      --light-pink: #ffe4e1;
      --cream: #fff8dc;
      --white: #ffffff;
    }

    body, html {
      height: 100%;
      font-family: 'Georgia', serif;
      overflow: hidden;
      background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
      position: relative;
    }

    /* Barra de carga */
    #loadingScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      transition: opacity 1s ease-out;
    }

    .loading-heart {
      font-size: 3rem;
      color: var(--rose);
      animation: heartbeat 1.5s ease-in-out infinite;
      margin-bottom: 2rem;
    }

    @keyframes heartbeat {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }

    .loading-bar {
      width: 300px;
      height: 8px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 50px;
      overflow: hidden;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }

    .loading-progress {
      width: 0%;
      height: 100%;
      background: linear-gradient(90deg, var(--rose), var(--pink));
      border-radius: 50px;
      transition: width 0.3s ease;
      box-shadow: 0 0 20px rgba(255, 105, 180, 0.5);
    }

    .loading-text {
      color: var(--rose);
      margin-top: 1rem;
      font-size: 1.2rem;
      text-align: center;
    }

    /* Contenedor principal */
    #container {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      opacity: 0;
      transition: opacity 1.5s ease-in;
    }

    /* Bot√≥n regresar */
    #returnBtn {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, var(--rose), var(--pink));
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 25px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(255, 105, 180, 0.3);
      transition: all 0.3s ease;
      z-index: 100;
    }

    #returnBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 105, 180, 0.4);
    }

    /* P√©talos de fondo */
    .petal {
      position: absolute;
      width: 20px;
      height: 20px;
      background: var(--pink);
      border-radius: 50% 0 50% 0;
      opacity: 0.7;
      pointer-events: none;
      animation: fall linear infinite;
    }

    @keyframes fall {
      0% {
        transform: translateY(-100vh) rotateZ(0deg);
        opacity: 0;
      }
      10% {
        opacity: 0.7;
      }
      90% {
        opacity: 0.7;
      }
      100% {
        transform: translateY(100vh) rotateZ(360deg);
        opacity: 0;
      }
    }

    /* Contenedor de fotos */
    #photosContainer {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Foto individual */
    .photo {
      position: absolute;
      width: 200px;
      height: 150px;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      cursor: pointer;
      transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      opacity: 0;
      transform: scale(0) rotate(180deg);
      border: 4px solid var(--white);
    }

    .photo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }

    .photo:hover {
      transform: scale(1.1) rotate(0deg);
      z-index: 10;
      box-shadow: 0 20px 50px rgba(255, 105, 180, 0.4);
    }

    .photo:hover img {
      transform: scale(1.05);
    }

    /* Animaci√≥n de entrada para fotos */
    .photo.appear {
      opacity: 1;
      transform: scale(1) rotate(0deg);
    }

    /* Animaci√≥n de bucle flotante */
    .photo.floating {
      animation: float 6s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      25% { transform: translateY(-10px) rotate(2deg); }
      50% { transform: translateY(-5px) rotate(-1deg); }
      75% { transform: translateY(-15px) rotate(1deg); }
    }

    /* Modal de vista previa */
    #previewModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(10px);
    }

    #previewModal img {
      max-width: 90%;
      max-height: 90%;
      border-radius: 15px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      animation: modalAppear 0.5s ease-out;
    }

    @keyframes modalAppear {
      0% { transform: scale(0.5) rotate(10deg); opacity: 0; }
      100% { transform: scale(1) rotate(0deg); opacity: 1; }
    }

    #previewModal .close-btn {
      position: absolute;
      top: 30px;
      right: 30px;
      background: var(--rose);
      color: white;
      border: none;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      font-size: 1.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 15px rgba(255, 105, 180, 0.3);
      transition: all 0.3s ease;
    }

    #previewModal .close-btn:hover {
      transform: scale(1.1);
      background: var(--pink);
    }

    /* Error message */
    #errorMessage {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
      color: white;
      padding: 2rem;
      border-radius: 20px;
      text-align: center;
      font-size: 1.2rem;
      box-shadow: 0 10px 30px rgba(255, 107, 107, 0.3);
      display: none;
      z-index: 1001;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .photo {
        width: 150px;
        height: 112px;
      }

      #returnBtn {
        top: 15px;
        right: 15px;
        padding: 10px 20px;
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>
  <!-- Pantalla de carga -->
  <div id="loadingScreen">
    <div class="loading-heart">üíñ</div>
    <div class="loading-bar">
      <div class="loading-progress" id="loadingProgress"></div>
    </div>
    <div class="loading-text" id="loadingText">Preparando tus recuerdos rom√°nticos...</div>
  </div>

  <!-- Error message -->
  <div id="errorMessage"></div>

  <!-- Contenedor principal -->
  <div id="container">
    <!-- Bot√≥n regresar -->
    <button id="returnBtn">‚Üê Regresar</button>

    <!-- Contenedor de fotos -->
    <div id="photosContainer"></div>
  </div>

  <!-- Modal de vista previa -->
  <div id="previewModal" id="previewModal">
    <button class="close-btn" id="closeBtn">√ó</button>
    <img id="previewImage" src="" alt="Vista previa">
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
    import { getDatabase, ref, get } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBk2SVaP1w4V3MWrpp1r3X5Xk9eH06gBt4",
      authDomain: "tunel-de-recuerdos.firebaseapp.com",
      projectId: "tunel-de-recuerdos",
      storageBucket: "tunel-de-recuerdos.firebasestorage.app",
      messagingSenderId: "630660710506",
      appId: "1:630660710506:web:90d34150c9f21f668eca13",
      measurementId: "G-ETFDVEHML1"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    let imageUrls = [];
    let loadingProgress = 0;

    // Elementos DOM
    const loadingScreen = document.getElementById('loadingScreen');
    const loadingProgressBar = document.getElementById('loadingProgress');
    const loadingText = document.getElementById('loadingText');
    const container = document.getElementById('container');
    const photosContainer = document.getElementById('photosContainer');
    const errorMessage = document.getElementById('errorMessage');
    const previewModal = document.getElementById('previewModal');
    const previewImage = document.getElementById('previewImage');
    const closeBtn = document.getElementById('closeBtn');
    const returnBtn = document.getElementById('returnBtn');

    // Actualizar barra de progreso
    function updateProgress(percent, text = '') {
      loadingProgress = percent;
      loadingProgressBar.style.width = percent + '%';
      if (text) loadingText.textContent = text;
    }

    // Mostrar error
    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
      loadingScreen.style.opacity = '0';
      setTimeout(() => loadingScreen.style.display = 'none', 1000);
    }

    // Cargar im√°genes desde Firebase
    async function fetchImages() {
      updateProgress(10, 'Conectando con Firebase...');
      
      const urlParams = new URLSearchParams(window.location.search);
      const userId = urlParams.get('id')?.trim();
      
      if (!userId || userId === '') {
        showError('No creaste tu proyecto. Por favor, crea tu ID primero.');
        return [];
      }

      try {
        updateProgress(30, 'Obteniendo tus im√°genes...');
        
        const snapshot = await get(ref(database, `usuarios/${userId}`));
        
        if (snapshot.exists()) {
          const data = snapshot.val();
          const puertaFotos = data.puerta4Fotos || [];
          const validFotos = puertaFotos.slice(0, 7).filter(url => typeof url === 'string' && url.trim() !== '');
          
          updateProgress(60, 'Validando im√°genes...');
          
          if (validFotos.length === 0) {
            showError('No hay im√°genes en tu galer√≠a. Agrega im√°genes primero.');
            return [];
          }
          
          updateProgress(80, 'Preparando la magia...');
          return validFotos;
        } else {
          showError('No creaste tu proyecto. Por favor, crea tu ID primero.');
          return [];
        }
      } catch (error) {
        console.error("Error al consultar Firebase:", error);
        showError('Error al cargar las im√°genes. Por favor, intenta de nuevo.');
        return [];
      }
    }

    // Crear p√©talos de fondo
    function createPetals() {
      const colors = ['#ff69b4', '#ffc0cb', '#ffe4e1', '#ffb6c1'];
      
      function createPetal() {
        const petal = document.createElement('div');
        petal.className = 'petal';
        petal.style.left = Math.random() * 100 + 'vw';
        petal.style.background = colors[Math.floor(Math.random() * colors.length)];
        petal.style.animationDuration = (Math.random() * 3 + 5) + 's';
        petal.style.animationDelay = Math.random() * 2 + 's';
        
        // Diferentes formas de p√©talos
        const shapes = ['50% 0 50% 0', '50% 50% 50% 0', '0 50% 50% 50%'];
        petal.style.borderRadius = shapes[Math.floor(Math.random() * shapes.length)];
        
        document.body.appendChild(petal);
        
        // Remover despu√©s de la animaci√≥n
        setTimeout(() => {
          if (petal.parentNode) {
            petal.parentNode.removeChild(petal);
          }
        }, 8000);
      }
      
      // Crear p√©talos continuamente
      setInterval(createPetal, 300);
    }

    // Posicionar fotos en c√≠rculo
    function getPhotoPosition(index, total) {
      const centerX = window.innerWidth / 2;
      const centerY = window.innerHeight / 2;
      const radius = Math.min(window.innerWidth, window.innerHeight) * 0.25;
      const angle = (index / total) * Math.PI * 2 - Math.PI / 2;
      
      return {
        x: centerX + Math.cos(angle) * radius - 100, // -100 para centrar la foto
        y: centerY + Math.sin(angle) * radius - 75   // -75 para centrar la foto
      };
    }

    // Crear elemento de foto
    function createPhoto(url, index) {
      const photo = document.createElement('div');
      photo.className = 'photo';
      
      const img = document.createElement('img');
      img.src = url;
      img.alt = `Recuerdo ${index + 1}`;
      
      photo.appendChild(img);
      
      // Posicionar
      const position = getPhotoPosition(index, imageUrls.length);
      photo.style.left = position.x + 'px';
      photo.style.top = position.y + 'px';
      
      // A√±adir delay √∫nico para la animaci√≥n de entrada
      photo.style.animationDelay = (index * 0.5) + 's';
      
      // Click para vista previa
      photo.addEventListener('click', () => {
        previewImage.src = url;
        previewModal.style.display = 'flex';
      });
      
      return photo;
    }

    // Animaci√≥n de entrada de fotos
    async function animatePhotosEntrance() {
      const photos = photosContainer.querySelectorAll('.photo');
      
      for (let i = 0; i < photos.length; i++) {
        await new Promise(resolve => {
          setTimeout(() => {
            photos[i].classList.add('appear');
            resolve();
          }, i * 500); // 500ms entre cada foto
        });
      }
      
      // Despu√©s de que aparezcan todas, a√±adir animaci√≥n de bucle
      setTimeout(() => {
        photos.forEach((photo, index) => {
          photo.style.animationDelay = (index * 0.2) + 's';
          photo.classList.add('floating');
        });
      }, 1000);
    }

    // Inicializar la aplicaci√≥n
    async function init() {
      updateProgress(5, 'Iniciando...');
      
      imageUrls = await fetchImages();
      
      if (imageUrls.length === 0) {
        return;
      }
      
      updateProgress(90, 'Creando la experiencia...');
      
      // Crear elementos de fotos
      imageUrls.forEach((url, index) => {
        const photo = createPhoto(url, index);
        photosContainer.appendChild(photo);
      });
      
      // Precargar im√°genes
      let loadedImages = 0;
      const totalImages = imageUrls.length;
      
      const loadPromises = imageUrls.map(url => {
        return new Promise(resolve => {
          const img = new Image();
          img.onload = () => {
            loadedImages++;
            updateProgress(90 + (loadedImages / totalImages) * 10, 
              `Cargando im√°genes... ${loadedImages}/${totalImages}`);
            resolve();
          };
          img.onerror = resolve;
          img.src = url;
        });
      });
      
      await Promise.all(loadPromises);
      
      updateProgress(100, '¬°Listo! Disfrutando tus recuerdos...');
      
      // Ocultar pantalla de carga y mostrar contenido
      setTimeout(() => {
        loadingScreen.style.opacity = '0';
        container.style.opacity = '1';
        
        setTimeout(() => {
          loadingScreen.style.display = 'none';
          createPetals();
          animatePhotosEntrance();
        }, 1000);
      }, 500);
    }

    // Event listeners
    closeBtn.addEventListener('click', () => {
      previewModal.style.display = 'none';
    });

    previewModal.addEventListener('click', (e) => {
      if (e.target === previewModal) {
        previewModal.style.display = 'none';
      }
    });

    returnBtn.addEventListener('click', () => {
      window.parent.postMessage({ type: 'doorClosed' }, '*');
    });

    // Responsive
    window.addEventListener('resize', () => {
      const photos = photosContainer.querySelectorAll('.photo');
      photos.forEach((photo, index) => {
        const position = getPhotoPosition(index, photos.length);
        photo.style.left = position.x + 'px';
        photo.style.top = position.y + 'px';
      });
    });

    // Cerrar modal con Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        previewModal.style.display = 'none';
      }
    });

    // Iniciar la aplicaci√≥n
    init();
  </script>
</body>
</html>
