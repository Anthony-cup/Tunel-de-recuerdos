<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Lluvia de Pétalos</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #ffeef8 0%, #ffcce5 30%, #e6b3ff 70%, #d9b3ff 100%);
      min-height: 100vh;
      overflow: hidden;
      position: relative;
    }

    /* Barra de carga */
    #loadingContainer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #ffeef8, #ffcce5);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      transition: opacity 0.8s ease;
    }

    #loadingText {
      color: #8b4992;
      font-size: 24px;
      margin-bottom: 20px;
      text-align: center;
    }

    #loadingBar {
      width: 300px;
      height: 6px;
      background: rgba(139, 73, 146, 0.2);
      border-radius: 3px;
      overflow: hidden;
    }

    #loadingProgress {
      width: 0%;
      height: 100%;
      background: linear-gradient(90deg, #ff6b9d, #c44569);
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    /* Contenedor principal */
    #mainContainer {
      position: relative;
      width: 100%;
      height: 100vh;
      overflow: hidden;
      opacity: 0;
      transition: opacity 1s ease;
    }

    /* Botón regresar */
    #returnBtn {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 100;
      padding: 12px 20px;
      background: linear-gradient(135deg, #ff6b9d, #c44569);
      color: white;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      box-shadow: 0 4px 20px rgba(196, 69, 105, 0.3);
      transition: all 0.3s ease;
    }

    #returnBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(196, 69, 105, 0.4);
    }

    /* Pétalos */
    .petal {
      position: absolute;
      width: 20px;
      height: 20px;
      background: radial-gradient(ellipse at center, #ff6b9d, #ff8fb3);
      border-radius: 50% 0 50% 0;
      opacity: 0.8;
      pointer-events: none;
      transform-origin: center;
    }

    .petal.large {
      width: 30px;
      height: 30px;
      background: radial-gradient(ellipse at center, #c44569, #ff6b9d);
    }

    .petal.small {
      width: 15px;
      height: 15px;
      background: radial-gradient(ellipse at center, #ff8fb3, #ffb3d1);
    }

    /* Imágenes */
    .photo-container {
      position: absolute;
      opacity: 0;
      transform: scale(0.3) rotate(10deg);
      transition: all 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
      cursor: pointer;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .photo-container.visible {
      opacity: 1;
      transform: scale(1) rotate(0deg);
    }

    .photo-container img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 15px;
      transition: transform 0.3s ease;
    }

    .photo-container:hover img {
      transform: scale(1.05);
    }

    .photo-container::before {
      content: '';
      position: absolute;
      top: -5px;
      left: -5px;
      right: -5px;
      bottom: -5px;
      background: linear-gradient(45deg, #ff6b9d, #c44569, #ff8fb3);
      border-radius: 20px;
      z-index: -1;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .photo-container:hover::before {
      opacity: 0.7;
    }

    /* Modal */
    #previewModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 200;
      backdrop-filter: blur(10px);
    }

    #previewContent {
      max-width: 90vw;
      max-height: 90vh;
      position: relative;
    }

    #previewContent img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 10px;
    }

    #previewClose {
      position: absolute;
      top: -40px;
      right: 0;
      background: linear-gradient(135deg, #ff6b9d, #c44569);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
    }

    #errorMessage {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #c44569;
      font-size: 24px;
      text-align: center;
      z-index: 150;
      display: none;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .photo-container {
        width: 120px !important;
        height: 120px !important;
      }
      
      #returnBtn {
        top: 10px;
        left: 10px;
        padding: 10px 16px;
        font-size: 13px;
      }
    }
  </style>
</head>
<body>
  <div id="loadingContainer">
    <div id="loadingText">Cargando...</div>
    <div id="loadingBar">
      <div id="loadingProgress"></div>
    </div>
  </div>

  <div id="errorMessage">No se encontraron imágenes para mostrar</div>

  <div id="mainContainer">
    <button id="returnBtn">← Regresar</button>
    
    <div id="previewModal">
      <div id="previewContent">
        <button id="previewClose">×</button>
        <img id="previewImage" src="" alt="Vista previa">
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
    import { getDatabase, ref, get } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBk2SVaP1w4V3MWrpp1r3X5Xk9eH06gBt4",
      authDomain: "tunel-de-recuerdos.firebaseapp.com",
      projectId: "tunel-de-recuerdos",
      storageBucket: "tunel-de-recuerdos.firebasestorage.app",
      messagingSenderId: "630660710506",
      appId: "1:630660710506:web:90d34150c9f21f668eca13",
      measurementId: "G-ETFDVEHML1"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    let imageUrls = [];
    let loadedImages = 0;
    let totalImages = 0;

    async function fetchImages() {
      const urlParams = new URLSearchParams(window.location.search);
      const userId = urlParams.get('id')?.trim();
      
      if (!userId || userId === '') {
        showError('No creaste tu proyecto. Por favor, crea tu ID primero.');
        return [];
      }
      
      try {
        const snapshot = await get(ref(database, `usuarios/${userId}`));
        if (snapshot.exists()) {
          const data = snapshot.val();
          const puertaFotos = data.puerta4Fotos || [];
          const validFotos = puertaFotos.slice(0, 7).filter(url => typeof url === 'string' && url.trim() !== '');
          
          if (validFotos.length === 0) {
            showError('No hay imágenes en tu galería. Agrega imágenes primero.');
          }
          return validFotos;
        } else {
          showError('No creaste tu proyecto. Por favor, crea tu ID primero.');
          return [];
        }
      } catch (error) {
        showError('Error al cargar las imágenes. Intenta de nuevo.');
        return [];
      }
    }

    function showError(message) {
      document.getElementById('errorMessage').textContent = message;
      document.getElementById('errorMessage').style.display = 'block';
      hideLoading();
    }

    function updateLoadingProgress(percentage) {
      document.getElementById('loadingProgress').style.width = percentage + '%';
      
      if (percentage < 30) {
        document.getElementById('loadingText').textContent = 'Recogiendo pétalos...';
      } else if (percentage < 70) {
        document.getElementById('loadingText').textContent = 'Preparando tus recuerdos...';
      } else {
        document.getElementById('loadingText').textContent = 'Casi listo...';
      }
    }

    function preloadImages(urls) {
      return new Promise((resolve) => {
        totalImages = urls.length;
        if (totalImages === 0) {
          resolve();
          return;
        }

        urls.forEach((url, index) => {
          const img = new Image();
          img.onload = () => {
            loadedImages++;
            const percentage = (loadedImages / totalImages) * 100;
            updateLoadingProgress(percentage);
            
            if (loadedImages === totalImages) {
              setTimeout(() => resolve(), 500);
            }
          };
          img.onerror = () => {
            loadedImages++;
            const percentage = (loadedImages / totalImages) * 100;
            updateLoadingProgress(percentage);
            
            if (loadedImages === totalImages) {
              setTimeout(() => resolve(), 500);
            }
          };
          img.src = url;
        });
      });
    }

    function hideLoading() {
      const loadingContainer = document.getElementById('loadingContainer');
      loadingContainer.style.opacity = '0';
      setTimeout(() => {
        loadingContainer.style.display = 'none';
        document.getElementById('mainContainer').style.opacity = '1';
        if (imageUrls.length > 0) {
          startPetalRain();
        }
      }, 800);
    }

    function createPetal() {
      const petal = document.createElement('div');
      petal.className = 'petal';
      
      // Tipos de pétalos aleatorios
      const types = ['', 'large', 'small'];
      const randomType = types[Math.floor(Math.random() * types.length)];
      if (randomType) petal.classList.add(randomType);
      
      // Posición inicial aleatoria
      petal.style.left = Math.random() * window.innerWidth + 'px';
      petal.style.top = '-30px';
      
      // Rotación aleatoria
      petal.style.transform = `rotate(${Math.random() * 360}deg)`;
      
      document.getElementById('mainContainer').appendChild(petal);
      
      // Animación de caída
      const duration = 3000 + Math.random() * 2000;
      const startTime = Date.now();
      const startX = parseFloat(petal.style.left);
      
      function animatePetal() {
        const elapsed = Date.now() - startTime;
        const progress = elapsed / duration;
        
        if (progress >= 1) {
          petal.remove();
          return;
        }
        
        // Movimiento vertical
        const y = progress * (window.innerHeight + 50);
        
        // Movimiento horizontal ondulado
        const x = startX + Math.sin(progress * Math.PI * 4) * 50;
        
        // Rotación continua
        const rotation = progress * 720 + Math.random() * 360;
        
        petal.style.top = y + 'px';
        petal.style.left = x + 'px';
        petal.style.transform = `rotate(${rotation}deg)`;
        
        requestAnimationFrame(animatePetal);
      }
      
      animatePetal();
    }

    function startPetalRain() {
      // Lluvia inicial intensa
      for (let i = 0; i < 50; i++) {
        setTimeout(() => createPetal(), i * 100);
      }
      
      // Continuar con lluvia constante
      setInterval(() => {
        createPetal();
        if (Math.random() < 0.3) createPetal(); // Pétalos extra ocasionales
      }, 200);
      
      // Mostrar fotos una por una
      showPhotosSequentially();
    }

    function showPhotosSequentially() {
      const positions = [
        { left: '15%', top: '20%', width: '200px', height: '150px' },
        { left: '70%', top: '15%', width: '180px', height: '180px' },
        { left: '25%', top: '60%', width: '160px', height: '200px' },
        { left: '60%', top: '55%', width: '190px', height: '140px' },
        { left: '45%', top: '30%', width: '170px', height: '170px' },
        { left: '10%', top: '75%', width: '150px', height: '180px' },
        { left: '75%', top: '75%', width: '160px', height: '160px' }
      ];

      imageUrls.forEach((url, index) => {
        setTimeout(() => {
          createPhotoElement(url, positions[index], index);
        }, index * 1200 + 2000); // Delay inicial de 2 segundos
      });
    }

    function createPhotoElement(url, position, index) {
      const container = document.createElement('div');
      container.className = 'photo-container';
      container.style.left = position.left;
      container.style.top = position.top;
      container.style.width = position.width;
      container.style.height = position.height;
      
      const img = document.createElement('img');
      img.src = url;
      img.alt = `Recuerdo ${index + 1}`;
      
      container.appendChild(img);
      document.getElementById('mainContainer').appendChild(container);
      
      // Animación de entrada
      setTimeout(() => {
        container.classList.add('visible');
        startFloatingAnimation(container);
      }, 100);
      
      // Click para ampliar
      container.addEventListener('click', () => openPreview(url));
    }

    function startFloatingAnimation(element) {
      const startTime = Date.now();
      const baseY = parseFloat(element.style.top);
      
      function animate() {
        const elapsed = Date.now() - startTime;
        const offset = Math.sin(elapsed * 0.001) * 8;
        element.style.transform = `translateY(${offset}px) scale(1)`;
        requestAnimationFrame(animate);
      }
      
      animate();
    }

    function openPreview(url) {
      document.getElementById('previewImage').src = url;
      document.getElementById('previewModal').style.display = 'flex';
    }

    function closePreview() {
      document.getElementById('previewModal').style.display = 'none';
    }

    // Event listeners
    document.getElementById('previewClose').addEventListener('click', closePreview);
    document.getElementById('previewModal').addEventListener('click', (e) => {
      if (e.target.id === 'previewModal') closePreview();
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closePreview();
    });
    document.getElementById('returnBtn').addEventListener('click', () => {
      window.parent.postMessage({ type: 'doorClosed' }, '*');
    });

    // Inicializar
    (async function() {
      updateLoadingProgress(10);
      imageUrls = await fetchImages();
      
      if (imageUrls.length > 0) {
        updateLoadingProgress(30);
        await preloadImages(imageUrls);
        updateLoadingProgress(100);
        setTimeout(hideLoading, 500);
      }
    })();
  </script>
</body>
</html>
