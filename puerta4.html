<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Puerta Rom√°ntica ‚Äî Jard√≠n de Luci√©rnagas</title>
  <style>
    :root{ --accent1:#ff6b9d; --accent2:#ffc3a0; --panel: rgba(255,255,255,0.04); }
    html,body{height:100%;margin:0;background:
      radial-gradient(1200px 800px at 30% 20%, rgba(255,107,157,0.03), transparent 12%),
      radial-gradient(800px 600px at 70% 80%, rgba(255,195,160,0.02), transparent 10%),
      linear-gradient(135deg,#0a0520,#1a0b2e,#2d1b69);overflow:hidden;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;color:#f5e6ff}
    #canvas-container{width:100vw;height:100vh;position:relative;display:block;touch-action:none}
    #overlay{position:absolute; left:16px; top:16px; z-index:250; min-width:240px; padding:14px;border-radius:16px; background: linear-gradient(135deg,var(--panel), rgba(255,107,157,0.08)); backdrop-filter: blur(8px); box-shadow: 0 20px 80px rgba(255,107,157,0.15);}
    #overlay h3{margin:0 0 8px 0;font-size:16px;color:var(--accent1);text-shadow:0 0 8px rgba(255,107,157,0.3)}
    #overlay p{margin:0;font-size:13px;opacity:0.9;line-height:1.4}
    .controls{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
    .btn, .btn-ghost{display:inline-flex;align-items:center;gap:8px;padding:9px 14px;border-radius:14px;border:0;cursor:pointer;font-weight:600;font-size:14px;-webkit-tap-highlight-color: transparent; transition: all .15s ease;}
    .btn{ background: linear-gradient(135deg,var(--accent1),var(--accent2)); color:#1a0b2e; box-shadow: 0 10px 40px rgba(255,107,157,0.2); text-shadow: 0 1px 2px rgba(0,0,0,0.1) }
    .btn:hover{ transform: translateY(-4px) scale(1.02); box-shadow: 0 15px 50px rgba(255,107,157,0.3) }
    .btn-ghost{ background:rgba(255,255,255,0.02);border:1px solid rgba(255,107,157,0.2); color:#f5e6ff; padding:8px 12px }
    .btn-ghost:hover{ background: rgba(255,107,157,0.1); transform: translateY(-3px); border-color: rgba(255,107,157,0.4) }
    #credits{position:absolute;right:16px;bottom:18px;color:#e6d7f0;font-size:12px;z-index:200;padding:10px 12px;border-radius:12px;background:linear-gradient(135deg,rgba(255,255,255,0.02),rgba(255,107,157,0.05));backdrop-filter:blur(4px)}
    #hint{position:absolute;left:50%;transform:translateX(-50%);bottom:20px;color:#f0e6ff;z-index:200;font-size:13px;padding:10px 16px;border-radius:999px;background:linear-gradient(90deg, rgba(255,107,157,0.06), rgba(255,195,160,0.04));backdrop-filter:blur(6px);box-shadow:0 4px 20px rgba(255,107,157,0.1)}
    #previewModal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(135deg, rgba(26,11,46,0.7), rgba(10,5,32,0.9));backdrop-filter:blur(8px);z-index:350}
    #previewContent{max-width:94vw;max-height:92vh;padding:16px;border-radius:16px;background:linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,107,157,0.02));display:flex;flex-direction:column;gap:12px;box-shadow:0 40px 120px rgba(0,0,0,0.8);backdrop-filter:blur(12px)}
    #previewContent img{max-width:100%;max-height:82vh;border-radius:12px;display:block;box-shadow:0 20px 60px rgba(0,0,0,0.7)}
    #previewClose{align-self:flex-end;padding:10px 16px;border-radius:12px;border:0;background:linear-gradient(135deg,var(--accent1),var(--accent2));color:#1a0b2e;cursor:pointer;font-weight:600}
    #errorMessage{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:24px;text-align:center;color:#ff6b9d;text-shadow:0 0 15px #ff6b9d, 0 0 30px #ff6b9d;z-index:130;display:none}
    @media (max-width:720px){ #overlay{left:10px;top:10px;padding:12px} .btn{padding:10px 12px;font-size:14px} #hint{display:none} }
  </style>
</head>
<body>
  <div id="errorMessage">No creaste tu proyecto. Por favor, crea tu ID primero.</div>
  <div id="canvas-container" aria-hidden="false"></div>

  <div id="overlay" role="region" aria-label="Controles">
    <h3>‚ú® Jard√≠n de Luci√©rnagas</h3>
    <p>Un santuario m√°gico donde tus recuerdos danzan entre luces celestiales. Toca para interactuar con la magia.</p>
    <div class="controls">
      <button id="toggleMode" class="btn" aria-pressed="false">üåô Modo Nocturno</button>
      <button id="rainbowBtn" class="btn-ghost">üåà Arco√≠ris</button>
      <button id="returnBtn" class="btn-ghost">‚Üê Volver</button>
    </div>
  </div>

  <div id="credits">Jard√≠n M√≠stico ‚Ä¢ Experiencia Rom√°ntica</div>
  <div id="hint">‚ú® Toca las luci√©rnagas para revelar la magia ‚ú®</div>

  <div id="previewModal" aria-hidden="true">
    <div id="previewContent"><button id="previewClose">Cerrar</button><img id="previewImage" src="" alt="Vista previa"></div>
  </div>

  <script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
    import { getDatabase, ref, get } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';
    const firebaseConfig = {
      apiKey: "AIzaSyBk2SVaP1w4V3MWrpp1r3X5Xk9eH06gBt4",
      authDomain: "tunel-de-recuerdos.firebaseapp.com",
      projectId: "tunel-de-recuerdos",
      storageBucket: "tunel-de-recuerdos.firebasestorage.app",
      messagingSenderId: "630660710506",
      appId: "1:630660710506:web:90d34150c9f21f668eca13",
      measurementId: "G-ETFDVEHML1"
    };
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    let imageUrls = [];

    async function fetchImages() {
      const errorMessage = document.getElementById('errorMessage');
      const urlParams = new URLSearchParams(window.location.search);
      const userId = urlParams.get('id')?.trim();
      
      if (!userId || userId === '') {
        errorMessage.style.display = 'block';
        return [];
      }
      
      try {
        const snapshot = await get(ref(database, `usuarios/${userId}`));
        if (snapshot.exists()) {
          const data = snapshot.val();
          const puertaFotos = data.puerta4Fotos || [];
          const validFotos = puertaFotos.slice(0, 7).filter(url => typeof url === 'string' && url.trim() !== '');
          
          if (validFotos.length === 0) {
            errorMessage.textContent = 'No hay im√°genes en tu jard√≠n m√°gico. Agrega recuerdos primero.';
            errorMessage.style.display = 'block';
          }
          return validFotos;
        } else {
          errorMessage.style.display = 'block';
          return [];
        }
      } catch (error) {
        errorMessage.textContent = 'Error al despertar las luci√©rnagas. Intenta de nuevo.';
        errorMessage.style.display = 'block';
        return [];
      }
    }

    (async function(){
      imageUrls = await fetchImages();
      const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent) || window.innerWidth < 720;
      
      const container = document.getElementById('canvas-container');
      const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
      renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1.5, 2));
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.domElement.style.display = 'block';
      renderer.domElement.style.touchAction = 'none';
      container.appendChild(renderer.domElement);

      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0x0a0520);
      scene.fog = new THREE.FogExp2(0x1a0b2e, 0.0008);

      const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 3000);
      camera.position.set(0, 100, 800);

      // Iluminaci√≥n m√≠stica
      const ambLight = new THREE.AmbientLight(0x4a2c7a, 0.3);
      scene.add(ambLight);
      
      const moonLight = new THREE.DirectionalLight(0xb19cd9, 0.6);
      moonLight.position.set(-200, 300, 100);
      scene.add(moonLight);

      const magicLight = new THREE.PointLight(0xff6b9d, 0.8, 1000);
      magicLight.position.set(0, 200, 0);
      scene.add(magicLight);

      // Suelo del jard√≠n m√≠stico
      const groundGeo = new THREE.CircleGeometry(1200, 64);
      const groundMat = new THREE.MeshStandardMaterial({ 
        color: 0x2d1b69, 
        roughness: 0.7,
        metalness: 0.1,
        transparent: true,
        opacity: 0.8
      });
      const ground = new THREE.Mesh(groundGeo, groundMat);
      ground.rotation.x = -Math.PI/2;
      ground.position.y = -200;
      scene.add(ground);

      // Crear luci√©rnagas (esferas brillantes que contienen las im√°genes)
      const fireflies = [];
      const firefliesGroup = new THREE.Group();
      scene.add(firefliesGroup);
      
      const loader = new THREE.TextureLoader();
      loader.setCrossOrigin('');

      function createFirefly(url, index) {
        // Luci√©rnaga (esfera exterior brillante)
        const glowGeo = new THREE.SphereGeometry(40, 32, 32);
        const glowMat = new THREE.MeshBasicMaterial({
          color: new THREE.Color().setHSL((index * 0.15) % 1, 0.7, 0.8),
          transparent: true,
          opacity: 0.3,
          side: THREE.DoubleSide
        });
        const glow = new THREE.Mesh(glowGeo, glowMat);

        // N√∫cleo interno con la imagen
        const coreGeo = new THREE.SphereGeometry(35, 32, 32);
        const coreMat = new THREE.MeshStandardMaterial({
          color: 0xffffff,
          emissive: new THREE.Color().setHSL((index * 0.15) % 1, 0.3, 0.1),
          roughness: 0.1,
          metalness: 0.8
        });
        const core = new THREE.Mesh(coreGeo, coreMat);

        // Plano con la imagen
        const imgGeo = new THREE.PlaneGeometry(60, 60);
        const imgMat = new THREE.MeshBasicMaterial({ 
          transparent: true, 
          opacity: 0.9,
          side: THREE.DoubleSide
        });
        const imgPlane = new THREE.Mesh(imgGeo, imgMat);
        imgPlane.position.z = 1;

        loader.load(url, (texture) => {
          imgMat.map = texture;
          imgMat.needsUpdate = true;
        });

        const firefly = new THREE.Group();
        firefly.add(glow);
        firefly.add(core);
        firefly.add(imgPlane);

        // Posici√≥n en espiral ascendente
        const angle = (index / 7) * Math.PI * 2;
        const radius = 300 + (index * 50);
        const x = Math.cos(angle) * radius;
        const z = Math.sin(angle) * radius;
        const y = -100 + (index * 80);

        firefly.position.set(x, y, z);
        firefly.userData = { 
          url, 
          index,
          originalY: y,
          phase: Math.random() * Math.PI * 2,
          glowMat,
          hue: (index * 0.15) % 1
        };

        firefliesGroup.add(firefly);
        fireflies.push(firefly);
        return firefly;
      }

      // Crear las 7 luci√©rnagas
      for (let i = 0; i < Math.min(7, imageUrls.length); i++) {
        createFirefly(imageUrls[i], i);
      }

      // Part√≠culas de luz m√°gica
      const particleCount = isMobile ? 800 : 1500;
      const particlesGeo = new THREE.BufferGeometry();
      const positions = new Float32Array(particleCount * 3);
      const colors = new Float32Array(particleCount * 3);
      const sizes = new Float32Array(particleCount);

      for (let i = 0; i < particleCount; i++) {
        // Posici√≥n aleatoria en el jard√≠n
        positions[i * 3] = (Math.random() - 0.5) * 2000;
        positions[i * 3 + 1] = Math.random() * 600 - 100;
        positions[i * 3 + 2] = (Math.random() - 0.5) * 2000;

        // Colores variados y m√°gicos
        const hue = Math.random();
        const color = new THREE.Color().setHSL(hue, 0.6, 0.8);
        colors[i * 3] = color.r;
        colors[i * 3 + 1] = color.g;
        colors[i * 3 + 2] = color.b;

        sizes[i] = Math.random() * 3 + 1;
      }

      particlesGeo.setAttribute('position', new THREE.BufferAttribute(positions, 3));
      particlesGeo.setAttribute('color', new THREE.BufferAttribute(colors, 3));
      particlesGeo.setAttribute('size', new THREE.BufferAttribute(sizes, 1));

      const particlesMat = new THREE.PointsMaterial({
        size: 2,
        transparent: true,
        opacity: 0.8,
        vertexColors: true,
        blending: THREE.AdditiveBlending,
        depthWrite: false
      });

      const particles = new THREE.Points(particlesGeo, particlesMat);
      scene.add(particles);

      // Sistema de interacci√≥n
      const raycaster = new THREE.Raycaster();
      const mouse = new THREE.Vector2();

      function onPointerMove(event) {
        const clientX = event.touches ? event.touches[0].clientX : event.clientX;
        const clientY = event.touches ? event.touches[0].clientY : event.clientY;
        
        mouse.x = (clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(clientY / window.innerHeight) * 2 + 1;

        // Mover la c√°mara suavemente
        const targetX = mouse.x * 200;
        const targetY = -mouse.y * 100 + 100;
        camera.position.x += (targetX - camera.position.x) * 0.02;
        camera.position.y += (targetY - camera.position.y) * 0.02;
      }

      function onClick(event) {
        const clientX = event.touches ? event.touches[0].clientX : event.clientX;
        const clientY = event.touches ? event.touches[0].clientY : event.clientY;
        
        mouse.x = (clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(clientY / window.innerHeight) * 2 + 1;

        raycaster.setFromCamera(mouse, camera);
        const intersects = raycaster.intersectObjects(firefliesGroup.children, true);

        if (intersects.length > 0) {
          let parent = intersects[0].object;
          while (parent.parent && parent.parent !== firefliesGroup) {
            parent = parent.parent;
          }
          
          if (parent.userData && parent.userData.url) {
            openPreview(parent.userData.url);
            
            // Animaci√≥n de click
            parent.scale.setScalar(1.3);
            setTimeout(() => {
              parent.scale.setScalar(1.0);
            }, 300);
          }
        }
      }

      renderer.domElement.addEventListener('mousemove', onPointerMove);
      renderer.domElement.addEventListener('touchmove', onPointerMove, { passive: true });
      renderer.domElement.addEventListener('click', onClick);
      renderer.domElement.addEventListener('touchend', onClick);

      // Modal de previsualizaci√≥n
      const previewModal = document.getElementById('previewModal');
      const previewImage = document.getElementById('previewImage');
      const previewClose = document.getElementById('previewClose');

      function openPreview(url) {
        previewImage.src = url;
        previewModal.style.display = 'flex';
        previewModal.setAttribute('aria-hidden', 'false');
      }

      function closePreview() {
        previewModal.style.display = 'none';
        previewImage.src = '';
        previewModal.setAttribute('aria-hidden', 'true');
      }

      previewClose.addEventListener('click', closePreview);
      previewModal.addEventListener('click', (e) => {
        if (e.target === previewModal) closePreview();
      });
      window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closePreview();
      });

      // Controles
      const toggleMode = document.getElementById('toggleMode');
      const rainbowBtn = document.getElementById('rainbowBtn');
      const returnBtn = document.getElementById('returnBtn');

      let nightMode = true;
      toggleMode.addEventListener('click', () => {
        nightMode = !nightMode;
        if (nightMode) {
          scene.background = new THREE.Color(0x0a0520);
          scene.fog.color = new THREE.Color(0x1a0b2e);
          toggleMode.textContent = '‚òÄÔ∏è Modo D√≠a';
        } else {
          scene.background = new THREE.Color(0x87ceeb);
          scene.fog.color = new THREE.Color(0xb0e0e6);
          toggleMode.textContent = 'üåô Modo Nocturno';
        }
      });

      let rainbowMode = false;
      rainbowBtn.addEventListener('click', () => {
        rainbowMode = !rainbowMode;
        rainbowBtn.textContent = rainbowMode ? 'üåü Normal' : 'üåà Arco√≠ris';
      });

      returnBtn.addEventListener('click', () => {
        window.parent.postMessage({ type: 'doorClosed' }, '*');
      });

      // Loop de animaci√≥n
      const clock = new THREE.Clock();

      function animate() {
        requestAnimationFrame(animate);
        const time = clock.getElapsedTime();

        // Animar luci√©rnagas
        fireflies.forEach((firefly, index) => {
          const userData = firefly.userData;
          
          // Movimiento flotante
          firefly.position.y = userData.originalY + Math.sin(time * 0.5 + userData.phase) * 30;
          firefly.rotation.y = time * 0.3;
          
          // Cambio de colores en modo arco√≠ris
          if (rainbowMode) {
            const hue = (time * 0.1 + index * 0.15) % 1;
            userData.glowMat.color.setHSL(hue, 0.7, 0.8);
          } else {
            userData.glowMat.color.setHSL(userData.hue, 0.7, 0.8);
          }

          // Efecto de respiraci√≥n del brillo
          userData.glowMat.opacity = 0.2 + Math.sin(time * 2 + userData.phase) * 0.15;
        });

        // Animar part√≠culas
        const positions = particles.geometry.attributes.position.array;
        for (let i = 0; i < particleCount; i++) {
          positions[i * 3 + 1] += Math.sin(time + i) * 0.1;
          
          if (positions[i * 3 + 1] > 600) {
            positions[i * 3 + 1] = -100;
          }
        }
        particles.geometry.attributes.position.needsUpdate = true;
        particles.rotation.y = time * 0.05;

        // Rotar suavemente la c√°mara
        camera.position.x = Math.sin(time * 0.05) * 50;
        camera.position.z = 800 + Math.cos(time * 0.03) * 100;
        camera.lookAt(0, 0, 0);

        // Luz m√°gica pulsante
        magicLight.intensity = 0.8 + Math.sin(time * 2) * 0.3;

        renderer.render(scene, camera);
      }

      animate();

      // Resize handler
      window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });

    })();
  </script>
</body>
</html>
