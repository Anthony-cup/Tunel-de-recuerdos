<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Puerta Romántica — Variante distinta</title>
  <style>
    :root{
      --accent1:#ffd6ee;
      --accent2:#ff79b4;
      --panel: rgba(255,255,255,0.03);
    }
    html,body{height:100%;margin:0;background:
      radial-gradient(900px 600px at 20% 12%, rgba(255,100,140,0.03), transparent 8%),
      linear-gradient(180deg,#120014,#020004);overflow:hidden;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;color:#fff}
    #canvas-container{width:100vw;height:100vh;position:relative;display:block;touch-action:none}
    #panel{position:absolute;left:14px;top:14px;z-index:300;padding:12px;border-radius:12px;background:linear-gradient(180deg,var(--panel), rgba(0,0,0,0.12));backdrop-filter:blur(6px);min-width:220px}
    #panel h3{margin:0 0 8px 0;color:var(--accent1);font-size:15px}
    #panel p{margin:0;font-size:13px;opacity:0.95}
    .controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    .btn, .btn-ghost{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:12px;border:0;cursor:pointer;font-weight:700;font-size:14px;transition:transform .12s}
    .btn{background:linear-gradient(180deg,var(--accent1),var(--accent2));color:#111}
    .btn:hover{transform:translateY(-3px)}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff}
    #credits{position:absolute;right:14px;bottom:14px;color:#ffdfe8;font-size:12px;z-index:250;padding:8px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(0,0,0,0.06))}
    #hint{position:absolute;left:50%;transform:translateX(-50%);bottom:18px;color:#ffdfe8;z-index:250;font-size:13px;padding:8px 14px;border-radius:999px;background:linear-gradient(90deg, rgba(255,130,190,0.04), rgba(255,220,190,0.03));backdrop-filter:blur(2px)}
    #previewModal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.95));z-index:600}
    #previewContent{max-width:94vw;max-height:92vh;padding:14px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));display:flex;flex-direction:column;gap:10px}
    #previewContent img{max-width:100%;max-height:82vh;border-radius:10px;display:block}
    #previewClose{align-self:flex-end;padding:8px 12px;border-radius:10px;border:0;background:linear-gradient(180deg,var(--accent1),var(--accent2));color:#111;cursor:pointer}
    #errorMessage{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:24px;text-align:center;color:#ffd6ee;text-shadow:0 0 10px #ffd6ee, 0 0 20px #ffd6ee;z-index:130;display:none}
    @media (max-width:720px){ #panel{left:10px;top:10px;padding:10px} .btn{padding:8px 10px} #hint{display:none} }
  </style>
</head>
<body>
  <div id="errorMessage">No creaste tu proyecto. Por favor, crea tu ID primero.</div>
  <div id="canvas-container" aria-hidden="false"></div>

  <div id="panel" role="region" aria-label="Controles">
    <h3>Puerta Romántica — Variante</h3>
    <p>Toca/arrastra para mirar. Pellizca para acercar/alejar. Formas cambian automáticamente.</p>
    <div class="controls">
      <button id="toggleAuto" class="btn" aria-pressed="true">Auto-rotar</button>
      <button id="nextShape" class="btn-ghost">Forma siguiente</button>
      <button id="returnBtn" class="btn-ghost">Regresar</button>
    </div>
  </div>

  <div id="credits">Imágenes desde Firebase • Interfaz romántica</div>
  <div id="hint">Pulsa una imagen para ampliar</div>

  <div id="previewModal" aria-hidden="true">
    <div id="previewContent"><button id="previewClose">Cerrar</button><img id="previewImage" src="" alt="Vista previa"></div>
  </div>

  <script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
    import { getDatabase, ref, get } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';
    const firebaseConfig = {
      apiKey: "AIzaSyBk2SVaP1w4V3MWrpp1r3X5Xk9eH06gBt4",
      authDomain: "tunel-de-recuerdos.firebaseapp.com",
      projectId: "tunel-de-recuerdos",
      storageBucket: "tunel-de-recuerdos.firebasestorage.app",
      messagingSenderId: "630660710506",
      appId: "1:630660710506:web:90d34150c9f21f668eca13",
      measurementId: "G-ETFDVEHML1"
    };
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    let imageUrls = [];
    async function fetchImages() {
      const errorMessage = document.getElementById('errorMessage');
      const urlParams = new URLSearchParams(window.location.search);
      const userId = urlParams.get('id')?.trim();
      console.log("ID extraído de la URL:", userId);
      if (!userId || userId === '') {
        console.error("No se encontró 'id' en la URL o es inválido.");
        errorMessage.textContent = 'No creaste tu proyecto. Por favor, crea tu ID primero.';
        errorMessage.style.display = 'block';
        return [];
      }
      try {
        console.log(`Consultando Firebase para usuarios/${userId}/puerta6Fotos`);
        const snapshot = await get(ref(database, `usuarios/${userId}`));
        if (snapshot.exists()) {
          const data = snapshot.val();
          const puertaFotos = data.puerta6Fotos || [];
          const validFotos = puertaFotos.slice(0, 5).filter(url => typeof url === 'string' && url.trim() !== '');
          console.log("Imágenes obtenidas de puerta6Fotos:", validFotos);
          if (validFotos.length === 0) {
            console.warn(`No hay imágenes en puerta6Fotos para el usuario ${userId}.`);
            errorMessage.textContent = 'No hay imágenes en tu galería. Agrega imágenes primero.';
            errorMessage.style.display = 'block';
          }
          return validFotos;
        } else {
          console.error(`No se encontraron datos para el usuario ${userId}.`);
          errorMessage.textContent = 'No creaste tu proyecto. Por favor, crea tu ID primero.';
          errorMessage.style.display = 'block';
          return [];
        }
      } catch (error) {
        console.error("Error al consultar Firebase:", error);
        errorMessage.textContent = 'Error al cargar las imágenes. Por favor, intenta de nuevo.';
        errorMessage.style.display = 'block';
        return [];
      }
    }
    (async function(){
      imageUrls = await fetchImages();
      console.log("Imágenes finales para la escena:", imageUrls);
      const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent) || window.innerWidth < 720;
      const TOTAL_IMAGES = 10;
      const PARTICLES = isMobile ? 300 : 700;
      const FRAME_W = isMobile ? 220 : 320;
      const FRAME_H = isMobile ? 150 : 210;

      const container = document.getElementById('canvas-container');
      const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
      renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1.5, 2));
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.domElement.style.display='block';
      renderer.domElement.style.touchAction='none';
      container.appendChild(renderer.domElement);

      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0x090015);
      scene.fog = new THREE.FogExp2(0x090015, 0.00012);

      const camera = new THREE.PerspectiveCamera(66, window.innerWidth/window.innerHeight, 0.1, 12000);
      let cameraRadius = isMobile ? 980 : 760;
      camera.position.set(0, 40, cameraRadius);

      scene.add(new THREE.HemisphereLight(0xffeef8, 0x050016, 0.6));
      scene.add(new THREE.AmbientLight(0xffeaf4, 0.18));
      const key = new THREE.PointLight(0xff9ecf, 0.9, 2500); key.position.set(700,260,300); scene.add(key);

      const floor = new THREE.Mesh(new THREE.PlaneGeometry(2600,2600), new THREE.MeshStandardMaterial({ color:0x03020a, roughness:0.18 }));
      floor.rotation.x = -Math.PI/2; floor.position.y = -420; scene.add(floor);
      const ring = new THREE.Mesh(new THREE.TorusGeometry(880, 12, 36, 260), new THREE.MeshStandardMaterial({ color:0xffb5dc, emissive:0xffb5dc, emissiveIntensity:0.06, roughness:0.45 }));
      ring.rotation.x = Math.PI/2; ring.position.y = -86; scene.add(ring);

      const imagesGroup = new THREE.Group(); scene.add(imagesGroup);
      const loader = new THREE.TextureLoader(); loader.setCrossOrigin('');
      function createFrame(url, pos, idx){
        const glow = new THREE.Mesh(new THREE.PlaneGeometry(FRAME_W*1.12, FRAME_H*1.12), new THREE.MeshBasicMaterial({ color:0xffcfe6, transparent:true, opacity:0.08, side:THREE.DoubleSide }));
        const frame = new THREE.Mesh(new THREE.BoxGeometry(FRAME_W*1.03, FRAME_H*1.04, 12), new THREE.MeshStandardMaterial({ color:0x1d1419, roughness:0.18, metalness:0.6 }));
        const imgMat = new THREE.MeshBasicMaterial({ color:0xffffff });
        const img = new THREE.Mesh(new THREE.PlaneGeometry(FRAME_W-14, FRAME_H-14), imgMat);
        const g = new THREE.Group();
        glow.position.set(0,8,-6); frame.position.set(0,0,-8); img.position.set(0,0,6);
        g.add(glow, frame, img);
        g.position.copy(pos);
        g.userData = { url, idx };
        loader.load(url, tex => { imgMat.map = tex; imgMat.needsUpdate = true; });
        imagesGroup.add(g);
        return g;
      }

      function arrangeImagesHeart(){
        while(imagesGroup.children.length) imagesGroup.remove(imagesGroup.children[0]);
        const total = TOTAL_IMAGES;
        for(let i=0;i<total;i++){
          const t = (i / total) * Math.PI * 2;
          const x = 16*Math.pow(Math.sin(t),3) * 24 + (Math.random()-0.5)*24;
          const y = (13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t)) * 14 - 120 + (Math.random()-0.5)*18;
          const z = Math.sin(t*2.4) * 220 + (Math.random()-0.5)*40;
          const url = imageUrls[i % imageUrls.length];
          createFrame(url, new THREE.Vector3(x, y, z), i);
        }
      }
      arrangeImagesHeart();

      const starsCount = isMobile ? 300 : 700;
      const starsGeo = new THREE.BufferGeometry();
      const starsPos = new Float32Array(starsCount*3);
      for(let i=0;i<starsCount;i++){
        const r = 400 + Math.random()*2000;
        const theta = Math.random()*Math.PI*2;
        const phi = Math.acos(2*Math.random()-1);
        starsPos[i*3] = Math.sin(phi)*Math.cos(theta)*r;
        starsPos[i*3+1] = Math.sin(phi)*Math.sin(theta)*r*0.55;
        starsPos[i*3+2] = Math.cos(phi)*r;
      }
      starsGeo.setAttribute('position', new THREE.BufferAttribute(starsPos,3));
      const stars = new THREE.Points(starsGeo, new THREE.PointsMaterial({ size:isMobile?2.0:3.0, color:0xffffff, opacity:0.9, transparent:true }));
      scene.add(stars);

      const ptsGeo = new THREE.BufferGeometry();
      const posArr = new Float32Array(PARTICLES*3);
      for(let i=0;i<PARTICLES;i++){
        posArr[i*3] = (Math.random()-0.5)*2200;
        posArr[i*3+1] = -80 + Math.random()*420;
        posArr[i*3+2] = (Math.random()-0.5)*2200;
      }
      ptsGeo.setAttribute('position', new THREE.BufferAttribute(posArr,3));

      const sprite = (() => {
        const c = document.createElement('canvas'); c.width=64; c.height=64; const cx = c.getContext('2d');
        const g = cx.createRadialGradient(32,32,2,32,32,32);
        g.addColorStop(0,'rgba(255,220,240,1)'); g.addColorStop(1,'rgba(255,220,240,0)');
        cx.fillStyle = g; cx.fillRect(0,0,64,64);
        return new THREE.CanvasTexture(c);
      })();

      const ptsMat = new THREE.PointsMaterial({ size:isMobile?5:7, map:sprite, transparent:true, blending:THREE.AdditiveBlending, depthWrite:false, opacity:0.95 });
      const particles = new THREE.Points(ptsGeo, ptsMat
