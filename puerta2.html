<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Galería Romántica — 2D</title>
  <style>
    :root{
      --bg-1: #050006;
      --bg-2: #1b0a1a;
      --card-bg: rgba(255,255,255,0.03);
      --accent-a: #ffd1e6;
      --accent-b: #a6f0ff;
      --glass: rgba(255,255,255,0.04);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;color:#fff;background:linear-gradient(180deg,var(--bg-1),var(--bg-2));-webkit-font-smoothing:antialiased}

    /* full canvas hearts / bokeh */
    .bg-layers{position:fixed;inset:0;pointer-events:none;z-index:0}
    .bokeh{position:absolute;filter:blur(36px);opacity:0.12}
    .bokeh.b1{width:680px;height:420px;left:-10%;top:5%;background:radial-gradient(circle at 20% 30%, #ffd1e6 0%, transparent 40%), radial-gradient(circle at 80% 70%, #a6f0ff 0%, transparent 35%)}
    .bokeh.b2{width:420px;height:320px;right:-6%;bottom:6%;background:radial-gradient(circle at 30% 40%, #ffb3d1 0%, transparent 40%)}

    /* overlay controls */
    .overlay{position:fixed;left:14px;top:14px;z-index:40;background:linear-gradient(180deg,var(--glass),transparent);padding:10px;border-radius:12px;backdrop-filter: blur(6px);box-shadow:0 8px 30px rgba(0,0,0,0.6)}
    .overlay h2{margin:0;font-size:14px;color:var(--accent-a);letter-spacing:0.2px}
    .overlay p{margin:6px 0 0 0;font-size:12px;opacity:0.9}
    .controls{display:flex;gap:8px;margin-top:8px}
    .btn{padding:8px 12px;border-radius:12px;border:0;font-weight:700;cursor:pointer;background:linear-gradient(180deg,#ffc8e0,#9ff3ff);color:#111;box-shadow:0 10px 30px rgba(160,160,200,0.06)}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff;padding:8px 12px;border-radius:12px}

    /* gallery container */
    .wrap{position:relative;z-index:10;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:40px}
    .gallery{width:min(1100px,96vw);display:grid;grid-template-columns:repeat(4,1fr);grid-auto-rows:220px;gap:18px;justify-items:center;align-items:center}

    /* make exactly 7 slots but responsive */
    .card{width:100%;height:100%;max-width:360px;max-height:260px;position:relative;border-radius:14px;overflow:visible;display:flex;align-items:center;justify-content:center}
    .polaroid{position:relative;width:100%;height:100%;border-radius:12px;background:var(--card-bg);backdrop-filter: blur(4px);box-shadow:0 12px 40px rgba(0,0,0,0.6);transform-origin:center;transition:transform .28s cubic-bezier(.2,.9,.3,1),box-shadow .28s}
    .polaroid img{width:100%;height:100%;object-fit:cover;border-radius:10px;display:block}
    .polaroid::after{content:'';position:absolute;left:10px;right:10px;bottom:6px;height:10px;border-radius:6px;background:linear-gradient(90deg, rgba(255,255,255,0.06), rgba(0,0,0,0.06));opacity:0.8}

    /* gentle float animation and small rotations to feel romantic */
    @keyframes floaty{0%{transform:translateY(0) rotate(var(--rot))}50%{transform:translateY(var(--float)) rotate(calc(var(--rot) + 1deg))}100%{transform:translateY(0) rotate(var(--rot))}}
    .polaroid{animation:floaty var(--dur) ease-in-out infinite}

    /* focus/hover */
    .polaroid:hover{transform:translateY(-10px) scale(1.03);box-shadow:0 30px 70px rgba(0,0,0,0.6)}

    /* center one larger on small screens */
    @media (max-width:900px){
      .gallery{grid-template-columns:repeat(2,1fr);grid-auto-rows:200px;gap:14px}
    }
    @media (max-width:520px){
      .gallery{grid-template-columns:repeat(1,1fr);gap:12px}
      .wrap{padding:18px}
    }

    /* modal preview */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(0,0,0,0.6),rgba(0,0,0,0.95));z-index:80;padding:20px}
    .modal.show{display:flex}
    .modal img{max-width:94vw;max-height:86vh;border-radius:14px;box-shadow:0 30px 80px rgba(0,0,0,0.8)}
    .modal .close{position:absolute;right:24px;top:18px;background:linear-gradient(180deg,#ffc8e0,#9ff3ff);border:0;padding:8px 12px;border-radius:10px;font-weight:700;color:#111;cursor:pointer}

    /* small hearts floating */
    .hearts{position:fixed;right:18px;bottom:18px;z-index:30;pointer-events:none}

    /* fireworks canvas */
    #fxCanvas{position:fixed;left:0;top:0;width:100%;height:100%;z-index:50;pointer-events:none}

    /* credits */
    .credits{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;z-index:40;font-size:12px;padding:8px 12px;border-radius:999px;background:linear-gradient(90deg,rgba(255,255,255,0.02),transparent);color:#ffdfe8}
  </style>
</head>
<body>
  <div class="bg-layers" aria-hidden="true">
    <div class="bokeh b1"></div>
    <div class="bokeh b2"></div>
  </div>

  <div class="overlay" role="region" aria-label="Controles">
    <h2>Galería Romántica — 2D</h2>
    <p>7 imágenes, estilo polaroid, táctil y fluido en móvil</p>
    <div class="controls">
      <button id="backBtn" class="btn-ghost">Regresar</button>
      <button id="surpriseBtn" class="btn">Sorpresa</button>
    </div>
  </div>

  <main class="wrap">
    <section class="gallery" id="gallery" aria-label="Galería de imágenes">
      <!-- 7 tarjetas se insertan desde JS -->
    </section>
  </main>

  <div class="credits">Toca para ampliar • Toque largo para guardar</div>

  <div class="modal" id="modal" aria-hidden="true">
    <button class="close" id="closeModal">Cerrar</button>
    <img id="modalImg" src="" alt="Vista ampliada" />
  </div>

  <canvas id="fxCanvas"></canvas>
  <div class="hearts" id="hearts" aria-hidden="true"></div>

  <script>
    /* --------- CONFIGURA AQUÍ TUS 7 URLS ----------
       Reemplaza estos URLs por los tuyos (Firebase, Storage, etc.).
       Asegúrate de tener exactamente 7 URL en el array. */
    const imageUrls = [
      'https://picsum.photos/900/640?random=101',
      'https://picsum.photos/900/640?random=102',
      'https://picsum.photos/900/640?random=103',
      'https://picsum.photos/900/640?random=104',
      'https://picsum.photos/900/640?random=105',
      'https://picsum.photos/900/640?random=106',
      'https://picsum.photos/900/640?random=107'
    ];

    // seguridad: si el usuario dejó menos de 7, compensar repitiendo
    while(imageUrls.length < 7) imageUrls.push(imageUrls[imageUrls.length % imageUrls.length || 0]);

    const gallery = document.getElementById('gallery');
    const modal = document.getElementById('modal');
    const modalImg = document.getElementById('modalImg');
    const closeModal = document.getElementById('closeModal');

    // crea las 7 cards con ligeras rotaciones y animaciones distintas
    function buildGallery(){
      gallery.innerHTML = '';
      for(let i=0;i<7;i++){
        const wrap = document.createElement('div'); wrap.className = 'card';
        const pol = document.createElement('div'); pol.className = 'polaroid';
        // variables CSS custom para cada card
        const rot = (Math.random()*12 - 6).toFixed(2) + 'deg';
        const floatAmt = (6 + Math.random()*12) + 'px';
        const dur = (6 + Math.random()*6) + 's';
        pol.style.setProperty('--rot', rot);
        pol.style.setProperty('--float', floatAmt);
        pol.style.setProperty('--dur', dur);

        const img = document.createElement('img'); img.alt = `Foto ${i+1}`;
        img.loading = 'lazy';
        img.src = imageUrls[i % imageUrls.length];
        img.addEventListener('error', ()=>{ img.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="900" height="640"><rect width="100%" height="100%" fill="#2b1b1f"/></svg>' });

        // tap to open preview
        img.addEventListener('click', ()=> openModal(img.src));

        // long-press to save on mobile
        let pressTimer = null;
        img.addEventListener('touchstart', (e)=>{ pressTimer = setTimeout(()=>{ saveImage(img.src); }, 700); });
        img.addEventListener('touchend', ()=>{ clearTimeout(pressTimer); });

        pol.appendChild(img);
        wrap.appendChild(pol);
        gallery.appendChild(wrap);
      }
    }

    function openModal(src){ modalImg.src = src; modal.classList.add('show'); modal.setAttribute('aria-hidden','false'); }
    function close(){ modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); modalImg.src = ''; }
    closeModal.addEventListener('click', close);
    modal.addEventListener('click', (e)=>{ if(e.target === modal) close(); });
    document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') close(); });

    function saveImage(src){ const a = document.createElement('a'); a.href = src; a.download = 'imagen'; document.body.appendChild(a); a.click(); a.remove(); }

    // BACK button behavior: postMessage (igual que tu versión anterior)
    document.getElementById('backBtn').addEventListener('click', ()=>{ window.parent.postMessage({ type: 'doorClosed' }, '*'); });

    // Sorpresa -> dispara fuegos artificiales + corazones
    const fxCanvas = document.getElementById('fxCanvas');
    const ctx = fxCanvas.getContext('2d');
    let W = fxCanvas.width = innerWidth; let H = fxCanvas.height = innerHeight;
    window.addEventListener('resize', ()=>{ W = fxCanvas.width = innerWidth; H = fxCanvas.height = innerHeight; });

    // simple fireworks particle system
    const particles = [];
    function rand(mn,mx){ return Math.random()*(mx-mn)+mn }
    function launchFirework(x,y){
      const count = 26 + Math.floor(Math.random()*20);
      const hue = Math.floor(rand(320,20))||340;
      for(let i=0;i<count;i++){
        const a = Math.random()*Math.PI*2;
        const s = rand(2,6);
        particles.push({ x, y, vx: Math.cos(a)*s, vy: Math.sin(a)*s, life: rand(0.7,1.5), age:0, hue });
      }
    }

    function tickFX(dt){
      ctx.clearRect(0,0,W,H);
      for(let i=particles.length-1;i>=0;i--){
        const p = particles[i]; p.age += dt;
        if(p.age >= p.life){ particles.splice(i,1); continue; }
        p.vy += 0.06; p.vx *= 0.997; p.vy *= 0.998; p.x += p.vx; p.y += p.vy;
        const t = p.age / p.life;
        ctx.globalCompositeOperation = 'lighter';
        ctx.fillStyle = `hsla(${p.hue},85%,65%,${1 - t})`;
        ctx.beginPath(); ctx.arc(p.x, p.y, 2.4*(1 - t) + 0.8, 0, Math.PI*2); ctx.fill();
      }
    }

    let lastFX = performance.now();
    function loop(){
      const now = performance.now(); const dt = (now - lastFX)/1000; lastFX = now;
      tickFX(dt);
      requestAnimationFrame(loop);
    }
    loop();

    // hearts floating (DOM) — pequeño efecto romántico que aparece al apretar Sorpresa
    function spawnHearts(){
      const container = document.getElementById('hearts');
      for(let i=0;i<12;i++){
        const el = document.createElement('div');
        el.style.width = el.style.height = (8 + Math.random()*22) + 'px';
        el.style.opacity = 0.9;
        el.style.marginBottom = '6px';
        el.style.transform = `translateY(0)`;
        el.style.transition = `transform ${3 + Math.random()*1.6}s cubic-bezier(.2,.8,.2,1), opacity 1.6s`;
        el.innerHTML = '❤';
        el.style.fontSize = el.style.width;
        el.style.pointerEvents = 'none';
        el.style.display = 'block';
        el.style.filter = 'drop-shadow(0 4px 12px rgba(0,0,0,0.45))';
        container.appendChild(el);
        setTimeout(()=>{ el.style.transform = `translateY(-${200 + Math.random()*320}px) translateX(${(Math.random()-0.5)*120}px) rotate(${(Math.random()-0.5)*40}deg)`; el.style.opacity = 0; }, 80 + i*40);
        setTimeout(()=> el.remove(), 4200 + Math.random()*900);
      }
    }

    const surpriseBtn = document.getElementById('surpriseBtn');
    surpriseBtn.addEventListener('click', ()=>{
      // lanzar 3 fuegos artificiales en posiciones distintas
      for(let i=0;i<3;i++){
        const x = rand(innerWidth*0.2, innerWidth*0.8);
        const y = rand(innerHeight*0.2, innerHeight*0.5);
        launchFirework(x,y);
      }
      spawnHearts();
    });

    // --- Auto-run "Sorpresa" effects periodically (automatic, as requested) ---
    function triggerSurprise(){
      for(let i=0;i<3;i++){
        const x = rand(innerWidth*0.2, innerWidth*0.8);
        const y = rand(innerHeight*0.18, innerHeight*0.52);
        launchFirework(x,y);
      }
      spawnHearts();
    }
    // run once immediately on load
    setTimeout(triggerSurprise, 900);
    // then run periodically every 12-18 seconds with a small jitter
    let _surpriseInterval = setInterval(()=>{ triggerSurprise(); }, 12000 + Math.floor(Math.random()*6000));

    // small parallax for pointer move to give dynamic 2D feeling
    window.addEventListener('pointermove', (e)=>{
      const cx = innerWidth/2, cy = innerHeight/2;
      const dx = (e.clientX - cx)/cx; const dy = (e.clientY - cy)/cy;
      document.querySelectorAll('.polaroid').forEach((p,idx)=>{
        const depth = (idx%3) * 6 + 6;
        p.style.transform = `translateZ(0) translateY(${(Math.sin(idx + performance.now()*0.0008)*4)}px) rotate(${p.style.getPropertyValue('--rot')}) translateX(${dx*depth}px) translateY(${dy*depth*0.5}px)`;
      });
    }, {passive:true});

    // inicializar
    buildGallery();

    // accesibilidad: permitir foco y abrir con Enter
    gallery.addEventListener('keydown', (e)=>{ if(e.key === 'Enter' && e.target && e.target.querySelector('img')){ openModal(e.target.querySelector('img').src); } });

    /* Si quieres conectar esto a Firebase: en tu versión actual ya tienes config.
       Reemplaza el array imageUrls por la lectura desde RTDB o Storage y luego llama buildGallery(). */
  </script>
</body>
</html>
