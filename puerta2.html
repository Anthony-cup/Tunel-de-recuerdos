<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Galería Romántica — Móvil (estética TikTok-like)</title>
  <style>
    :root{
      --bg-1:#040006; --bg-2:#12041a; --accent-a:#ffd1e6; --accent-b:#a6f0ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial;color:#fff;background:linear-gradient(180deg,var(--bg-1),var(--bg-2));-webkit-font-smoothing:antialiased;touch-action:manipulation}

    /* cinematic vignette + soft film grain */
    body::before{content:'';position:fixed;inset:0;z-index:1;pointer-events:none;background:radial-gradient(ellipse at center, rgba(0,0,0,0) 30%, rgba(0,0,0,0.45) 80%);} 
    body::after{content:'';position:fixed;inset:0;z-index:2;pointer-events:none;background-image:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);mix-blend-mode:overlay;}

    .bg-layers{position:fixed;inset:0;pointer-events:none;z-index:0}
    .bokeh{position:absolute;filter:blur(44px);opacity:0.14}
    .bokeh.b1{width:560px;height:340px;left:-6%;top:4%;background:radial-gradient(circle at 20% 30%, #ffd1e6 0%, transparent 40%), radial-gradient(circle at 80% 70%, #a6f0ff 0%, transparent 35%)}
    .bokeh.b2{width:420px;height:300px;right:-6%;bottom:6%;background:radial-gradient(circle at 30% 40%, #ffb3d1 0%, transparent 40%)}

    .overlay{position:fixed;left:12px;top:12px;z-index:120;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);padding:10px;border-radius:12px;backdrop-filter:blur(6px);box-shadow:0 8px 30px rgba(0,0,0,0.6)}
    .overlay h2{margin:0;font-size:14px;color:var(--accent-a)} .overlay p{margin:6px 0 0 0;font-size:12px;opacity:0.9}
    .controls{display:flex;gap:8px;margin-top:8px}
    .btn{padding:8px 12px;border-radius:12px;border:0;font-weight:700;cursor:pointer;background:linear-gradient(180deg,#ffc8e0,#9ff3ff);color:#111;box-shadow:0 10px 30px rgba(160,160,200,0.06)}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff;padding:8px 12px;border-radius:12px}

    .wrap{position:relative;z-index:110;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px}
    .gallery{width:100%;max-width:980px;display:grid;grid-template-columns:repeat(2,1fr);grid-auto-rows:220px;gap:12px;justify-items:center;align-items:center}
    @media(min-width:720px){ .gallery{grid-template-columns:repeat(4,1fr);gap:18px} }

    .card{width:100%;height:100%;max-width:420px;max-height:320px;position:relative;border-radius:18px;overflow:visible;display:flex;align-items:center;justify-content:center}

    /* POLAROID LOOK with cinematic overlay */
    .polaroid{position:relative;width:100%;height:100%;border-radius:16px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06));backdrop-filter:blur(4px);box-shadow:0 20px 60px rgba(0,0,0,0.6);overflow:hidden;transform-origin:center}
    .polaroid .frame{position:absolute;inset:0;border-radius:14px;padding:8px;display:flex;align-items:center;justify-content:center}
    .polaroid img{width:100%;height:100%;object-fit:cover;border-radius:10px;display:block;transform-origin:center center;will-change:transform,filter}

    /* soft gloss / light sweep */
    .polaroid::before{content:'';position:absolute;left:-30%;top:-30%;width:60%;height:160%;background:linear-gradient(120deg, rgba(255,255,255,0.04), rgba(255,255,255,0.1) 40%, rgba(255,255,255,0.04));transform:rotate(18deg);opacity:0.0;pointer-events:none;mix-blend-mode:screen}

    /* cinematic kenburns and tiktok-like swipe pulse loop */
    @keyframes kenburns-pan{
      0%{ transform:scale(1) translate(0px,0px); filter:contrast(1) saturate(1)}
      45%{ transform:scale(1.06) translate(-6px,-10px); filter:contrast(1.04) saturate(1.06)}
      100%{ transform:scale(1) translate(0px,0px); filter:contrast(1) saturate(1)}
    }

    /* gentle glow pulse for outer frame */
    @keyframes glowPulse{ 0%{ box-shadow:0 20px 60px rgba(200,150,200,0.06)} 50%{ box-shadow:0 30px 110px rgba(255,160,200,0.12)} 100%{ box-shadow:0 20px 60px rgba(200,150,200,0.06)} }
    .polaroid{animation:glowPulse 5.6s ease-in-out infinite}

    /* romantic-loop class will run Ken Burns on images (infinite) */
    .romantic-loop img{ animation-name: kenburns-pan; animation-iteration-count: infinite; animation-timing-function: ease-in-out; will-change: transform, filter }

    /* focused style */
    .polaroid.focused{transform:scale(1.06);z-index:200}

    /* accessibility / mobile adjustments */
    @media (hover:none){ .polaroid:hover{ transform:none } }

    /* modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(0,0,0,0.6),rgba(0,0,0,0.95));z-index:1000;padding:18px}
    .modal.show{display:flex}
    .modal .content{max-width:94vw;max-height:86vh;border-radius:14px;display:flex;flex-direction:column;align-items:center;gap:12px}
    .modal img{max-width:94vw;max-height:80vh;border-radius:14px;box-shadow:0 30px 80px rgba(0,0,0,0.8);transition:transform .45s}
    .modal .controls{display:flex;gap:8px}
    .modal .save{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:10px;color:#fff}

    /* hearts container small */
    .hearts{position:fixed;right:12px;bottom:12px;z-index:220;pointer-events:none}
    #fxCanvas{position:fixed;left:0;top:0;width:100%;height:100%;z-index:210;pointer-events:none}

    .credits{position:fixed;left:50%;transform:translateX(-50%);bottom:12px;z-index:120;font-size:12px;padding:8px 12px;border-radius:999px;background:linear-gradient(90deg,rgba(255,255,255,0.02),transparent);color:#ffdfe8}
    #loaderOverlay{font-family:inherit}
  </style>
</head>
<body>
  <div class="bg-layers" aria-hidden="true"><div class="bokeh b1"></div><div class="bokeh b2"></div></div>

  <div class="overlay" role="region" aria-label="Controles">
    <h2>Galería Romántica</h2>
    <p>Animaciones automáticas estilo corto romántico (pensado para celular)</p>
    <div class="controls"><button id="backBtn" class="btn-ghost">Regresar</button><button id="surpriseBtn" class="btn">Sorpresa</button></div>
  </div>

  <main class="wrap"><section class="gallery" id="gallery" aria-label="Galería de imágenes"></section></main>

  <div class="credits">Toca para ampliar • Animación automática en bucle</div>

  <div class="modal" id="modal" aria-hidden="true"><div class="content"><div style="display:flex;gap:8px;align-items:center;width:100%;justify-content:flex-end"><button class="save" id="closeModal">Cerrar</button></div><img id="modalImg" src="" alt="Vista ampliada" /><div class="controls"><button class="save" id="downloadBtn">Guardar</button></div></div></div>

  <canvas id="fxCanvas"></canvas>
  <div class="hearts" id="hearts" aria-hidden="true"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
    import { getDatabase, ref, get } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBk2SVaP1w4V3MWrpp1r3X5Xk9eH06gBt4",
      authDomain: "tunel-de-recuerdos.firebaseapp.com",
      projectId: "tunel-de-recuerdos",
      storageBucket: "tunel-de-recuerdos.firebasestorage.app",
      messagingSenderId: "630660710506",
      appId: "1:630660710506:web:90d34150c9f21f668eca13",
      measurementId: "G-ETFDVEHML1"
    };
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    const gallery = document.getElementById('gallery');
    const modal = document.getElementById('modal'); const modalImg = document.getElementById('modalImg'); const closeModal = document.getElementById('closeModal'); const downloadBtn = document.getElementById('downloadBtn');

    let galleryData = []; let currentModalIndex = null;
    const isTouch = ('ontouchstart' in window) || navigator.maxTouchPoints > 0 || /Mobi/i.test(navigator.userAgent);

    // loader
    const loader = document.createElement('div'); loader.id='loaderOverlay'; loader.innerHTML = `<div style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:400;background:linear-gradient(180deg,rgba(0,0,0,0.35),rgba(0,0,0,0.6));"><div style="width:min(720px,90vw);max-width:720px;padding:18px;border-radius:14px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));backdrop-filter:blur(6px);text-align:center;color:#ffdfe8;box-shadow:0 30px 80px rgba(0,0,0,0.6);"><div style="font-weight:800;font-size:18px;margin-bottom:8px;color:var(--accent-a);">Cargando galería romántica</div><div style="font-size:13px;opacity:0.9;margin-bottom:12px">Preparando tus imágenes y efectos…</div><div style="height:12px;background:rgba(255,255,255,0.06);border-radius:999px;overflow:hidden;margin:10px 24px"><div id="loaderBar" style="width:0%;height:100%;background:linear-gradient(90deg,var(--accent-b),var(--accent-a));transition:width .3s ease;"></div></div><div id="loaderPct" style="font-size:13px;opacity:0.95;margin-top:8px">0%</div></div></div>`; document.body.appendChild(loader);
    function updateLoader(pct){ const bar=document.getElementById('loaderBar'); const pctEl=document.getElementById('loaderPct'); if(bar) bar.style.width=pct+'%'; if(pctEl) pctEl.textContent=Math.round(pct)+'%'; } function hideLoader(){ loader.remove(); }

    async function fetchImagesFromFirebase(userId){ try{ const snap = await get(ref(database, `usuarios/${userId}`)); if(!snap.exists()) return []; const data = snap.val(); const arr = data.puerta2Fotos || data.puertaFotos || data.fotos || data.images || []; if(!Array.isArray(arr)) return []; return arr.filter(u=>typeof u==='string'&&u.trim()); }catch(err){ console.error('Error leyendo Firebase:', err); return []; } }

    function preloadImages(urls,onProgress){ return new Promise((resolve)=>{ const loaded=[]; let done=0; const total=urls.length||0; if(total===0){ onProgress(100); resolve(loaded); return;} urls.forEach((u,idx)=>{ const img=new Image(); img.crossOrigin='anonymous'; img.onload=()=>{ done++; onProgress(done/total*100); loaded.push(u); if(done===total) resolve(loaded); }; img.onerror=()=>{ done++; onProgress(done/total*100); loaded.push(u); if(done===total) resolve(loaded); }; img.src=u; }); }); }

    // build gallery with TikTok-like continuous animation
    function buildGalleryWithUrls(urls){ const final=[]; if(urls.length===0) return final; let i=0; while(final.length<7){ final.push(urls[i%urls.length]); i++; } galleryData = final.slice(); gallery.innerHTML='';
      for(let j=0;j<7;j++){ const wrap=document.createElement('div'); wrap.className='card'; const pol=document.createElement('div'); pol.className='polaroid romantic-loop'; const frame=document.createElement('div'); frame.className='frame'; const img=document.createElement('img'); img.alt=`Foto ${j+1}`; img.loading='lazy'; img.src=final[j]; img.dataset.index=j; img.addEventListener('error',()=>{ img.src='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="900" height="640"><rect width="100%" height="100%" fill="#2b1b1f"/></svg>' });
        // randomize kenburns timing per image to avoid sync
        const loopDur = 6000 + Math.floor(Math.random()*4000); img.style.animationDuration = loopDur+'ms'; img.style.animationDelay = Math.floor(Math.random()*800)+'ms'; img.classList.add('kb');
        frame.appendChild(img); pol.appendChild(frame); wrap.appendChild(pol); gallery.appendChild(wrap);

        // apply Web Animations Ken Burns for smoother mobile GPU-accelerated loop
        const from = { transform: 'scale(1) translate(0px,0px)', filter: 'contrast(1) saturate(1)' };
        const to = { transform: 'scale(1.06) translate(-6px,-10px)', filter: 'contrast(1.04) saturate(1.06)' };
        img.animate([from, to, from], { duration: loopDur, iterations: Infinity, easing: 'ease-in-out', delay: Math.floor(Math.random()*500) });

        // subtle halo glow (frame) using WAAPI
        pol.animate([{ boxShadow: '0 18px 46px rgba(0,0,0,0.6)' },{ boxShadow: '0 28px 110px rgba(255,150,200,0.12)' },{ boxShadow: '0 18px 46px rgba(0,0,0,0.6)' }], { duration: 5600+Math.floor(Math.random()*2400), iterations: Infinity, easing: 'ease-in-out', delay: j*120 });

        // subtle parallax using deviceorientation if available (mobile) fall back to tiny loop
        if(window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission === 'function'){
          // on iOS 13+ must request permission — skip automatic here, we rely on loop motion
        }
      }

      // entrance stagger
      Array.from(document.querySelectorAll('.polaroid')).forEach((p,idx)=>{ p.style.opacity=0; p.style.transform='translateY(12px)'; setTimeout(()=>{ p.style.transition='opacity .7s ease, transform .7s cubic-bezier(.2,.9,.3,1)'; p.style.opacity=1; p.style.transform=''; }, 90+idx*80); });
      _focusIdx=0; cycleFocus(); }

    function openModal(index){ currentModalIndex=index; modalImg.src=galleryData[index]; modal.classList.add('show'); modal.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; if(window._surpriseInterval) clearInterval(window._surpriseInterval); }
    function close(){ modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); modalImg.src=''; document.body.style.overflow=''; if(window._surpriseInterval) clearInterval(window._surpriseInterval); window._surpriseInterval=setInterval(()=>{ triggerSurprise(); }, 12000+Math.floor(Math.random()*6000)); }
    closeModal.addEventListener('click',close); modal.addEventListener('click',(e)=>{ if(e.target===modal) close(); }); document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') close(); });
    function saveImage(src){ const a=document.createElement('a'); a.href=src; a.download='imagen'; document.body.appendChild(a); a.click(); a.remove(); } downloadBtn.addEventListener('click',()=>{ if(modalImg.src) saveImage(modalImg.src); });

    // improved FX (hearts + fireworks) — automatic loop
    const fxCanvas=document.getElementById('fxCanvas'); const ctx=fxCanvas.getContext('2d'); let W=fxCanvas.width=innerWidth; let H=fxCanvas.height=innerHeight; window.addEventListener('resize',()=>{ W=fxCanvas.width=innerWidth; H=fxCanvas.height=innerHeight; }); const particles=[]; function rand(mn,mx){ return Math.random()*(mx-mn)+mn }
    function launchFirework(x,y){ const count=18+Math.floor(Math.random()*24); const hue=Math.floor(rand(320,20))||340; for(let i=0;i<count;i++){ const a=Math.random()*Math.PI*2; const s=rand(2,6); particles.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:rand(0.9,1.6),age:0,hue}); } }
    function tickFX(dt){ ctx.clearRect(0,0,W,H); for(let i=particles.length-1;i>=0;i--){ const p=particles[i]; p.age+=dt; if(p.age>=p.life){ particles.splice(i,1); continue;} p.vy+=0.06; p.vx*=0.997; p.vy*=0.998; p.x+=p.vx; p.y+=p.vy; const t=p.age/p.life; ctx.globalCompositeOperation='lighter'; ctx.fillStyle=`hsla(${p.hue},85%,65%,${1-t})`; ctx.beginPath(); ctx.arc(p.x,p.y,2.4*(1-t)+0.8,0,Math.PI*2); ctx.fill(); } }
    let lastFX=performance.now(); function loopFX(){ const now=performance.now(); const dt=(now-lastFX)/1000; lastFX=now; tickFX(dt); requestAnimationFrame(loopFX); } loopFX();
    function spawnHearts(){ const container=document.getElementById('hearts'); for(let i=0;i<8;i++){ const el=document.createElement('div'); el.style.width=el.style.height=(10+Math.random()*18)+'px'; el.style.opacity=0.95; el.style.marginBottom='6px'; el.style.transform='translateY(0)'; el.style.transition=`transform ${3+Math.random()*1.6}s cubic-bezier(.2,.8,.2,1), opacity 1.6s`; el.innerHTML='❤'; el.style.fontSize=el.style.width; el.style.pointerEvents='none'; el.style.display='block'; el.style.filter='drop-shadow(0 6px 14px rgba(0,0,0,0.45))'; container.appendChild(el); setTimeout(()=>{ el.style.transform=`translateY(-${160+Math.random()*220}px) translateX(${(Math.random()-0.5)*120}px) rotate(${(Math.random()-0.5)*40}deg)`; el.style.opacity=0; }, 80+i*60); setTimeout(()=>el.remove(),3600+Math.random()*900); } }

    const surpriseBtn=document.getElementById('surpriseBtn'); surpriseBtn.addEventListener('click',()=>{ for(let i=0;i<3;i++){ const x=rand(innerWidth*0.2,innerWidth*0.8); const y=rand(innerHeight*0.2,innerHeight*0.5); launchFirework(x,y);} spawnHearts(); }); function triggerSurprise(){ for(let i=0;i<3;i++){ const x=rand(innerWidth*0.2,innerWidth*0.8); const y=rand(innerHeight*0.18,innerHeight*0.52); launchFirework(x,y);} spawnHearts(); }
    setTimeout(triggerSurprise,900); window._surpriseInterval=setInterval(()=>{ triggerSurprise(); }, 12000+Math.floor(Math.random()*6000));

    // slideshow focus (mobile-friendly)
    let _focusIdx=0; function focusOn(idx){ document.querySelectorAll('.polaroid').forEach((p,i)=>{ p.classList.toggle('focused', i===idx); }); }
    function cycleFocus(){ focusOn(_focusIdx); _focusIdx=(_focusIdx+1)%7; }
    let _slideshowHandle = setInterval(cycleFocus,5200); let interactionTimeout=null; function pauseSlideshow(){ clearInterval(_slideshowHandle); } function resumeSlideshow(){ clearInterval(_slideshowHandle); _slideshowHandle=setInterval(cycleFocus,5200); }
    document.addEventListener('touchstart',()=>{ pauseSlideshow(); if(interactionTimeout) clearTimeout(interactionTimeout); },{passive:true}); document.addEventListener('touchend',()=>{ if(interactionTimeout) clearTimeout(interactionTimeout); interactionTimeout=setTimeout(()=>{ resumeSlideshow(); },2000); },{passive:true});

    function triggerReplace(index){ /* removed: reemplazo por diseño (persistencia no permitida aquí) */ }

    (async function init(){ const urlParams=new URLSearchParams(window.location.search); const userId=urlParams.get('id')?.trim(); let dbUrls=[]; if(userId) dbUrls=await fetchImagesFromFirebase(userId); if(!dbUrls||dbUrls.length===0){ dbUrls=['https://picsum.photos/900/640?random=201','https://picsum.photos/900/640?random=202']; }
      updateLoader(8); const uniqueUrls=Array.from(new Set(dbUrls)); const preloaded = await preloadImages(uniqueUrls,(p)=>{ const mapped=8+(p*0.8); updateLoader(mapped); }); const finalSet=[]; if(preloaded.length===0) finalSet.push('https://picsum.photos/900/640?random=301'); let idx=0; while(finalSet.length<7){ finalSet.push(preloaded[idx%preloaded.length]); idx++; } updateLoader(94); setTimeout(()=>{ buildGalleryWithUrls(finalSet); updateLoader(100); setTimeout(()=>hideLoader(),450); },220);
      if(isTouch){ const hint=document.createElement('div'); hint.style.position='fixed'; hint.style.left='50%'; hint.style.transform='translateX(-50%)'; hint.style.bottom='78px'; hint.style.zIndex='420'; hint.style.padding='8px 12px'; hint.style.borderRadius='999px'; hint.style.background='linear-gradient(90deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03))'; hint.style.color='#ffdfe8'; hint.style.fontSize='13px'; hint.textContent='Toca para ampliar'; document.body.appendChild(hint); setTimeout(()=>hint.remove(),4200); }
    })();

    // accessibility
    gallery.addEventListener('keydown',(e)=>{ if(e.key==='Enter' && e.target && e.target.querySelector('img')){ openModal(parseInt(e.target.querySelector('img').dataset.index,10)); } });
    document.getElementById('backBtn').addEventListener('click',()=>{ window.parent.postMessage({ type:'doorClosed' },'*'); });

  </script>
</body>
</html>
