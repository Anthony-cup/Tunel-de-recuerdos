<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Galería Romántica — 2D</title>
  <style>
    :root{
      --bg-1: #050006;
      --bg-2: #1b0a1a;
      --card-bg: rgba(255,255,255,0.03);
      --accent-a: #ffd1e6;
      --accent-b: #a6f0ff;
      --glass: rgba(255,255,255,0.04);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;color:#fff;background:linear-gradient(180deg,var(--bg-1),var(--bg-2));-webkit-font-smoothing:antialiased}

    /* full canvas hearts / bokeh */
    .bg-layers{position:fixed;inset:0;pointer-events:none;z-index:0}
    .bokeh{position:absolute;filter:blur(36px);opacity:0.12}
    .bokeh.b1{width:680px;height:420px;left:-10%;top:5%;background:radial-gradient(circle at 20% 30%, #ffd1e6 0%, transparent 40%), radial-gradient(circle at 80% 70%, #a6f0ff 0%, transparent 35%)}
    .bokeh.b2{width:420px;height:320px;right:-6%;bottom:6%;background:radial-gradient(circle at 30% 40%, #ffb3d1 0%, transparent 40%)}

    /* overlay controls */
    .overlay{position:fixed;left:14px;top:14px;z-index:40;background:linear-gradient(180deg,var(--glass),transparent);padding:10px;border-radius:12px;backdrop-filter: blur(6px);box-shadow:0 8px 30px rgba(0,0,0,0.6)}
    .overlay h2{margin:0;font-size:14px;color:var(--accent-a);letter-spacing:0.2px}
    .overlay p{margin:6px 0 0 0;font-size:12px;opacity:0.9}
    .controls{display:flex;gap:8px;margin-top:8px}
    .btn{padding:8px 12px;border-radius:12px;border:0;font-weight:700;cursor:pointer;background:linear-gradient(180deg,#ffc8e0,#9ff3ff);color:#111;box-shadow:0 10px 30px rgba(160,160,200,0.06)}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff;padding:8px 12px;border-radius:12px}

    /* gallery container */
    .wrap{position:relative;z-index:10;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:40px}
    .gallery{width:min(1100px,96vw);display:grid;grid-template-columns:repeat(4,1fr);grid-auto-rows:220px;gap:18px;justify-items:center;align-items:center}

    /* make exactly 7 slots but responsive */
    .card{width:100%;height:100%;max-width:360px;max-height:260px;position:relative;border-radius:14px;overflow:visible;display:flex;align-items:center;justify-content:center}

    /* polaroid uses css vars so JS can animate without clobbering transforms */
    .polaroid{position:relative;width:100%;height:100%;border-radius:12px;background:var(--card-bg);backdrop-filter: blur(4px);box-shadow:0 12px 40px rgba(0,0,0,0.6);transform-origin:center;transition:box-shadow .28s;--px:0px;--py:0px;--scale:1;}
    .polaroid{transform: translateX(var(--px)) translateY(var(--py)) rotate(var(--rot,0deg)) scale(var(--scale));}
    .polaroid img{width:100%;height:100%;object-fit:cover;border-radius:10px;display:block;transition:transform .45s cubic-bezier(.2,.9,.3,1)}
    .polaroid::after{content:'';position:absolute;left:10px;right:10px;bottom:6px;height:10px;border-radius:6px;background:linear-gradient(90deg, rgba(255,255,255,0.06), rgba(0,0,0,0.06));opacity:0.8}

    /* gentle float animation and small rotations to feel romantic (keeps rotation var) */
    @keyframes floaty{0%{transform:translateX(var(--px)) translateY(var(--py)) rotate(var(--rot)) scale(var(--scale))}50%{transform:translateX(calc(var(--px))) translateY(calc(var(--py) - 8px)) rotate(calc(var(--rot) + 1deg)) scale(var(--scale))}100%{transform:translateX(var(--px)) translateY(var(--py)) rotate(var(--rot)) scale(var(--scale))}}
    .polaroid{animation:floaty var(--dur,6s) ease-in-out infinite}

    /* focus style when auto-centering */
    .polaroid.focused{z-index:80;--scale:1.12;box-shadow:0 40px 110px rgba(0,0,0,0.75);transform-origin:center}

    /* hover effect */
    .polaroid:hover{--scale:1.06;box-shadow:0 30px 70px rgba(0,0,0,0.6)}

    /* center one larger on small screens */
    @media (max-width:900px){
      .gallery{grid-template-columns:repeat(2,1fr);grid-auto-rows:200px;gap:14px}
    }
    @media (max-width:520px){
      .gallery{grid-template-columns:repeat(1,1fr);gap:12px}
      .wrap{padding:18px}
    }

    /* modal preview */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(0,0,0,0.6),rgba(0,0,0,0.95));z-index:160;padding:20px}
    .modal.show{display:flex}
    .modal .content{max-width:94vw;max-height:86vh;border-radius:14px;display:flex;flex-direction:column;align-items:center;gap:12px}
    .modal img{max-width:94vw;max-height:80vh;border-radius:14px;box-shadow:0 30px 80px rgba(0,0,0,0.8);transition:transform .45s}
    .modal .controls{display:flex;gap:8px}
    .modal .replace{background:linear-gradient(180deg,#ffd1e6,#a6f0ff);border:0;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700;color:#111}
    .modal .save{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:10px;color:#fff}

    /* small hearts floating */
    .hearts{position:fixed;right:18px;bottom:18px;z-index:30;pointer-events:none}

    /* fireworks canvas */
    #fxCanvas{position:fixed;left:0;top:0;width:100%;height:100%;z-index:50;pointer-events:none}

    /* credits */
    .credits{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;z-index:40;font-size:12px;padding:8px 12px;border-radius:999px;background:linear-gradient(90deg,rgba(255,255,255,0.02),transparent);color:#ffdfe8}

    /* loader tweaks */
    #loaderOverlay{font-family:inherit}
  </style>
</head>
<body>
  <div class="bg-layers" aria-hidden="true">
    <div class="bokeh b1"></div>
    <div class="bokeh b2"></div>
  </div>

  <div class="overlay" role="region" aria-label="Controles">
    <h2>Galería Romántica — 2DDD</h2>
    <p>7 imágenes, estilo polaroid, táctil y fluido en móvil</p>
    <div class="controls">
      <button id="backBtn" class="btn-ghost">Regresar</button>
      <button id="surpriseBtn" class="btn">Sorpresa</button>
    </div>
  </div>

  <main class="wrap">
    <section class="gallery" id="gallery" aria-label="Galería de imágenes">
      <!-- 7 tarjetas se insertan desde JS -->
    </section>
  </main>

  <div class="credits">Toca para ampliar • Toque largo para reemplazar</div>

  <div class="modal" id="modal" aria-hidden="true">
    <div class="content">
      <div style="display:flex;gap:8px;align-items:center;width:100%;justify-content:flex-end">
        <button class="save" id="closeModal">Cerrar</button>
      </div>
      <img id="modalImg" src="" alt="Vista ampliada" />
      <div class="controls">
        <button class="replace" id="replaceBtn">Reemplazar</button>
        <button class="save" id="downloadBtn">Guardar</button>
      </div>
      <input type="file" id="replaceFile" accept="image/*" style="display:none" />
    </div>
  </div>

  <canvas id="fxCanvas"></canvas>
  <div class="hearts" id="hearts" aria-hidden="true"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
    import { getDatabase, ref, get } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';

    // firebase config (usa tu config real si es distinta)
    const firebaseConfig = {
      apiKey: "AIzaSyBk2SVaP1w4V3MWrpp1r3X5Xk9eH06gBt4",
      authDomain: "tunel-de-recuerdos.firebaseapp.com",
      projectId: "tunel-de-recuerdos",
      storageBucket: "tunel-de-recuerdos.firebasestorage.app",
      messagingSenderId: "630660710506",
      appId: "1:630660710506:web:90d34150c9f21f668eca13",
      measurementId: "G-ETFDVEHML1"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // Element refs
    const gallery = document.getElementById('gallery');
    const modal = document.getElementById('modal');
    const modalImg = document.getElementById('modalImg');
    const closeModal = document.getElementById('closeModal');
    const replaceBtn = document.getElementById('replaceBtn');
    const replaceFile = document.getElementById('replaceFile');
    const downloadBtn = document.getElementById('downloadBtn');

    let galleryData = []; // holds current urls in order (7 items)
    let currentModalIndex = null;

    // create an on-screen loader (centered) to show progress while images load
    const loader = document.createElement('div');
    loader.id = 'loaderOverlay';
    loader.innerHTML = `
      <div style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:200;background:linear-gradient(180deg,rgba(0,0,0,0.35),rgba(0,0,0,0.6));">
        <div style="width:min(720px,90vw);max-width:720px;padding:18px;border-radius:14px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));backdrop-filter:blur(6px);text-align:center;color:#ffdfe8;box-shadow:0 30px 80px rgba(0,0,0,0.6);">
          <div style="font-weight:800;font-size:18px;margin-bottom:8px;color:var(--accent-a);">Cargando galería romántica</div>
          <div style="font-size:13px;opacity:0.9;margin-bottom:12px">Preparando tus imágenes y efectos…</div>
          <div style="height:12px;background:rgba(255,255,255,0.06);border-radius:999px;overflow:hidden;margin:10px 24px">
            <div id="loaderBar" style="width:0%;height:100%;background:linear-gradient(90deg,var(--accent-b),var(--accent-a));transition:width .3s ease;"></div>
          </div>
          <div id="loaderPct" style="font-size:13px;opacity:0.95;margin-top:8px">0%</div>
        </div>
      </div>
    `;
    document.body.appendChild(loader);

    function updateLoader(pct){
      const bar = document.getElementById('loaderBar');
      const pctEl = document.getElementById('loaderPct');
      if(bar) bar.style.width = pct + '%';
      if(pctEl) pctEl.textContent = Math.round(pct) + '%';
    }
    function hideLoader(){ loader.remove(); }

    // helper to safely read potential image array in the db node
    async function fetchImagesFromFirebase(userId){
      try{
        const snap = await get(ref(database, `usuarios/${userId}`));
        if(!snap.exists()) return [];
        const data = snap.val();
        // try multiple property names user might have used
        const arr = data.puerta2Fotos || data.puertaFotos || data.fotos || data.images || [];
        if(!Array.isArray(arr)) return [];
        // filter valid strings
        return arr.filter(u => typeof u === 'string' && u.trim());
      }catch(err){
        console.error('Error leyendo Firebase:', err);
        return [];
      }
    }

    // preload images and report progress
    function preloadImages(urls, onProgress){
      return new Promise((resolve)=>{
        const loaded = [];
        let done = 0;
        const total = urls.length || 0;
        if(total === 0){ onProgress(100); resolve(loaded); return; }
        urls.forEach((u, idx)=>{
          const img = new Image();
          img.crossOrigin = 'anonymous';
          img.onload = ()=>{ done++; onProgress(done/total*100); loaded.push(u); if(done === total) resolve(loaded); };
          img.onerror = ()=>{ done++; onProgress(done/total*100); loaded.push(u); if(done === total) resolve(loaded); };
          img.src = u;
        });
      });
    }

    // Build gallery using exactly 7 images (duping if needed)
    function buildGalleryWithUrls(urls){
      const final = [];
      if(urls.length === 0) return final;
      let i = 0;
      while(final.length < 7){ final.push(urls[i % urls.length]); i++; }

      galleryData = final.slice(); // save it
      // clear and build
      gallery.innerHTML = '';
      for(let j=0;j<7;j++){
        const wrap = document.createElement('div'); wrap.className = 'card';
        const pol = document.createElement('div'); pol.className = 'polaroid';
        const rot = (Math.random()*12 - 6).toFixed(2) + 'deg';
        const floatAmt = (6 + Math.random()*12) + 'px';
        const dur = (6 + Math.random()*6) + 's';
        pol.style.setProperty('--rot', rot);
        pol.style.setProperty('--float', floatAmt);
        pol.style.setProperty('--dur', dur);

        const img = document.createElement('img'); img.alt = `Foto ${j+1}`;
        img.loading = 'lazy';
        img.src = final[j];
        img.dataset.index = j; // track index
        img.addEventListener('error', ()=>{ img.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="900" height="640"><rect width="100%" height="100%" fill="#2b1b1f"/></svg>' });

        // smooth zoom on click (modal) and small zoom on hover
        img.style.transition = 'transform .45s cubic-bezier(.2,.9,.3,1)';
        img.addEventListener('click', (e)=> openModal(parseInt(img.dataset.index,10)));

        // subtle auto-zoom loop for each polaroid (romantic breathing zoom)
        setInterval(()=>{
          pol.animate([{ transform: getComputedStyle(pol).transform + ' scale(1)' }, { transform: getComputedStyle(pol).transform + ' scale(1.02)' }, { transform: getComputedStyle(pol).transform + ' scale(1)' }], { duration: 5000 + (j*220), iterations: 1 });
        }, 7000 + (j*400));

        // long-press to replace on mobile
        let pressTimer = null;
        img.addEventListener('touchstart', (e)=>{ pressTimer = setTimeout(()=>{ triggerReplace(j); }, 700); });
        img.addEventListener('touchend', ()=>{ clearTimeout(pressTimer); });

        pol.appendChild(img);
        wrap.appendChild(pol);
        gallery.appendChild(wrap);
      }

      // entrance stagger animation
      Array.from(document.querySelectorAll('.polaroid')).forEach((p, idx)=>{
        p.style.opacity = 0; p.style.transform = 'translateY(18px)';
        setTimeout(()=>{ p.style.transition = 'opacity .7s ease, transform .7s cubic-bezier(.2,.9,.3,1)'; p.style.opacity = 1; p.style.transform = ''; }, 120 + idx * 110);
      });
    }

    function openModal(index){ currentModalIndex = index; modalImg.src = galleryData[index]; modal.classList.add('show'); modal.setAttribute('aria-hidden','false'); document.body.style.overflow = 'hidden'; // pause surprise while modal open
      if(window._surpriseInterval) clearInterval(window._surpriseInterval);
    }
    function close(){ modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); modalImg.src = ''; document.body.style.overflow = ''; // resume surprise
      if(window._surpriseInterval) clearInterval(window._surpriseInterval);
      window._surpriseInterval = setInterval(()=>{ triggerSurprise(); }, 12000 + Math.floor(Math.random()*6000));
    }
    closeModal.addEventListener('click', close);
    modal.addEventListener('click', (e)=>{ if(e.target === modal) close(); });
    document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') close(); });

    function saveImage(src){ const a = document.createElement('a'); a.href = src; a.download = 'imagen'; document.body.appendChild(a); a.click(); a.remove(); }
    downloadBtn.addEventListener('click', ()=>{ if(modalImg.src) saveImage(modalImg.src); });

    // Replace flow: allow user to pick local file to replace the image in the gallery (client-side only)
    replaceBtn.addEventListener('click', ()=>{ replaceFile.click(); });
    replaceFile.addEventListener('change', (ev)=>{
      const f = ev.target.files[0]; if(!f) return; const reader = new FileReader(); reader.onload = ()=>{
        if(currentModalIndex === null) return;
        const dataUrl = reader.result;
        // update galleryData and DOM
        galleryData[currentModalIndex] = dataUrl;
        const img = document.querySelector(`img[data-index='${currentModalIndex}']`);
        if(img) img.src = dataUrl;
        modalImg.src = dataUrl;
        // NOTE: here you could upload the file to Firebase Storage and update the DB if you want persistence.
      };
      reader.readAsDataURL(f);
    });

    // fireworks & hearts (kept from original)
    const fxCanvas = document.getElementById('fxCanvas');
    const ctx = fxCanvas.getContext('2d');
    let W = fxCanvas.width = innerWidth; let H = fxCanvas.height = innerHeight;
    window.addEventListener('resize', ()=>{ W = fxCanvas.width = innerWidth; H = fxCanvas.height = innerHeight; });
    const particles = [];
    function rand(mn,mx){ return Math.random()*(mx-mn)+mn }
    function launchFirework(x,y){
      const count = 26 + Math.floor(Math.random()*20);
      const hue = Math.floor(rand(320,20))||340;
      for(let i=0;i<count;i++){
        const a = Math.random()*Math.PI*2;
        const s = rand(2,6);
        particles.push({ x, y, vx: Math.cos(a)*s, vy: Math.sin(a)*s, life: rand(0.7,1.5), age:0, hue });
      }
    }
    function tickFX(dt){
      ctx.clearRect(0,0,W,H);
      for(let i=particles.length-1;i>=0;i--){
        const p = particles[i]; p.age += dt;
        if(p.age >= p.life){ particles.splice(i,1); continue; }
        p.vy += 0.06; p.vx *= 0.997; p.vy *= 0.998; p.x += p.vx; p.y += p.vy;
        const t = p.age / p.life;
        ctx.globalCompositeOperation = 'lighter';
        ctx.fillStyle = `hsla(${p.hue},85%,65%,${1 - t})`;
        ctx.beginPath(); ctx.arc(p.x, p.y, 2.4*(1 - t) + 0.8, 0, Math.PI*2); ctx.fill();
      }
    }
    let lastFX = performance.now();
    function loopFX(){ const now = performance.now(); const dt = (now - lastFX)/1000; lastFX = now; tickFX(dt); requestAnimationFrame(loopFX); }
    loopFX();

    function spawnHearts(){
      const container = document.getElementById('hearts');
      for(let i=0;i<12;i++){
        const el = document.createElement('div');
        el.style.width = el.style.height = (8 + Math.random()*22) + 'px';
        el.style.opacity = 0.9; el.style.marginBottom = '6px'; el.style.transform = `translateY(0)`;
        el.style.transition = `transform ${3 + Math.random()*1.6}s cubic-bezier(.2,.8,.2,1), opacity 1.6s`;
        el.innerHTML = '❤'; el.style.fontSize = el.style.width; el.style.pointerEvents = 'none'; el.style.display = 'block';
        el.style.filter = 'drop-shadow(0 4px 12px rgba(0,0,0,0.45))'; container.appendChild(el);
        setTimeout(()=>{ el.style.transform = `translateY(-${200 + Math.random()*320}px) translateX(${(Math.random()-0.5)*120}px) rotate(${(Math.random()-0.5)*40}deg)`; el.style.opacity = 0; }, 80 + i*40);
        setTimeout(()=> el.remove(), 4200 + Math.random()*900);
      }
    }

    // Surprise manual & automatic
    const surpriseBtn = document.getElementById('surpriseBtn');
    surpriseBtn.addEventListener('click', ()=>{ for(let i=0;i<3;i++){ const x = rand(innerWidth*0.2, innerWidth*0.8); const y = rand(innerHeight*0.2, innerHeight*0.5); launchFirework(x,y); } spawnHearts(); });
    function triggerSurprise(){ for(let i=0;i<3;i++){ const x = rand(innerWidth*0.2, innerWidth*0.8); const y = rand(innerHeight*0.18, innerHeight*0.52); launchFirework(x,y); } spawnHearts(); }
    setTimeout(triggerSurprise, 900);
    window._surpriseInterval = setInterval(()=>{ triggerSurprise(); }, 12000 + Math.floor(Math.random()*6000));

    // parallax pointer: set CSS vars instead of clobbering transform
    window.addEventListener('pointermove', (e)=>{
      const cx = innerWidth/2, cy = innerHeight/2; const dx = (e.clientX - cx)/cx; const dy = (e.clientY - cy)/cy;
      document.querySelectorAll('.polaroid').forEach((p,idx)=>{
        const depth = (idx%3) * 6 + 6;
        p.style.setProperty('--px', (dx*depth) + 'px');
        p.style.setProperty('--py', (Math.sin(idx + performance.now()*0.0008)*4 + dy*depth*0.5) + 'px');
      });
    }, {passive:true});

    // auto-focus / slideshow: gently bring each polaroid to focus center for a few seconds
    let _focusIdx = 0;
    function focusOn(idx){ document.querySelectorAll('.polaroid').forEach((p,i)=>{ p.classList.toggle('focused', i===idx); }); }
    function cycleFocus(){ focusOn(_focusIdx); _focusIdx = (_focusIdx + 1) % 7; }
    setInterval(cycleFocus, 5000);

    // initial flow: read param id, fetch from DB, preload, then build gallery
    (async function init(){
      const urlParams = new URLSearchParams(window.location.search);
      const userId = urlParams.get('id')?.trim();
      if(!userId){ document.getElementById('loaderPct').textContent = 'ID no encontrado'; // still continue with placeholders
      }

      let dbUrls = [];
      if(userId) dbUrls = await fetchImagesFromFirebase(userId);
      // if none found, try fallback
      if(!dbUrls || dbUrls.length === 0){ console.warn('No images found for user', userId); dbUrls = [
        'https://picsum.photos/900/640?random=201',
        'https://picsum.photos/900/640?random=202'
      ]; }

      updateLoader(8);
      const uniqueUrls = Array.from(new Set(dbUrls));
      const preloaded = await preloadImages(uniqueUrls, (p)=>{ const mapped = 8 + (p * 0.8); updateLoader(mapped); });

      const finalSet = [];
      if(preloaded.length === 0){ finalSet.push('https://picsum.photos/900/640?random=301'); }
      let idx = 0; while(finalSet.length < 7){ finalSet.push(preloaded[idx % preloaded.length]); idx++; }

      updateLoader(94);
      setTimeout(()=>{ buildGalleryWithUrls(finalSet); updateLoader(100); setTimeout(()=> hideLoader(), 450); }, 220);
    })();

    // accessibility: open with Enter
    gallery.addEventListener('keydown', (e)=>{ if(e.key === 'Enter' && e.target && e.target.querySelector('img')){ openModal(parseInt(e.target.querySelector('img').dataset.index,10)); } });

    // back button
    document.getElementById('backBtn').addEventListener('click', ()=>{ window.parent.postMessage({ type: 'doorClosed' }, '*'); });

    // helper to trigger replace quickly
    function triggerReplace(index){ currentModalIndex = index; replaceFile.click(); }

  </script>
</body>
</html>
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Galería Romántica — 2D</title>
  <style>
    :root{
      --bg-1: #050006;
      --bg-2: #1b0a1a;
      --card-bg: rgba(255,255,255,0.03);
      --accent-a: #ffd1e6;
      --accent-b: #a6f0ff;
      --glass: rgba(255,255,255,0.04);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;color:#fff;background:linear-gradient(180deg,var(--bg-1),var(--bg-2));-webkit-font-smoothing:antialiased}

    /* full canvas hearts / bokeh */
    .bg-layers{position:fixed;inset:0;pointer-events:none;z-index:0}
    .bokeh{position:absolute;filter:blur(36px);opacity:0.12}
    .bokeh.b1{width:680px;height:420px;left:-10%;top:5%;background:radial-gradient(circle at 20% 30%, #ffd1e6 0%, transparent 40%), radial-gradient(circle at 80% 70%, #a6f0ff 0%, transparent 35%)}
    .bokeh.b2{width:420px;height:320px;right:-6%;bottom:6%;background:radial-gradient(circle at 30% 40%, #ffb3d1 0%, transparent 40%)}

    /* overlay controls */
    .overlay{position:fixed;left:14px;top:14px;z-index:40;background:linear-gradient(180deg,var(--glass),transparent);padding:10px;border-radius:12px;backdrop-filter: blur(6px);box-shadow:0 8px 30px rgba(0,0,0,0.6)}
    .overlay h2{margin:0;font-size:14px;color:var(--accent-a);letter-spacing:0.2px}
    .overlay p{margin:6px 0 0 0;font-size:12px;opacity:0.9}
    .controls{display:flex;gap:8px;margin-top:8px}
    .btn{padding:8px 12px;border-radius:12px;border:0;font-weight:700;cursor:pointer;background:linear-gradient(180deg,#ffc8e0,#9ff3ff);color:#111;box-shadow:0 10px 30px rgba(160,160,200,0.06)}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff;padding:8px 12px;border-radius:12px}

    /* gallery container */
    .wrap{position:relative;z-index:10;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:40px}
    .gallery{width:min(1100px,96vw);display:grid;grid-template-columns:repeat(4,1fr);grid-auto-rows:220px;gap:18px;justify-items:center;align-items:center}

    /* make exactly 7 slots but responsive */
    .card{width:100%;height:100%;max-width:360px;max-height:260px;position:relative;border-radius:14px;overflow:visible;display:flex;align-items:center;justify-content:center}
    .polaroid{position:relative;width:100%;height:100%;border-radius:12px;background:var(--card-bg);backdrop-filter: blur(4px);box-shadow:0 12px 40px rgba(0,0,0,0.6);transform-origin:center;transition:transform .28s cubic-bezier(.2,.9,.3,1),box-shadow .28s}
    .polaroid img{width:100%;height:100%;object-fit:cover;border-radius:10px;display:block}
    .polaroid::after{content:'';position:absolute;left:10px;right:10px;bottom:6px;height:10px;border-radius:6px;background:linear-gradient(90deg, rgba(255,255,255,0.06), rgba(0,0,0,0.06));opacity:0.8}

    /* gentle float animation and small rotations to feel romantic */
    @keyframes floaty{0%{transform:translateY(0) rotate(var(--rot))}50%{transform:translateY(var(--float)) rotate(calc(var(--rot) + 1deg))}100%{transform:translateY(0) rotate(var(--rot))}}
    .polaroid{animation:floaty var(--dur) ease-in-out infinite}

    /* focus/hover */
    .polaroid:hover{transform:translateY(-10px) scale(1.03);box-shadow:0 30px 70px rgba(0,0,0,0.6)}

    /* center one larger on small screens */
    @media (max-width:900px){
      .gallery{grid-template-columns:repeat(2,1fr);grid-auto-rows:200px;gap:14px}
    }
    @media (max-width:520px){
      .gallery{grid-template-columns:repeat(1,1fr);gap:12px}
      .wrap{padding:18px}
    }

    /* modal preview */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(0,0,0,0.6),rgba(0,0,0,0.95));z-index:80;padding:20px}
    .modal.show{display:flex}
    .modal img{max-width:94vw;max-height:86vh;border-radius:14px;box-shadow:0 30px 80px rgba(0,0,0,0.8)}
    .modal .close{position:absolute;right:24px;top:18px;background:linear-gradient(180deg,#ffc8e0,#9ff3ff);border:0;padding:8px 12px;border-radius:10px;font-weight:700;color:#111;cursor:pointer}

    /* small hearts floating */
    .hearts{position:fixed;right:18px;bottom:18px;z-index:30;pointer-events:none}

    /* fireworks canvas */
    #fxCanvas{position:fixed;left:0;top:0;width:100%;height:100%;z-index:50;pointer-events:none}

    /* credits */
    .credits{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;z-index:40;font-size:12px;padding:8px 12px;border-radius:999px;background:linear-gradient(90deg,rgba(255,255,255,0.02),transparent);color:#ffdfe8}
  </style>
</head>
<body>
  <div class="bg-layers" aria-hidden="true">
    <div class="bokeh b1"></div>
    <div class="bokeh b2"></div>
  </div>

  <div class="overlay" role="region" aria-label="Controles">
    <h2>Galería Romántica — 2D...</h2>
    <p>7 imágenes, estilo polaroid, táctil y fluido en móvil</p>
    <div class="controls">
      <button id="backBtn" class="btn-ghost">Regresar</button>
      <button id="surpriseBtn" class="btn">Sorpresa</button>
    </div>
  </div>

  <main class="wrap">
    <section class="gallery" id="gallery" aria-label="Galería de imágenes">
      <!-- 7 tarjetas se insertan desde JS -->
    </section>
  </main>

  <div class="credits">Toca para ampliar • Toque largo para guardar</div>

  <div class="modal" id="modal" aria-hidden="true">
    <button class="close" id="closeModal">Cerrar</button>
    <img id="modalImg" src="" alt="Vista ampliada" />
  </div>

  <canvas id="fxCanvas"></canvas>
  <div class="hearts" id="hearts" aria-hidden="true"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
    import { getDatabase, ref, get } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';

    // firebase config (usa tu config real si es distinta)
    const firebaseConfig = {
      apiKey: "AIzaSyBk2SVaP1w4V3MWrpp1r3X5Xk9eH06gBt4",
      authDomain: "tunel-de-recuerdos.firebaseapp.com",
      projectId: "tunel-de-recuerdos",
      storageBucket: "tunel-de-recuerdos.firebasestorage.app",
      messagingSenderId: "630660710506",
      appId: "1:630660710506:web:90d34150c9f21f668eca13",
      measurementId: "G-ETFDVEHML1"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // Element refs
    const gallery = document.getElementById('gallery');
    const modal = document.getElementById('modal');
    const modalImg = document.getElementById('modalImg');
    const closeModal = document.getElementById('closeModal');

    // create an on-screen loader (centered) to show progress while images load
    const loader = document.createElement('div');
    loader.id = 'loaderOverlay';
    loader.innerHTML = `
      <div style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:200;background:linear-gradient(180deg,rgba(0,0,0,0.35),rgba(0,0,0,0.6));">
        <div style="width:min(720px,90vw);max-width:720px;padding:18px;border-radius:14px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));backdrop-filter:blur(6px);text-align:center;color:#ffdfe8;box-shadow:0 30px 80px rgba(0,0,0,0.6);">
          <div style="font-weight:800;font-size:18px;margin-bottom:8px;color:var(--accent-a);">Cargando galería romántica</div>
          <div style="font-size:13px;opacity:0.9;margin-bottom:12px">Preparando tus imágenes y efectos…</div>
          <div style="height:12px;background:rgba(255,255,255,0.06);border-radius:999px;overflow:hidden;margin:10px 24px">
            <div id="loaderBar" style="width:0%;height:100%;background:linear-gradient(90deg,var(--accent-b),var(--accent-a));transition:width .3s ease;"></div>
          </div>
          <div id="loaderPct" style="font-size:13px;opacity:0.95;margin-top:8px">0%</div>
        </div>
      </div>
    `;
    document.body.appendChild(loader);

    function updateLoader(pct){
      const bar = document.getElementById('loaderBar');
      const pctEl = document.getElementById('loaderPct');
      if(bar) bar.style.width = pct + '%';
      if(pctEl) pctEl.textContent = Math.round(pct) + '%';
    }
    function hideLoader(){ loader.remove(); }

    // helper to safely read potential image array in the db node
    async function fetchImagesFromFirebase(userId){
      try{
        const snap = await get(ref(database, `usuarios/${userId}`));
        if(!snap.exists()) return [];
        const data = snap.val();
        // try multiple property names user might have used
        const arr = data.puerta2Fotos || data.puertaFotos || data.fotos || data.images || [];
        if(!Array.isArray(arr)) return [];
        // filter valid strings
        return arr.filter(u => typeof u === 'string' && u.trim());
      }catch(err){
        console.error('Error leyendo Firebase:', err);
        return [];
      }
    }

    // preload images and report progress
    function preloadImages(urls, onProgress){
      return new Promise((resolve)=>{
        const loaded = [];
        let done = 0;
        const total = urls.length || 0;
        if(total === 0){ onProgress(100); resolve(loaded); return; }
        urls.forEach((u, idx)=>{
          const img = new Image();
          img.crossOrigin = 'anonymous';
          img.onload = ()=>{
            done++; onProgress(done/total*100); loaded.push(u); if(done === total) resolve(loaded);
          };
          img.onerror = ()=>{ done++; onProgress(done/total*100); loaded.push(u); if(done === total) resolve(loaded); };
          img.src = u;
        });
      });
    }

    // Build gallery using exactly 7 images (duping if needed)
    function buildGalleryWithUrls(urls){
      const final = [];
      if(urls.length === 0) return final;
      let i = 0;
      while(final.length < 7){ final.push(urls[i % urls.length]); i++; }

      // clear and build
      gallery.innerHTML = '';
      for(let j=0;j<7;j++){
        const wrap = document.createElement('div'); wrap.className = 'card';
        const pol = document.createElement('div'); pol.className = 'polaroid';
        const rot = (Math.random()*12 - 6).toFixed(2) + 'deg';
        const floatAmt = (6 + Math.random()*12) + 'px';
        const dur = (6 + Math.random()*6) + 's';
        pol.style.setProperty('--rot', rot);
        pol.style.setProperty('--float', floatAmt);
        pol.style.setProperty('--dur', dur);

        const img = document.createElement('img'); img.alt = `Foto ${j+1}`;
        img.loading = 'lazy';
        img.src = final[j];
        img.addEventListener('error', ()=>{ img.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="900" height="640"><rect width="100%" height="100%" fill="#2b1b1f"/></svg>' });

        // smooth zoom on click (modal) and small zoom on hover
        img.style.transition = 'transform .45s cubic-bezier(.2,.9,.3,1)';
        img.addEventListener('click', ()=> openModal(img.src));

        // subtle auto-zoom loop for each polaroid (romantic breathing zoom)
        setInterval(()=>{
          pol.animate([{ transform: pol.style.transform || 'none' }, { transform: (pol.style.transform || 'none') + ' scale(1.02)' }, { transform: pol.style.transform || 'none' }], { duration: 5000 + (j*220), iterations: 1 });
        }, 7000 + (j*400));

        // long-press to save on mobile
        let pressTimer = null;
        img.addEventListener('touchstart', (e)=>{ pressTimer = setTimeout(()=>{ saveImage(img.src); }, 700); });
        img.addEventListener('touchend', ()=>{ clearTimeout(pressTimer); });

        pol.appendChild(img);
        wrap.appendChild(pol);
        gallery.appendChild(wrap);
      }
    }

    function openModal(src){ modalImg.src = src; modal.classList.add('show'); modal.setAttribute('aria-hidden','false'); document.body.style.overflow = 'hidden'; }
    function close(){ modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); modalImg.src = ''; document.body.style.overflow = ''; }
    closeModal.addEventListener('click', close);
    modal.addEventListener('click', (e)=>{ if(e.target === modal) close(); });
    document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') close(); });

    function saveImage(src){ const a = document.createElement('a'); a.href = src; a.download = 'imagen'; document.body.appendChild(a); a.click(); a.remove(); }

    // fireworks & hearts (kept from original)
    const fxCanvas = document.getElementById('fxCanvas');
    const ctx = fxCanvas.getContext('2d');
    let W = fxCanvas.width = innerWidth; let H = fxCanvas.height = innerHeight;
    window.addEventListener('resize', ()=>{ W = fxCanvas.width = innerWidth; H = fxCanvas.height = innerHeight; });
    const particles = [];
    function rand(mn,mx){ return Math.random()*(mx-mn)+mn }
    function launchFirework(x,y){
      const count = 26 + Math.floor(Math.random()*20);
      const hue = Math.floor(rand(320,20))||340;
      for(let i=0;i<count;i++){
        const a = Math.random()*Math.PI*2;
        const s = rand(2,6);
        particles.push({ x, y, vx: Math.cos(a)*s, vy: Math.sin(a)*s, life: rand(0.7,1.5), age:0, hue });
      }
    }
    function tickFX(dt){
      ctx.clearRect(0,0,W,H);
      for(let i=particles.length-1;i>=0;i--){
        const p = particles[i]; p.age += dt;
        if(p.age >= p.life){ particles.splice(i,1); continue; }
        p.vy += 0.06; p.vx *= 0.997; p.vy *= 0.998; p.x += p.vx; p.y += p.vy;
        const t = p.age / p.life;
        ctx.globalCompositeOperation = 'lighter';
        ctx.fillStyle = `hsla(${p.hue},85%,65%,${1 - t})`;
        ctx.beginPath(); ctx.arc(p.x, p.y, 2.4*(1 - t) + 0.8, 0, Math.PI*2); ctx.fill();
      }
    }
    let lastFX = performance.now();
    function loopFX(){ const now = performance.now(); const dt = (now - lastFX)/1000; lastFX = now; tickFX(dt); requestAnimationFrame(loopFX); }
    loopFX();

    function spawnHearts(){
      const container = document.getElementById('hearts');
      for(let i=0;i<12;i++){
        const el = document.createElement('div');
        el.style.width = el.style.height = (8 + Math.random()*22) + 'px';
        el.style.opacity = 0.9; el.style.marginBottom = '6px'; el.style.transform = `translateY(0)`;
        el.style.transition = `transform ${3 + Math.random()*1.6}s cubic-bezier(.2,.8,.2,1), opacity 1.6s`;
        el.innerHTML = '❤'; el.style.fontSize = el.style.width; el.style.pointerEvents = 'none'; el.style.display = 'block';
        el.style.filter = 'drop-shadow(0 4px 12px rgba(0,0,0,0.45))'; container.appendChild(el);
        setTimeout(()=>{ el.style.transform = `translateY(-${200 + Math.random()*320}px) translateX(${(Math.random()-0.5)*120}px) rotate(${(Math.random()-0.5)*40}deg)`; el.style.opacity = 0; }, 80 + i*40);
        setTimeout(()=> el.remove(), 4200 + Math.random()*900);
      }
    }

    // Surprise manual & automatic
    const surpriseBtn = document.getElementById('surpriseBtn');
    surpriseBtn.addEventListener('click', ()=>{ for(let i=0;i<3;i++){ const x = rand(innerWidth*0.2, innerWidth*0.8); const y = rand(innerHeight*0.2, innerHeight*0.5); launchFirework(x,y); } spawnHearts(); });
    function triggerSurprise(){ for(let i=0;i<3;i++){ const x = rand(innerWidth*0.2, innerWidth*0.8); const y = rand(innerHeight*0.18, innerHeight*0.52); launchFirework(x,y); } spawnHearts(); }
    setTimeout(triggerSurprise, 900);
    let _surpriseInterval = setInterval(()=>{ triggerSurprise(); }, 12000 + Math.floor(Math.random()*6000));

    // parallax pointer
    window.addEventListener('pointermove', (e)=>{
      const cx = innerWidth/2, cy = innerHeight/2; const dx = (e.clientX - cx)/cx; const dy = (e.clientY - cy)/cy;
      document.querySelectorAll('.polaroid').forEach((p,idx)=>{
        const depth = (idx%3) * 6 + 6;
        p.style.transform = `translateZ(0) translateY(${(Math.sin(idx + performance.now()*0.0008)*4)}px) rotate(${p.style.getPropertyValue('--rot')}) translateX(${dx*depth}px) translateY(${dy*depth*0.5}px)`;
      });
    }, {passive:true});

    // initial flow: read param id, fetch from DB, preload, then build gallery
    (async function init(){
      const urlParams = new URLSearchParams(window.location.search);
      const userId = urlParams.get('id')?.trim();
      if(!userId){ document.getElementById('loaderPct').textContent = 'ID no encontrado'; return; }

      let dbUrls = await fetchImagesFromFirebase(userId);
      // if none found, try fallback: user might have stored images directly under 'imagenes' key
      if(!dbUrls || dbUrls.length === 0){ console.warn('No images found for user', userId); }

      // ensure at least 1 placeholder so preload won't break
      if(!dbUrls || dbUrls.length === 0) dbUrls = [
        'https://picsum.photos/900/640?random=201',
        'https://picsum.photos/900/640?random=202'
      ];

      // preload using a worker-ish approach and update loader progress
      updateLoader(8);
      const uniqueUrls = Array.from(new Set(dbUrls));
      const preloaded = await preloadImages(uniqueUrls, (p)=>{
        // p is 0-100 for the unique set; map to 8-88
        const mapped = 8 + (p * 0.8);
        updateLoader(mapped);
      });

      // after preloading, construct final array duplicating as needed to reach 7
      const finalSet = [];
      if(preloaded.length === 0){ finalSet.push('https://picsum.photos/900/640?random=301'); }
      let idx = 0; while(finalSet.length < 7){ finalSet.push(preloaded[idx % preloaded.length]); idx++; }

      updateLoader(94);

      // small delay for polish, then build
      setTimeout(()=>{
        buildGalleryWithUrls(finalSet);
        updateLoader(100);
        setTimeout(()=> hideLoader(), 450);
      }, 220);
    })();

    // accessibility: open with Enter
    gallery.addEventListener('keydown', (e)=>{ if(e.key === 'Enter' && e.target && e.target.querySelector('img')){ openModal(e.target.querySelector('img').src); } });

    // back button
    document.getElementById('backBtn').addEventListener('click', ()=>{ window.parent.postMessage({ type: 'doorClosed' }, '*'); });

  </script>
</body>
</html>


