<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Galería Romántica — Animaciones en Bucle (móvil)</title>
  <style>
    :root{--bg-1:#040006;--bg-2:#12041a;--accent-a:#ffd1e6;--accent-b:#a6f0ff}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial;color:#fff;background:linear-gradient(180deg,var(--bg-1),var(--bg-2));-webkit-font-smoothing:antialiased;touch-action:manipulation}

    /* cinematic background */
    .bg-layers{position:fixed;inset:0;pointer-events:none;z-index:0}
    .bokeh{position:absolute;filter:blur(46px);opacity:0.12}
    .bokeh.b1{width:540px;height:340px;left:-8%;top:6%;background:radial-gradient(circle at 20% 30%, #ffd1e6 0%, transparent 45%), radial-gradient(circle at 80% 70%, #a6f0ff 0%, transparent 40%)}

    /* controls */
    .overlay{position:fixed;left:12px;top:12px;z-index:140;padding:10px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);backdrop-filter:blur(6px)}
    .overlay h2{margin:0;font-size:14px;color:var(--accent-a)}
    .controls{display:flex;gap:8px;margin-top:8px}
    .btn{padding:8px 12px;border-radius:12px;border:0;font-weight:700;cursor:pointer;background:linear-gradient(180deg,#ffc8e0,#9ff3ff);color:#111}

    /* responsive grid, mobile-first */
    .wrap{position:relative;z-index:100;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:14px}
    .gallery{width:100%;max-width:980px;display:grid;grid-template-columns:repeat(2,1fr);grid-auto-rows:220px;gap:12px}
    @media(min-width:720px){.gallery{grid-template-columns:repeat(4,1fr);gap:18px}}

    .card{position:relative;border-radius:16px;overflow:visible;display:flex;align-items:center;justify-content:center}
    .polaroid{position:relative;width:100%;height:100%;border-radius:14px;overflow:hidden;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.06));box-shadow:0 24px 80px rgba(0,0,0,0.6);transform-origin:center}
    .polaroid .imgwrap{position:absolute;inset:0}
    .polaroid img{width:100%;height:100%;object-fit:cover;display:block;will-change:transform,filter}

    /* overlay vignette & film grain */
    .polaroid::after{content:'';position:absolute;inset:0;border-radius:14px;box-shadow:inset 0 40px 140px rgba(0,0,0,0.45);pointer-events:none}

    /* heart burst for each card */
    .heart-burst{position:absolute;left:50%;top:50%;transform:translate(-50%,-40%);pointer-events:none;z-index:60}
    .heart-burst .h{position:absolute;font-size:12px;opacity:0;transform:translateY(0) scale(0.8);transition:transform .9s cubic-bezier(.2,.8,.2,1),opacity .9s}

    /* modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(0,0,0,0.6),rgba(0,0,0,0.95));z-index:900;padding:18px}
    .modal.show{display:flex}
    .modal img{max-width:94vw;max-height:86vh;border-radius:12px;box-shadow:0 30px 80px rgba(0,0,0,0.8)}

    .credits{position:fixed;left:50%;transform:translateX(-50%);bottom:12px;z-index:120;font-size:12px;padding:6px 10px;border-radius:999px;background:linear-gradient(90deg,rgba(255,255,255,0.02),transparent);color:#ffdfe8}

    /* performance: reduce motion if user prefers */
    @media (prefers-reduced-motion: reduce){ .polaroid img, .polaroid{animation:none!important;transition:none!important} }
  </style>
</head>
<body>
  <div class="bg-layers" aria-hidden="true"><div class="bokeh b1"></div></div>
  <div class="overlay" role="region" aria-label="Controles"><h2>Galería Romántica v23</h2><div class="controls"><button id="backBtn" class="btn">Regresar</button><button id="surpriseBtn" class="btn">Sorpresa</button></div></div>

  <main class="wrap"><section class="gallery" id="gallery" aria-label="Galería de imágenes"></section></main>

  <div class="credits">Animación automática en bucle • Toca para ampliar</div>

  <div class="modal" id="modal" aria-hidden="true"><img id="modalImg" src="" alt="vista ampliada" /><button id="closeModal" style="position:absolute;right:18px;top:18px;padding:8px 10px;border-radius:8px;background:linear-gradient(180deg,#ffd1e6,#a6f0ff);border:0;color:#111;font-weight:700;z-index:950">Cerrar</button></div>

  <canvas id="fxCanvas" style="pointer-events:none;position:fixed;left:0;top:0;width:100%;height:100%;z-index:600"></canvas>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
    import { getDatabase, ref, get } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBk2SVaP1w4V3MWrpp1r3X5Xk9eH06gBt4",
      authDomain: "tunel-de-recuerdos.firebaseapp.com",
      projectId: "tunel-de-recuerdos",
      storageBucket: "tunel-de-recuerdos.firebasestorage.app",
      messagingSenderId: "630660710506",
      appId: "1:630660710506:web:90d34150c9f21f668eca13",
      measurementId: "G-ETFDVEHML1"
    };
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    const gallery = document.getElementById('gallery');
    const modal = document.getElementById('modal');
    const modalImg = document.getElementById('modalImg');
    const closeModal = document.getElementById('closeModal');
    const surpriseBtn = document.getElementById('surpriseBtn');

    // loader (minimal, reused) - quick
    const loaderBar = (function(){ const d=document.createElement('div'); d.style.position='fixed'; d.style.left='50%'; d.style.top='50%'; d.style.transform='translate(-50%,-50%)'; d.style.zIndex='800'; d.style.padding='8px 12px'; d.style.borderRadius='12px'; d.style.background='linear-gradient(180deg,rgba(0,0,0,0.5),rgba(0,0,0,0.65))'; d.style.color='#ffdfe8'; d.style.fontWeight='700'; d.textContent='Cargando...'; document.body.appendChild(d); return d; })();

    function removeLoader(){ loaderBar && loaderBar.remove(); }

    async function fetchImages(userId){ try{ const s = await get(ref(database, `usuarios/${userId}`)); if(!s.exists()) return []; const val = s.val(); const arr = val.puerta2Fotos || val.puertaFotos || val.fotos || val.images || []; if(!Array.isArray(arr)) return []; return arr.filter(u=>typeof u==='string'&&u.trim()); }catch(e){ console.error(e); return []; } }

    function preload(urls, onProgress){ return new Promise((res)=>{ const loaded=[]; let done=0; const total=urls.length||0; if(total===0){ onProgress(100); res([]); return; } urls.forEach((u)=>{ const i=new Image(); i.crossOrigin='anonymous'; i.onload=()=>{ done++; onProgress(done/total*100); loaded.push(u); if(done===total) res(loaded); }; i.onerror=()=>{ done++; onProgress(done/total*100); loaded.push(u); if(done===total) res(loaded); }; i.src=u; }); }); }

    // MAIN: build 7 cards and give each a rich looped animation + per-loop heart burst
    function buildGallery(urls){ const final=[]; let i=0; if(urls.length===0) urls=['https://picsum.photos/900/640?random=201','https://picsum.photos/900/640?random=202']; while(final.length<7){ final.push(urls[i%urls.length]); i++; } gallery.innerHTML=''; final.forEach((src, idx)=>{ const card=document.createElement('div'); card.className='card'; const pol=document.createElement('div'); pol.className='polaroid'; const imgwrap=document.createElement('div'); imgwrap.className='imgwrap'; const img=document.createElement('img'); img.src=src; img.alt=`Foto ${idx+1}`; img.loading='lazy'; imgwrap.appendChild(img); pol.appendChild(imgwrap);

      // heart burst container
      const burst=document.createElement('div'); burst.className='heart-burst'; pol.appendChild(burst);

      // add pol to card and card to grid
      card.appendChild(pol); gallery.appendChild(card);

      // Create a complex WAAPI timeline that simulates TikTok-like short: kenburns + small tilt + brightness swing
      const duration = 7000 + Math.floor(Math.random()*5000); // 7-12s
      const keyframes = [
        { transform: 'scale(1) translate3d(0,0,0) rotate(0deg)', filter: 'brightness(1) contrast(1)', offset:0 },
        { transform: 'scale(1.06) translate3d(-6px,-10px,0) rotate(-0.6deg)', filter: 'brightness(1.06) contrast(1.03)', offset:0.45 },
        { transform: 'scale(1.02) translate3d(4px,6px,0) rotate(0.4deg)', filter: 'brightness(0.98) contrast(0.98)', offset:0.75 },
        { transform: 'scale(1) translate3d(0,0,0) rotate(0deg)', filter: 'brightness(1) contrast(1)', offset:1 }
      ];
      const imgAnim = img.animate(keyframes, { duration, iterations: Infinity, easing: 'ease-in-out', delay: idx*200 });

      // small subtle frame glow loop using WAAPI on the pol container
      pol.animate([{ boxShadow: '0 18px 60px rgba(0,0,0,0.6)' }, { boxShadow: '0 28px 110px rgba(255,150,200,0.12)' }, { boxShadow: '0 18px 60px rgba(0,0,0,0.6)' }], { duration: 5600 + idx*300, iterations: Infinity, easing: 'ease-in-out' });

      // every time the image completes a loop-ish (approx), spawn a heart burst to feel alive
      const burstInterval = Math.max(3500, Math.floor(duration*0.6));
      let burstTimer = setInterval(()=> spawnBurst(burst), burstInterval + Math.floor(Math.random()*1200));

      // tap interaction: quick pulse + extra hearts
      pol.addEventListener('click', ()=>{ // quick pulse
        img.animate([{ transform: 'scale(1.04)' }, { transform: 'scale(1)' }], { duration: 420, easing:'cubic-bezier(.2,.9,.3,1)' }); spawnBurst(burst, 10);
      });

      // accessibility: open modal on double-tap for view (mobile)
      let lastTap = 0; pol.addEventListener('touchend', (e)=>{ const now = Date.now(); if(now - lastTap < 320){ openModal(idx); } lastTap = now; }, {passive:true});

      // cleanup if needed later
      pol.dataset._burstTimer = burstTimer;
    });
  }

    // spawn small hearts inside a container element (card)');

    function spawnBurst(container, count = 6){
      // create a burst of small hearts that float upward and fade
      for(let i=0;i<count;i++){
        const h = document.createElement('div');
        h.className = 'h';
        h.textContent = '❤';
        const size = 10 + Math.random()*18; h.style.fontSize = size + 'px';
        h.style.left = (50 + (Math.random()-0.5)*40) + '%';
        h.style.top = (48 + (Math.random()-0.5)*18) + '%';
        container.appendChild(h);
        // animate using requestAnimationFrame + CSS transitions
        requestAnimationFrame(()=>{
          const dx = (Math.random()-0.5) * 60; const dy = -50 - Math.random()*80; const rot = (Math.random()-0.5)*80;
          h.style.opacity = '1';
          h.style.transform = `translate(${dx}px, ${dy}px) rotate(${rot}deg) scale(1)`;
        });
        // remove after done
        setTimeout(()=>{ h.style.opacity = '0'; }, 900);
        setTimeout(()=>{ h.remove(); }, 1600 + Math.random()*400);
      }
    }

    // Modal handlers
    function openModal(index){ currentModalIndex = index; modalImg.src = gallery.querySelectorAll('img')[index].src; modal.classList.add('show'); modal.setAttribute('aria-hidden','false'); document.body.style.overflow = 'hidden'; if(window._surpriseInterval) clearInterval(window._surpriseInterval); }
    function closeModalFn(){ modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); modalImg.src = ''; document.body.style.overflow = ''; if(window._surpriseInterval) clearInterval(window._surpriseInterval); window._surpriseInterval = setInterval(()=> triggerSurprise(), 12000 + Math.floor(Math.random()*6000)); }
    closeModal.addEventListener('click', closeModalFn);
    modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModalFn(); });

    // Surprise: fireworks + hearts on all cards
    function triggerSurprise(){ // fireworks
      const W = innerWidth, H = innerHeight;
      for(let i=0;i<3;i++){
        const x = Math.random()*(W*0.7)+W*0.15; const y = Math.random()*(H*0.35)+H*0.15; launchFirework(x,y);
      }
      // hearts on each visible card
      document.querySelectorAll('.heart-burst').forEach(b => spawnBurst(b, 6));
    }
    surpriseBtn.addEventListener('click', ()=> triggerSurprise());

    // Fireworks canvas (lighter weight than before)
    const fxCanvas = document.getElementById('fxCanvas'); const ctx = fxCanvas.getContext('2d'); let W = fxCanvas.width = innerWidth; let H = fxCanvas.height = innerHeight; window.addEventListener('resize', ()=>{ W = fxCanvas.width = innerWidth; H = fxCanvas.height = innerHeight; });
    const particles = [];
    function launchFirework(x,y){ const count = 20 + Math.floor(Math.random()*28); const hue = Math.floor(Math.random()*60)+300; for(let i=0;i<count;i++){ const a = Math.random()*Math.PI*2; const s = 2 + Math.random()*5; particles.push({ x, y, vx: Math.cos(a)*s, vy: Math.sin(a)*s, life: 0.8 + Math.random()*1.2, age:0, hue }); } }
    function tickFX(dt){ ctx.clearRect(0,0,W,H); for(let i=particles.length-1;i>=0;i--){ const p = particles[i]; p.age += dt; if(p.age >= p.life){ particles.splice(i,1); continue; } p.vy += 0.06; p.vx *= 0.998; p.vy *= 0.998; p.x += p.vx; p.y += p.vy; const t = p.age / p.life; ctx.globalCompositeOperation = 'lighter'; ctx.fillStyle = `hsla(${p.hue},85%,65%,${1 - t})`; ctx.beginPath(); ctx.arc(p.x, p.y, 2.6*(1 - t) + 0.8, 0, Math.PI*2); ctx.fill(); } }
    let last = performance.now(); function loopFX(){ const now = performance.now(); const dt = (now - last)/1000; last = now; tickFX(dt); requestAnimationFrame(loopFX); } loopFX();

    // initial load: read id -> fetch -> preload -> build
    (async function init(){
      const params = new URLSearchParams(location.search); const userId = params.get('id')?.trim();
      let urls = [];
      if(userId){ urls = await fetchImages(userId); }
      if(!urls || urls.length === 0) urls = ['https://picsum.photos/900/640?random=401','https://picsum.photos/900/640?random=402'];
      // preload and show loader progress
      await preload(urls, (p)=>{ loaderBar.textContent = 'Cargando ' + Math.round(p) + '%'; });
      removeLoader();
      buildGallery(urls);
      // start automatic surprise loop gently
      window._surpriseInterval = setInterval(()=> triggerSurprise(), 12000 + Math.floor(Math.random()*8000));
    })();

    // small helper: pause animations when modal open
    document.addEventListener('visibilitychange', ()=>{ if(document.hidden){ if(window._surpriseInterval) clearInterval(window._surpriseInterval); } else { if(!window._surpriseInterval) window._surpriseInterval = setInterval(()=> triggerSurprise(), 12000 + Math.floor(Math.random()*8000)); } });

  </script>
}]}
